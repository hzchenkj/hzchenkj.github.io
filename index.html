<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>LinuxCoffee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="hzchenkj">
  
  
  <meta name="description" content="GNU/Linux | Java | Python | Docker | Shell">
<meta property="og:type" content="website">
<meta property="og:title" content="LinuxCoffee">
<meta property="og:url" content="http://hzchenkj.github.com/">
<meta property="og:site_name" content="LinuxCoffee">
<meta property="og:description" content="GNU/Linux | Java | Python | Docker | Shell">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LinuxCoffee">
<meta name="twitter:description" content="GNU/Linux | Java | Python | Docker | Shell">

  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">LinuxCoffee</a></h1>
    <p><a href="/">东写西读</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/reading">Reading</a></li>
      
        <li><a href="/about">About</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content">




  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/01/20/Nginx-PHP/">
  <time datetime="2015-01-20T01:02:54.000Z">
    1月 20 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/01/20/Nginx-PHP/">Nginx PHP 整合</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>yum install tar unzip </p>
<p>现在流行用LNMP的组合框架了。整理了一小篇。<br>常规的做法是将数据库和Web 应用分两台进行部署。网上的文章，基本上都是在一台Linux服务器上部署Nginx + PHP + MySQL。<br>在编译PHP的时候都需要安装MySQL 的软件，然后带上—with-mysql的参数。但我们在这台服务器上根本就用不上MySQL的服务。<br>后来在PHP官网找到一个文档说明，说PHP 默认已经在某个版本后，可以实现不用MySQL 既可以编译具有MySQL连接的PHP。</p>
<p>本次使用的PHP版本是5.5.20 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">yum install -y php-mysql</div><div class="line">wget http://cn2.php.net/get/php-<span class="number">5.5</span>.<span class="number">20</span>.tar.gz/from/this/mirror</div><div class="line">tar zxvf php-<span class="number">5.5</span>.<span class="number">20</span>.tar.gz</div><div class="line"><span class="built_in">cd</span> php-<span class="number">5.5</span>.<span class="number">20</span></div><div class="line">./configure --prefix=/usr/local/php5  --enable-fpm --with-mysql</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>

<p>还额外提供了很多的编译参数，当然还需要安装一些软件依赖包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">--with-config-file-path=/usr/local/php5/etc \</div><div class="line">--enable-mbstring \</div><div class="line">--enable-ftp \</div><div class="line">--with-gd \</div><div class="line">--with-jpeg-dir=/usr \</div><div class="line">--with-png-dir=/usr \</div><div class="line">--enable-magic-quotes \ </div><div class="line">--with-mysql=/usr/local/server/mysql \</div><div class="line">--with-mysqli=/usr/local/server/mysql/bin/mysql_config \</div><div class="line">--without-pear \</div><div class="line">--with-pear \</div><div class="line">--enable-sockets \</div><div class="line">--with-ttf \</div><div class="line">--with-freetype-dir=/usr \</div><div class="line">--enable-gd-native-ttf \</div><div class="line">--with-zlib \</div><div class="line">--enable-sysvsem \</div><div class="line">--enable-exif \</div><div class="line">--enable-sysvshm \</div><div class="line">--with-libxml-dir=/usr \</div><div class="line">--with-iconv=/usr/local/libiconv \</div><div class="line">--with-iconv-dir=/usr/local \</div><div class="line">--with-xmlrpc \</div><div class="line">--enable-xml \</div><div class="line">--enable-shmop \</div><div class="line">--enable-zip \</div><div class="line">--with-mhash \</div><div class="line">--with-mcrypt \</div><div class="line">--enable-discard-path \</div><div class="line">--enable-bcmath \</div><div class="line">--enable-inline-optimization \</div><div class="line">--with-curl \</div><div class="line">--with-curlwrappers \</div><div class="line">--enable-mbregex \</div><div class="line">--with-openssl\</div><div class="line">--enable-fpm \</div><div class="line">--enable-opcache=no</div></pre></td></tr></table></figure>

<p>软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">yum install -y  gcc gcc-c++ autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel </div><div class="line"> glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel </div><div class="line">curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel </div><div class="line">yum install -y zlib zlib-devel libxml2 libxml2-devel</div></pre></td></tr></table></figure>

<p>拷贝php配置文件和php-fpm的配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cp /usr/local/src/php-<span class="number">5.5</span>.<span class="number">20</span>/php.ini-development /usr/local/php5/php.ini</div><div class="line">cp /usr/local/php5/etc/php-fpm.conf.default /usr/local/php5/etc/php-fpm.conf</div><div class="line">cp sapi/fpm/php-fpm /usr/local/bin</div></pre></td></tr></table></figure>

<p>vim /usr/local/php5/php.ini</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cgi.fix_pathinfo=<span class="number">0</span></div></pre></td></tr></table></figure>

<p>vim /usr/local/php5/etc/php-fpm.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">user = www-data</div><div class="line">group = www-data</div><div class="line">pid = run/php-fpm.pid</div><div class="line">security.limit_extensions = .php .php3 .php4 .php5 .css .js .jpg .jpeg .gif .png .html .htm</div></pre></td></tr></table></figure>

<p>然后启动 php-fpm 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/local/bin/php-fpm</div><div class="line">netstat -ant|grep <span class="number">9000</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#关闭php-fpm</span></div><div class="line">kill -INT `cat /usr/local/php5/var/run/php-fpm.pid`</div><div class="line"><span class="comment">#重启php-fpm</span></div><div class="line">kill -USR2 `cat /usr/local/php5/var/run/php-fpm.pid`</div></pre></td></tr></table></figure>

<p>安装Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">groupadd -r -g <span class="number">5000</span> nginx</div><div class="line">useradd -r -g nginx -u <span class="number">5000</span> nginx</div><div class="line">yum -y install pcre pcre-devel</div><div class="line">wget http://nginx.org/download/nginx-<span class="number">1.2</span>.<span class="number">9</span>.tar.gz</div><div class="line">tar zxvf nginx-<span class="number">1.2</span>.<span class="number">9</span>.tar.gz</div><div class="line"><span class="built_in">cd</span> nginx-<span class="number">1.2</span>.<span class="number">9</span></div><div class="line">./configure --prefix=/usr/local/nginx</div></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location ~* \.php$ {</div><div class="line">    fastcgi_index   index.php;</div><div class="line">    fastcgi_pass    <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>;</div><div class="line">    include         fastcgi_params;</div><div class="line">    fastcgi_param   SCRIPT_FILENAME    <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</div><div class="line">    fastcgi_param   SCRIPT_NAME        <span class="variable">$fastcgi_script_name</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>其他的一个版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">location ~* \.(php[<span class="number">3</span>-<span class="number">9</span>]?|phtm[l]?)(\/.*)*$ {  </div><div class="line">        fastcgi_index index.php;  </div><div class="line">        fastcgi_pass <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>;  </div><div class="line">        include fastcgi_params;  </div><div class="line">        <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="string">""</span>;  </div><div class="line">        <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$fastcgi_script_name</span>;  </div><div class="line">        <span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> ~ <span class="string">"^(.+?\.php)(/.+)$"</span>) {  </div><div class="line">                <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$1</span>;  </div><div class="line">                <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="variable">$2</span>;  </div><div class="line">        }  </div><div class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$real_script_name</span>;  </div><div class="line">        fastcgi_param SCRIPT_NAME <span class="variable">$real_script_name</span>;  </div><div class="line">        fastcgi_param PATH_INFO <span class="variable">$path_info</span>;  </div><div class="line">}  </div><div class="line">location ~* \.(php[<span class="number">3</span>-<span class="number">9</span>]?|phtm[l]?)(\/.*)*$ {  </div><div class="line">    fastcgi_index index.php;</div><div class="line">    fastcgi_pass <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>;<span class="comment">#这里指定了fastcgi进程侦听的端口,nginx就是通过这里与php交互的</span></div><div class="line">    include fastcgi_params;</div><div class="line">    <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="string">""</span>;</div><div class="line">    <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$fastcgi_script_name</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> ~ <span class="string">"^(.+?\.php)(/.+)$"</span>) {</div><div class="line">            <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$1</span>;</div><div class="line">            <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="variable">$2</span>;</div><div class="line">    }</div><div class="line">    fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$real_script_name</span>;</div><div class="line">    fastcgi_param SCRIPT_NAME <span class="variable">$real_script_name</span>;</div><div class="line">    fastcgi_param PATH_INFO <span class="variable">$path_info</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>fastcgi_param 参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=TEST:<span class="number">10</span>m inactive=<span class="number">5</span>m;      </div><div class="line">fastcgi_connect_timeout <span class="number">300</span>;      </div><div class="line">fastcgi_send_timeout <span class="number">300</span>;      </div><div class="line">fastcgi_<span class="built_in">read</span>_timeout <span class="number">300</span>;      </div><div class="line">fastcgi_buffer_size <span class="number">64</span>k;      </div><div class="line">fastcgi_buffers <span class="number">4</span> <span class="number">64</span>k;      </div><div class="line">fastcgi_busy_buffers_size <span class="number">128</span>k;      </div><div class="line">fastcgi_temp_file_write_size <span class="number">128</span>k;      </div><div class="line">fastcgi_cache TEST;      </div><div class="line">fastcgi_cache_valid <span class="number">200</span> <span class="number">302</span> <span class="number">1</span>h;      </div><div class="line">fastcgi_cache_valid <span class="number">301</span> <span class="number">1</span>d;      </div><div class="line">fastcgi_cache_valid any <span class="number">1</span>m;</div></pre></td></tr></table></figure>

<p> 下面是对上述代码的含义进行介绍。<br>第一行代码是为FastCGI缓存指定一个文件路径、目录结构等级、关键字区域存储时间和非活动删除时间。<br>fastcgi_connect_timeout：指定连接到后端FastCGI的超时时间。<br>fastcgi_send_timeout：指定向FastCGI传送请求的超时时间，这个值是已经完成两次握手后向FastCGI传送请求的超时时间。<br>fastcgi_read_timeout：指定接收FastCGI应答的超时时间，这个值是已经完成两次握手后接收FastCGI应答的超时时间。<br>fastcgi_buffer_size：用于指定读取FastCGI应答第一部分需要用多大的缓冲区，这个值表示将使用1个64KB的缓冲区读取应答的第一部分（应答头），可以设置为fastcgi_buffers选项指定的缓冲区大小。<br>fastcgi_buffers：指定本地需要用多少和多大的缓冲区来缓冲FastCGI的应答请求。如果一个PHP脚本所产生的页面大小为256KB，那么会为其分配4个64KB的缓冲区来缓存；如果页面大小大于256KB，那么大于256KB的部分会缓存到fastcgi_temp指定的路径中，但是这并不是好方法，因为内存中的数据处理速度要快于硬盘。一般这个值应该为站点中PHP脚本所产生的页面大小的中间值，如果站点大部分脚本所产生的页面大小为256KB，那么可以把这个值设置为“16 16k”、“4 64k”等。<br>fastcgi_busy_buffers_size：的默认值是fastcgi_buffers的两倍。<br>fastcgi_temp_file_write_size：表示在写入缓存文件时使用多大的数据块，默认值是fastcgi_buffers的两倍。<br>fastcgi_cache：表示开启FastCGI缓存并为其指定一个名称。开启缓存非常有用，可以有效降低CPU的负载，并且防止502错误的发生，但是开启缓存也会引起很多问题，要视具体情况而定。<br>fastcgi_cache_valid：fastcgi用来指定应答代码的缓存时间，实例中的值表示将200和302应答缓存一个小时，将301应答缓存1天，其他应答均缓存1分钟。</p>
<p>rm /usr/local/nginx/html/index.html<br>echo “&lt;?php phpinfo(); ?&gt;” &gt;&gt; /usr/local/nginx/html/index.php</p>
<p>下载最新版本的Discuz论坛</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">yum install unzip </div><div class="line">mkdir temp</div><div class="line"><span class="built_in">cd</span> temp </div><div class="line">wget  http://download.comsenz.com/DiscuzX/<span class="number">3.2</span>/Discuz_X3.<span class="number">2</span>_SC_UTF8.zip</div><div class="line">unzip Discuz_X3.<span class="number">2</span>_SC_UTF8.zip</div><div class="line">cp -r upload /data/bbs</div><div class="line">chmod -R <span class="number">777</span>  /data/bbs/config</div><div class="line">chmod -R <span class="number">777</span>  /data/bbs/data</div><div class="line">chmod -R <span class="number">777</span>  /data/bbs/uc_client</div><div class="line">chmod -R <span class="number">777</span>  /data/bbs/uc_server</div></pre></td></tr></table></figure>


    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/01/09/Flask-extensions/">
  <time datetime="2015-01-09T07:21:23.000Z">
    1月 9 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/01/09/Flask-extensions/">Flask extensions 汇总</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>Flask 的扩张结构是在诞生的时候就确定了的。存在各种各样好用的扩张。<br>这里整理了一些常用的扩张：<br>1  Flask-script<br>给flask提供命令行选项，可以在shell里进行调试，测试工作。<br>pip install flask-scripts<br>from flask.ext.script import Manager<br>manager = Manager(app)<br>manager.run()</p>
<p>python test.py —help<br>python test.py shell<br>python test.py runserver -h 0.0.0.0 -p 5000</p>
<p>2 Flask-Bootstrap<br>pip install flask-bootstrap</p>
<p>from flask.ext.bootstrap import Bootstrap</p>
<p>bootstrap = Bootstrap(app)</p>
<p>user.html</p>
<p>3 Flask-Moment 时间日期本地格式化<br>pip install flask-moment</p>
<p>from flask.ext.moment import Moment<br>moment = Moment(app)</p>
<p>index.html</p>
<p>4 Flask-WTF Form表单<br>pip  install falsk-wtf</p>
<p>Form Classes 继承自Form<br>from flask.ext.wtf import Form<br>from wtforms import StringField,SubmitField<br>from wtform.validators import Rrquired</p>
<p>class NameForm(Form):<br>    name = StringField(‘What is your name?’,validators=[Required()])<br>    submit = SubmitField(‘Submit’)</p>
<p> StringField<br> TextAreaField<br> PasswordField<br> HiddenField<br> DateField<br> DateTimeField<br> IntegerField<br> DecimalField<br> FloatField<br> BooleanField<br> RadioField<br> SelectField<br> SelectMultipleField<br> FielField<br> SubmitField<br> FormField<br> FieldList</p>
<p>5 数据库<br>pip install flask-sqlalchemy<br>MySQL mysql://username:password@hostname/database</p>
<p>2 Login<br>3 Form</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/01/06/Flask-dev-setup/">
  <time datetime="2015-01-06T03:03:17.000Z">
    1月 6 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/01/06/Flask-dev-setup/">Flask 开发环境设置</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>Python web框架 Flask开发环境设置，引入venv虚拟环境，能很好的避免各程序版本冲突。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> ~</div><div class="line">mdkir weatherapp</div><div class="line"><span class="built_in">cd</span> weatherapp</div><div class="line">mkdir templates</div><div class="line">touch index.py</div><div class="line">touch templates/index.html</div></pre></td></tr></table></figure>

<p>安装虚拟环境virtualenv,Mac OS X 下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$sudo</span> easy_install virtualenv</div><div class="line"><span class="variable">$cd</span> weatherapp</div><div class="line"><span class="variable">$virtualenv</span> venv</div><div class="line">New python executable <span class="keyword">in</span> venv/bin/python2.<span class="number">7</span></div><div class="line">lso creating executable <span class="keyword">in</span> venv/bin/python</div><div class="line">Installing setuptools............done.</div><div class="line">Installing pip...............done.</div></pre></td></tr></table></figure>

<p>应用根目录会生成一个venv目录<br>激活venv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$source</span> venv/bin/activate</div><div class="line">(venv)$</div></pre></td></tr></table></figure>

<p>在venv下安装相关的软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(venv)<span class="variable">$pip</span> install flask</div><div class="line">(venv)<span class="variable">$python</span></div><div class="line">&gt;&gt;&gt;import falsk</div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>

<p>没有错误，就说明你的flask装好了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$vim</span> index.py</div><div class="line">from flask import Flask</div><div class="line">import os</div><div class="line">app = Flask(__name__)</div><div class="line">@app.route(<span class="string">"/"</span>)</div><div class="line">def index():</div><div class="line">    <span class="keyword">return</span> <span class="string">"Hello,World!"</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    port = int(os.environ.get(<span class="string">'PORT'</span>,<span class="number">5000</span>))</div><div class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=port,debug=True)</div></pre></td></tr></table></figure>

<p>运行flaskweb服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(venv)<span class="variable">$python</span> index.py</div><div class="line"> * Running on http://<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">5000</span>/</div><div class="line"> * Restarting with reloader</div></pre></td></tr></table></figure>

<p> 浏览器输入<a href="http://localhost:5000" target="_blank" rel="external">http://localhost:5000</a> 就可以看到你的helloworld页面了。</p>
<p>所有的Flask应用程序都需要创建一个app实例。服务响应客户端请求使用WSGI（Web Server Gateway Interace）。<br>路由和视图函数:<br>路由就是用来保持URL地址和函数的关系。可以使用装饰器@app.route 来暴露路由。URL 可以有静态和动态的方式声明。<br>/user/<name> ,/user/<int:id></int:id></name></p>
<p>模板<br>from flask import render_template</p>
<p>变量：<br> 变量<br>undefined 字典<br>undefined 列表<br>undefined 带变量的列表<br> 对象的方法<br> 管道： safe ,lower,upper,title,trim,striptags</p>
<p>控制:<br>判断：</p>
<pre><code><span class="variable">Hello</span>,<span class="variable">Stranger</span><span class="exclamation_mark">!</span>
</code></pre><p> 循环</p>
<p>‘’’bash<br> macro</p>
<p>‘’’</p>
<ul><br><br></ul>

<p>支持在外部文件定义：<br>‘’’bash<br>{ macros.render_ct(comment) }<br>‘’’<br>支持将重复的内容抽象，然后include</p>
<p>支持继承：</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/09/elk/">
  <time datetime="2014-12-09T08:20:40.000Z">
    12月 9 2014
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/09/elk/">（elk）ElasticSearch-Logstash-Kibana</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>ElasticSearch 是构建在Apache Lucene之上的的搜索引擎服务，开源（Apache2协议），分布式，RESTful，实时 可扩展。安装方便，使用简单。<br>Logstash 收集工作日志数据，处理并分析，有告警功能，有很多插件inputs filters outputs<br>Kibana  支持可视化数据，过滤，查询等功能</p>
<p>三者可以独立使用，也可以一起组合提供强大的功能。<br><img src="http://hzchenkj-github-io.qiniudn.com/elk.png" alt="elk"></p>
<p>可以方便的扩展：<br><img src="http://hzchenkj-github-io.qiniudn.com/elk-cluster.png" alt="elk-cluster"></p>
<h1 id="一、ElasticSearch">一、ElasticSearch</h1>
<p>需要Java环境，现在设置好Java 环境变量。测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$java</span> -version</div><div class="line">java version <span class="string">"1.6.0_25"</span></div><div class="line">Java(TM) SE Runtime Environment (build <span class="number">1.6</span>.<span class="number">0</span>_25-b06)</div><div class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">20.0</span>-b11, mixed mode)</div></pre></td></tr></table></figure>

<p>下载elasticsearch 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$wget</span>  https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-<span class="number">1.4</span>.<span class="number">1</span>.tar.gz</div><div class="line"><span class="variable">$tar</span> zxvf elasticsearch-<span class="number">1.4</span>.<span class="number">1</span>.tar.gz</div><div class="line"><span class="variable">$cd</span> elasticsearch-<span class="number">1.4</span>.<span class="number">1</span></div><div class="line">$ ls</div><div class="line">bin  config  data  lib  LICENSE.txt  logs  NOTICE.txt  plugins  README.textile</div></pre></td></tr></table></figure>

<p>bin 启动脚本<br>config 配置文件<br>data 默认数据目录<br>plugins  插件目录</p>
<p>可以零配置上使用<br>vi config/elasticsearch.yml </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#cluster.name: elasticsearch</span></div><div class="line"><span class="comment">#node.name: "Franz Kafka"</span></div><div class="line"><span class="comment">#path.data: /path/to/data</span></div></pre></td></tr></table></figure>

<p>启动elasticsearch </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> elasticsearch-<span class="number">1.3</span>.<span class="number">2</span> && bin/elasticsearch <span class="operator">-d</span></div><div class="line">curl -X GET http://localhost:<span class="number">9200</span>/</div><div class="line">{</div><div class="line">  <span class="string">"status"</span> : <span class="number">200</span>,</div><div class="line">  <span class="string">"name"</span> : <span class="string">"Mister Fear"</span>,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</div><div class="line">  <span class="string">"version"</span> : {</div><div class="line">    <span class="string">"number"</span> : <span class="string">"1.4.1"</span>,</div><div class="line">    <span class="string">"build_hash"</span> : <span class="string">"89d3241d670db65f994242c8e8383b169779e2d4"</span>,</div><div class="line">    <span class="string">"build_timestamp"</span> : <span class="string">"2014-11-26T15:49:29Z"</span>,</div><div class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">    <span class="string">"lucene_version"</span> : <span class="string">"4.10.2"</span></div><div class="line">  },</div><div class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>安装web管理界面插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bin/plugin -i elasticsearch/marvel/latest</div></pre></td></tr></table></figure>

<p>浏览器访问<br><a href="http://localhost:9200/_plugin/marvel/" target="_blank" rel="external">http://localhost:9200/_plugin/marvel/</a></p>
<h1 id="二、Logstash">二、Logstash</h1>
<h1 id="三、Kibana">三、Kibana</h1>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/04/proxycommand/">
  <time datetime="2014-12-04T10:38:49.000Z">
    12月 4 2014
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/04/proxycommand/">通过ProxyCommand 登录远程内网的服务器</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>有些机房的服务器为了安全的问题，或者设置了堡垒机，或者有些服务器放置到了内网，对远程管理带来了不方便。<br>像一些支持分布式的程序，如监控程序Zabbix可以将内网的监控信息数据通过代理传到主控端。但远程的ssh操作的比较麻烦。<br>现发现一种ssh方式，通过ProxyCommand方式可以很好的支持该类型的操作。在内网测试有效。记录如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cat ~/.ssh/config </div><div class="line"><span class="comment">#ControlMaster auto</span></div><div class="line"><span class="comment">#ControlPath /tmp/ssh_mux_%h_%p_%r</span></div><div class="line"><span class="comment">#ControlPersist 1h</span></div><div class="line"><span class="comment">#gateways</span></div><div class="line">Host  gateway</div><div class="line">        Port <span class="number">65422</span></div><div class="line">        User winupon</div><div class="line">        Hostname <span class="number">192.168</span>.<span class="number">16.230</span></div><div class="line"><span class="comment">#servers</span></div><div class="line">Host <span class="number">192.168</span>.<span class="number">22</span>.*</div><div class="line">        Port <span class="number">65422</span></div><div class="line">        User winupon</div><div class="line">        IdentityFile		   /path/to/ssh/key.pem</div><div class="line">        ProxyCommand ssh gateway nc %h %p</div></pre></td></tr></table></figure>


<p>默认读取的时~/.ssh/config 这个文件，可以加上参数，指定不同的文件。<br>gateway 为堡垒机<br>然后192.168.22.* 类型的服务器ip都可以通过堡垒机登录。<br>先要先配置好ssh 互信，或指定key文件</p>
<p>测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssh gateway -F ~/.ssh/config</div><div class="line">ssh <span class="number">192.168</span>.<span class="number">22.11</span> -F ~/.ssh/config.test </div><div class="line">ssh <span class="number">192.168</span>.<span class="number">22.11</span> -F ~/.ssh/config.test  -vvv 开启调试模式</div></pre></td></tr></table></figure>


    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/03/Ansible-Playbooks/">
  <time datetime="2014-12-03T08:20:12.000Z">
    12月 3 2014
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/03/Ansible-Playbooks/">Ansible学习笔记&lt;二&gt; -Playbooks篇</a></h1>
  

  </header>
  
  <div class="entry">
    
      <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> _     _                   ____       __  __           </div><div class="line">| |   (_)_ __  _   ___  __/ ___|___  / _|/ _| ___  ___ </div><div class="line">| |   | | <span class="string">'_ \| | | \ \/ / |   / _ \| |_| |_ / _ \/ _ \</span></div><div class="line">| |___| | | | | |_| |&gt;  &lt;| |__| (_) |  _|  _|  __/  __/</div><div class="line">|_____|_|_| |_|\__,_/_/\_\\____\___/|_| |_|  \___|\___|</div></pre></td></tr></table></figure>

<p>Ansible，官方的解释是：Ansible is the simplest way to automate IT.<br>Ansible 是通过 Python 语言开发。当前使用 Ansible 的用户有：Evernote、EA、rackspace、NASA、Atlassian、Twitter 等。<br>Ansible 默认通过 SSH 协议管理机器。在被控机器上不需要安装任何组件，需要的Python一般的Linux服务器都已经自带了。是一种比Puppet、SaltStack等更加轻量级的自动化运维管理工具。自带的模块也极其丰富。<br>Ansible 使用一个高质量的 Python 实现的 OpenSSH 协议库 “paramiko”。 Paramiko 遵循 SSH2 协议，支持以加密和认证的方式，进行远程服务器的连接。对 paramiko 进行了更高层次的封装。<a href="http://www.paramiko.org/" target="_blank" rel="external">http://www.paramiko.org/</a><br>Ansible 使用  YAML 文件格式并使用 Jinja2 模板语言。</p>
<p>一些相关链接：<br>官方网站：<a href="http://www.ansible.com/index.html" target="_blank" rel="external">http://www.ansible.com</a><br>官方文档：<a href="http://docs.ansible.com/index.html" target="_blank" rel="external">http://docs.ansible.com/index.html</a></p>
<h2 id="四、Ansible’s_playbooks">四、Ansible’s playbooks</h2>
<p>playbooks 翻译过来就是剧本，我们只要写好剧本，就会按照剧本进行演出。只要定义好远程服务器需要达到某种状态，Ansible就会去处理。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/02/Ansible-Base/">
  <time datetime="2014-12-02T05:26:51.000Z">
    12月 2 2014
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/02/Ansible-Base/">Ansible学习笔记&lt;一&gt; -基础篇</a></h1>
  

  </header>
  
  <div class="entry">
    
      <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> _     _                   ____       __  __           </div><div class="line">| |   (_)_ __  _   ___  __/ ___|___  / _|/ _| ___  ___ </div><div class="line">| |   | | <span class="string">'_ \| | | \ \/ / |   / _ \| |_| |_ / _ \/ _ \</span></div><div class="line">| |___| | | | | |_| |&gt;  &lt;| |__| (_) |  _|  _|  __/  __/</div><div class="line">|_____|_|_| |_|\__,_/_/\_\\____\___/|_| |_|  \___|\___|</div></pre></td></tr></table></figure>

<p>Ansible，官方的解释是：Ansible is the simplest way to automate IT.<br>Ansible 是通过 Python 语言开发。当前使用 Ansible 的用户有：Evernote、EA、rackspace、NASA、Atlassian、Twitter 等。<br>Ansible 默认通过 SSH 协议管理机器。在被控机器上不需要安装任何组件，需要的Python一般的Linux服务器都已经自带了。是一种比Puppet、SaltStack等更加轻量级的自动化运维管理工具。自带的模块也极其丰富。<br>Ansible 使用一个高质量的 Python 实现的 OpenSSH 协议库 “paramiko”。 Paramiko 遵循 SSH2 协议，支持以加密和认证的方式，进行远程服务器的连接。对 paramiko 进行了更高层次的封装。<a href="http://www.paramiko.org/" target="_blank" rel="external">http://www.paramiko.org/</a><br>Ansible 使用  YAML 文件格式并使用 Jinja2 模板语言。</p>
<p>关于Configuration management (CM) 配置管理工具 Ansible — Puppet — Chef — SaltStack 的几个工具的对比，参考 <a href="https://devopsu.com/books/taste-test-puppet-chef-salt-stack-ansible.html" target="_blank" rel="external">https://devopsu.com/books/taste-test-puppet-chef-salt-stack-ansible.html</a></p>
<p>一些相关链接：<br>官方网站：<a href="http://www.ansible.com/index.html" target="_blank" rel="external">http://www.ansible.com</a><br>官方文档：<a href="http://docs.ansible.com/index.html" target="_blank" rel="external">http://docs.ansible.com/index.html</a><br>书籍：<a href="http://www.ansible.com/ansible-book" target="_blank" rel="external">http://www.ansible.com/ansible-book</a><br><img src="http://www.ansible.com/hs-fs/hub/330046/file-1963660792-jpg/DL_Folder/Ansible-Ebook.jpg" alt="ANSIBLE UP &amp; RUNNING"></p>
<h2 id="一、安装">一、安装</h2>
<p>安装也相当方便。目前已经发布了1.8 版本，但epel源中是1.7.2</p>
<h3 id="Mac">Mac</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MacBookPro:~ hzchenkj$ brew install ansible </div><div class="line">MacBookPro:~ hzchenkj$ ansible --version</div><div class="line">ansible <span class="number">1.7</span>.<span class="number">2</span></div></pre></td></tr></table></figure>


<h3 id="RedHat">RedHat</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rpm –ivh http://dl.fedoraproject.org/pub/epel/<span class="number">6</span>/x86_64/epel-release-<span class="number">6</span>-<span class="number">8</span>.noarch.rpm</div><div class="line">yum –y install ansible</div></pre></td></tr></table></figure>



<h2 id="二、使用">二、使用</h2>
<p>定义主机配置文件，默认在/etc/ansible/hosts 下面，<br>也可以使用-i 参数指定不同的路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible -i /usr/local/Cellar/ansible/<span class="number">1.7</span>.<span class="number">2</span>/ansible_hosts  webservers <span class="operator">-a</span> <span class="string">'uptime'</span> -u root -k</div></pre></td></tr></table></figure>


<p>该命令选项的作用分别为：</p>
<p>-i：指定 inventory 文件，使用当前目录下的 hosts<br>webservers ：针对 hosts 定义的所有主机执行，也可以指定组名或模式，或者all<br>-m：指定所用的模块 ，默认的模块为command<br>-a: 模块参数<br>-u：指定远端机器的用户<br>-k:参数为要求使用密码方式连接<br>-f: 并发数<br>-s: 使用sudo切换到root</p>
<p>或者设置环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> ANSIBLE_HOSTS=/usr/local/Cellar/ansible/<span class="number">1.7</span>.<span class="number">2</span>/ansible_hosts </div><div class="line">ansible  webservers <span class="operator">-a</span> <span class="string">'uptime'</span> -u root -k</div></pre></td></tr></table></figure>


<p>编辑主机配置文件，支持嵌套。也可以支持别名，定义变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/ansible/hosts</span></div><div class="line">[webservers]</div><div class="line"><span class="number">10.223</span>.<span class="number">55.100</span></div><div class="line"><span class="number">10.223</span>.<span class="number">55.101</span></div><div class="line"><span class="number">10.223</span>.<span class="number">38.226</span></div><div class="line">[linux:children]</div><div class="line">nginx</div><div class="line">tomcat</div><div class="line">[nginx]</div><div class="line"><span class="number">10.223</span>.<span class="number">38.227</span></div><div class="line">[tomcat]</div><div class="line"><span class="number">10.223</span>.<span class="number">39.216</span></div><div class="line"><span class="number">10.223</span>.<span class="number">25.123</span></div><div class="line"><span class="number">10.240</span>.<span class="number">162.11</span>[<span class="number">1</span>:<span class="number">9</span>]:<span class="number">22</span></div><div class="line">[mysql]</div><div class="line">mysql1 ansible_ssh_host=<span class="number">192.168</span>.<span class="number">22.11</span> ansible_ssh_port=<span class="number">65422</span> ansible_ssh_user=mysql </div><div class="line">mysql2 ansible_ssh_host=<span class="number">192.168</span>.<span class="number">22.12</span> ansible_ssh_port=<span class="number">65422</span> ansible_ssh_user=mysql</div><div class="line">[webservers:vars]</div><div class="line">ls-path=/bin/ls</div><div class="line">liss=lisisi</div></pre></td></tr></table></figure>



<h3 id="配置ssh信任">配置ssh信任</h3>
<p>将ansible主控机上的ssh公钥拷贝到受控机器上<br>生成ssh key 公钥和密钥对：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa</div></pre></td></tr></table></figure>


<p>传输到受控远程服务器上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat  ~/.ssh/id_rsa.pub | ssh -p <span class="number">65422</span> winupon@<span class="number">192.168</span>.<span class="number">22.11</span> <span class="string">"cat - &gt;&gt; ~/.ssh/authorized_keys"</span></div></pre></td></tr></table></figure>


<p>或者使用ssh-copy-id 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@<span class="number">192.168</span>.<span class="number">22.11</span></div></pre></td></tr></table></figure>


<p>保证远程服务器上的authorized_keys 文件的权限为600<br>远程服务器上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chmod  <span class="number">700</span>   ~/.ssh</div><div class="line">chmod  <span class="number">600</span>   ~/.ssh/authorized_keys</div></pre></td></tr></table></figure>


<p>使用ping模块进行测试所有的主机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ansible all -m ping</div><div class="line">child1.dev | success &gt;&gt; {</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></div><div class="line">}</div></pre></td></tr></table></figure>


<h2 id="三、常用模块使用">三、常用模块使用</h2>
<p>以下列举Ansible自带的常用的模块：<br>ansible-doc –l</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible &lt;pattern_goes_here&gt; -m &lt;module_name&gt; <span class="operator">-a</span> &lt;arguments&gt;</div></pre></td></tr></table></figure>


<p><em>或者all #匹配所有主机<br>salt:leihuo #匹配多个组:<br>salt:!leihuo #在salt这个组里，但不能在leihuo这个组里的主机<br>salt:&amp;leihuo #取两个组的交集<br>ansible-playbook site.yaml —limit salt-msater  排除某一主机<br>~salt(master|minion).li</em>.com 当然也可以用正则</p>
<ol>
<li>setup<br>查看远程主机的一些基本信息：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">MacBookPro:~ hzchenkj$ ansible docker -m setup|more</div><div class="line">docker12 | success &gt;&gt; {</div><div class="line">    <span class="string">"ansible_facts"</span>: {</div><div class="line">        <span class="string">"ansible_all_ipv4_addresses"</span>: [</div><div class="line">            <span class="string">"192.168.22.12"</span>, </div><div class="line">            <span class="string">"172.17.42.1"</span></div><div class="line">        ], </div><div class="line">        <span class="string">"ansible_all_ipv6_addresses"</span>: [</div><div class="line">            <span class="string">"fe80::862b:2bff:fe49:96a6"</span>, </div><div class="line">            <span class="string">"fe80::bc0c:f7ff:fea2:609c"</span>, </div><div class="line">            <span class="string">"fe80::c429:89ff:fe7c:156a"</span>, </div><div class="line">            <span class="string">"fe80::26:68ff:fe30:3f46"</span></div><div class="line">        ], </div><div class="line">        <span class="string">"ansible_architecture"</span>: <span class="string">"x86_64"</span>, </div><div class="line">        <span class="string">"ansible_bios_date"</span>: <span class="string">"05/25/2010"</span>, </div><div class="line">        <span class="string">"ansible_bios_version"</span>: <span class="string">"1.4.7"</span>, </div><div class="line">        <span class="string">"ansible_cmdline"</span>: {</div><div class="line">            <span class="string">"KEYBOARDTYPE"</span>: <span class="string">"pc"</span>, </div><div class="line">            <span class="string">"KEYTABLE"</span>: <span class="string">"us"</span>,</div></pre></td></tr></table></figure>


<p>2.ping<br>测试远程主机的运行状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">MacBookPro:~ hzchenkj$ ansible docker -m ping|more</div><div class="line">docker12 | success &gt;&gt; {</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></div><div class="line">}</div><div class="line"></div><div class="line">docker11 | success &gt;&gt; {</div><div class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </div><div class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></div><div class="line">}</div></pre></td></tr></table></figure>


<p>changed  false 是指对服务器状态不会改变<br>3.file<br>选项：<br>    force：两种情况下强制创建软链接，一是源文件不存在但之后会建立的情况下；一是目标软链接已存在,需要先取消之前软链，然后创建新软链，有两个选项：yes|no<br>    group：文件/目录属组<br>    mode：文件/目录权限<br>    owner：文件/目录属主<br>    path：必选项，文件/目录的路径<br>    recurse：递归的设置文件的属性，只对目录有效<br>    src：链接的源文件的路径，只应用于state=link<br>    dest：被链接到的路径，只应用于state=link<br>    state：<br>            directory：目录不存在，创建目录<br>            file：即使文件不存在，也不会被创建<br>            link：创建软链接<br>            hard：创建硬链接<br>            touch：文件不存在，会创建一个新文件；文件或目录已存在，则更新其最后修改时间<br>            absent：删除目录、文件或者取消链接文件<br>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ansible test -m file <span class="operator">-a</span> <span class="string">"src=/etc/fstab dest=/tmp/fstab state=link"</span></div><div class="line">ansible test -m file <span class="operator">-a</span> <span class="string">"path=/tmp/fstab state=absent"</span>  删除文件</div><div class="line">ansible test -m file <span class="operator">-a</span> <span class="string">"path=/tmp/test state=touch"</span></div></pre></td></tr></table></figure>


<p>4.copy<br>复制文件到远程主机<br>选项：<br>    backup：覆盖之前原文件备份，备份文件包含时间信息。有两个选项：yes|no<br>    content：用于替代”src”,直接设定文件的值<br>    dest：必选项。要将源文件复制到的远程主机的绝对路径，如果源文件是一个目录，那么该路径也必须是个目录<br>    directory_mode：递归的设定目录的权限，默认为系统默认权限<br>    force：如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖，如果为no，则只有当目标主机的目标位置不存在该文件时，才复制。默认为yes<br>    others：所有的file模块里的选项都可以在这里使用<br>    src：要复制到远程主机的文件在本地的地址，可以是绝对路径，也可以是相对路径。如果路径是一个目录，它将递归复制。在这种情况下，如果路径使用”/“来结尾，则只复制目录里的内容，如果没有使用”/“来结尾，则包含目录在内的整个内容全部复制，类似于rsync。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将本地文件“/etc/ansible/ansible.cfg”复制到远程服务器</span></div><div class="line">ansible test -m copy <span class="operator">-a</span> <span class="string">"src=/etc/ansible/ansible.cfg dest=/etc/foo.conf owner=foo group=foo mode=0644"</span></div><div class="line">ansible test -m copy <span class="operator">-a</span> <span class="string">"src=/mine/ntp.conf dest=/etc/ntp.conf owner=root group=root mode=644 backup=yes"</span></div></pre></td></tr></table></figure>


<p>5.command<br>在远程主机上执行命令<br>选项：<br>    creates：一个文件名，当该文件存在，则该命令不执行<br>    free_form：要执行的linux指令<br>    chdir：在执行指令之前，先切换到该指定的目录<br>    removes：一个文件名，当该文件不存在，则该选项不执行<br>    executable：切换shell来执行指令，该执行路径必须是一个绝对路径<br>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible test <span class="operator">-a</span> <span class="string">"/sbin/reboot"</span></div></pre></td></tr></table></figure>


<p>6.shell<br>切换到某个shell执行指定的指令，参数与command相同,支持管道。<br>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ansible test -m shell <span class="operator">-a</span> <span class="string">"file.sh &gt;&gt; somelog.log"</span></div><div class="line">ansible test -m shell <span class="operator">-a</span> <span class="string">"ps -ef|grep tomcat"</span></div></pre></td></tr></table></figure>


<p>7.service<br>用于管理服务<br>选项：<br>    arguments：给命令行提供一些选项<br>    enabled：是否开机启动  yes|no<br>    name：必选项，服务名称<br>    pattern：定义一个模式，如果通过status指令来查看服务的状态时，没有响应，就会通过ps指令在进程中根据该模式进行查找，如果匹配到，则认为该服务依然在运行<br>    runlevel：运行级别<br>    sleep：如果执行了restarted，在则stop和start之间沉睡几秒钟<br>    state：对当前服务执行启动，停止、重启、重新加载等操作（started,stopped,restarted,reloaded）<br>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ansible test -m service <span class="operator">-a</span> <span class="string">"name=httpd state=started enabled=yes"</span></div><div class="line">ansible test -m service <span class="operator">-a</span> <span class="string">"name=foo pattern=/usr/bin/foo state=started"</span></div><div class="line">ansible test -m service <span class="operator">-a</span> <span class="string">"name=network state=restarted args=eth0"</span></div></pre></td></tr></table></figure>


<p>8.cron<br>用于管理计划任务<br>选项：<br>    backup：对远程主机上的原任务计划内容修改之前做备份<br>    cron_file：如果指定该选项，则用该文件替换远程主机上的cron.d目录下的用户的任务计划<br>    day：日（1-31，<em>，</em>/2,……）<br>    hour：小时（0-23，<em>，</em>/2，……）<br>    minute：分钟（0-59，<em>，</em>/2，……）<br>    month：月（1-12，<em>，</em>/2，……）<br>    weekday：周（0-7，*，……）<br>    job：要执行的任务，依赖于state=present<br>    name：该任务的描述<br>    special_time：指定什么时候执行，参数：reboot,yearly,annually,monthly,weekly,daily,hourly<br>    state：确认该任务计划是创建还是删除<br>    user：以哪个用户的身份执行<br>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ansible test -m cron <span class="operator">-a</span> <span class="string">'name="check dirs" hour="5,2" job="ls -alh &gt; /dev/null"'</span></div><div class="line">ansible test -m cron <span class="operator">-a</span> <span class="string">'name="a job for reboot" special_time=reboot job="/some/job.sh"'</span></div><div class="line">ansible test -m cron <span class="operator">-a</span> <span class="string">'name="yum autoupdate" weekday="2" minute=0 hour=12 user="root" job="YUMINTERACTIVE=0 /usr/sbin/yum-autoupdate" cron_file=ansible_yum-autoupdate'</span></div><div class="line">ansilbe test -m cron <span class="operator">-a</span> <span class="string">'cron_file=ansible_yum-autoupdate state=absent'</span></div></pre></td></tr></table></figure>



<p>9.yum<br>使用yum包管理器来管理软件包<br>选项：<br>    config_file：yum的配置文件<br>    disable_gpg_check：关闭gpg_check<br>    disablerepo：不启用某个源<br>    enablerepo：启用某个源<br>    list<br>    name：要进行操作的软件包的名字，也可以传递一个url或者一个本地的rpm包的路径<br>    state：状态（present，absent，latest）<br>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ansible test -m yum <span class="operator">-a</span> <span class="string">'name=httpd state=latest'</span></div><div class="line">ansible test -m yum <span class="operator">-a</span> <span class="string">'name="@Development tools" state=present'</span></div><div class="line">ansible test -m yum <span class="operator">-a</span> <span class="string">'name=http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm state=present'</span></div></pre></td></tr></table></figure>


<p>10.user<br>管理用户<br>    home:<br>    groups:<br>    uid<br>    password:<br>    name:<br>    createhome:<br>    system:<br>    remove:<br>    state:<br>    shell:<br>    需要特别说明的是，password后面指定的密码不能是明文，后面这一串密码会被直接传送到被管理主机的/etc/shadow文件中，而登陆的时候输入的密码会被hash加密以后再去与/etc/shadow中存放的密码去做对比，会出现不一致的现象。所以需要先将密码字符串进行加密处理：openssl passwd -salt -1 “123456”，然后将得到的字符串放到password中即可。</p>
<p>11.mount<br>配置挂载点<br>选项：<br>    dump<br>    fstype：必选项，挂载文件的类型<br>    name：必选项，挂载点<br>    opts：传递给mount命令的参数<br>    passno<br>    src：必选项，要挂载的文件<br>    state：必选项<br>            present：只处理fstab中的配置<br>            absent：删除挂载点<br>            mounted：自动创建挂载点并挂载之<br>            umounted：卸载<br>示例：<br>    name=/mnt/dvd src=/dev/sr0 fstype=iso9660 opts=ro state=present<br>    name=/srv/disk src=’LABEL=SOME_LABEL’ state=present<br>    name=/home src=’UUID=b3e48f45-f933-4c8e-a700-22a159ec9077’ opts=noatime state=present</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ansible test <span class="operator">-a</span> <span class="string">'dd if=/dev/zero of=/disk.img bs=4k count=1024'</span></div><div class="line">ansible test <span class="operator">-a</span> <span class="string">'losetup /dev/loop0 /disk.img'</span></div><div class="line">ansible test -m filesystem <span class="string">'fstype=ext4 force=yes opts=-F dev=/dev/loop0'</span></div><div class="line">ansible test -m mount <span class="string">'name=/mnt src=/dev/loop0 fstype=ext4 state=mounted opts=rw'</span></div></pre></td></tr></table></figure>


<p>12.raw<br>类似command，但可以传递管道,没装python，或者python-simplejson的情况可以使用raw，但官方还是推荐使用command </p>
<h2 id="四、Ansible’s_playbooks">四、Ansible’s playbooks</h2>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/11/14/Docker-In-Action-docker-tomcat-war/">
  <time datetime="2014-11-14T07:14:05.000Z">
    11月 14 2014
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/11/14/Docker-In-Action-docker-tomcat-war/">Docker-In-Action-&lt;四&gt; 运行tomcat 加载war包 mysql 方式运行容器</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>再整理一篇学习docker的笔记，使用ubuntu来作base image，然后用—volumes-from 将war包挂在到tomcat容器运行.<br>需要两个容器：<br>1 获取URL中指定的war文件并存储到volume<br>2 一个运行tomcat服务并加载war包得容器</p>
<h2 id="war容器">war容器</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cd</span> docker</div><div class="line"><span class="variable">$mkdir</span> war</div><div class="line"><span class="variable">$cd</span> war </div><div class="line"><span class="variable">$touch</span> Dockerfile</div></pre></td></tr></table></figure>

<p>Dockerfile 文件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">FROM ubuntu:<span class="number">14.04</span></div><div class="line">MAINTAINER hzchenkj &lt;hzchenkj@gmail.com&gt;</div><div class="line">ENV REFRESHED_AT <span class="number">2014</span>-<span class="number">11</span>-<span class="number">01</span></div><div class="line">RUN apt-get -yqq update</div><div class="line">RUN apt-get -yqq install wget</div><div class="line">VOLUME [ <span class="string">"/var/lib/tomcat7/webapps/"</span> ]</div><div class="line">WORKDIR /var/lib/tomcat7/webapps/</div><div class="line">ENTRYPOINT [ <span class="string">"wget"</span> ]</div><div class="line">CMD [ <span class="string">"-?"</span> ]</div></pre></td></tr></table></figure>

<p>在ubuntu镜像基础上，安装wget软件，使用/var/lib/tomcat7/webapps/ 挂在volume并指定为工作目录，便于后面wget命令下载war包。<br>使用ENTRYPOINT和CMD命令组合方式，提供了默认不带参数运行docker run，会提示怎么使用wget命令，使用指定url参数运行wget下载。<br>构建镜像并运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker build -t hzchenkj/war .</div><div class="line">docker run -t -i --name sample hzchenkj/war https://tomcat.apache.org/tomcat-<span class="number">7.0</span>-doc/appdev/sample/sample.war</div></pre></td></tr></table></figure>


<p>下载sample war包，放到/var/lib/tomcat7/webapps/，在host主机路径/var/lib/docker/vfs/dir/能查到对于的war包：</p>
<h2 id="tomcat容器">tomcat容器</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ mkdir tomcat7</div><div class="line">$ <span class="built_in">cd</span> tomcat7</div><div class="line">$ touch Dockerfile</div></pre></td></tr></table></figure>


<p>Dockerfile文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">FROM ubuntu:<span class="number">14.04</span></div><div class="line">MAINTAINER hzchenkj &lt;hzchenkj@<span class="number">163</span>.com&gt;</div><div class="line">ENV REFRESHED_AT <span class="number">2014</span>-<span class="number">11</span>-<span class="number">01</span></div><div class="line">RUN apt-get -yqq update</div><div class="line">RUN apt-get -yqq install tomcat7 default-jdk</div><div class="line">ENV CATALINA_HOME /usr/share/tomcat7</div><div class="line">ENV CATALINA_BASE /var/lib/tomcat7</div><div class="line">ENV CATALINA_PID /var/run/tomcat7.pid</div><div class="line">ENV CATALINA_SH /usr/share/tomcat7/bin/catalina.sh </div><div class="line">ENV CATALINA_TMPDIR /tmp/tomcat7-tomcat7-tmp</div><div class="line">RUN mkdir -p <span class="variable">$CATALINA_TMPDIR</span></div><div class="line">VOLUME [ <span class="string">"/var/lib/tomcat7/webapps/"</span> ]</div><div class="line">EXPOSE <span class="number">8080</span></div><div class="line">ENTRYPOINT [ <span class="string">"/usr/share/tomcat7/bin/catalina.sh"</span>, <span class="string">"run"</span> ]</div></pre></td></tr></table></figure>



<p>安装jdk和tomcat，设置启动需要的环境变量，端口，最后一个启动命令，运行tomcat到前台。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker build -t hzchenkj/tomcat7 .</div></pre></td></tr></table></figure>



<h2 id="运行应用程序">运行应用程序</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker run --name sample_app --volumes-from sample  <span class="operator">-d</span> -P hzchenkj/tomcat7</div><div class="line">docker port sample_app <span class="number">8080</span></div><div class="line">curl http://localhost:&lt;port&gt;</div></pre></td></tr></table></figure>



<p>还可以通过link方式将数据库容器关联，来持久化数据到数据库容器</p>
<h2 id="mysql_容器和数据容器">mysql 容器和数据容器</h2>
<p>启动一个Volume_Data容器，将主机的/opt/data映射到容器的/data目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -v /opt/data/:/data/ --name Volume_Data ubuntu:<span class="number">14.04</span></div></pre></td></tr></table></figure>


<p>启动mysql容器，使用前面创建的数据容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run <span class="operator">-d</span> -P -h mysqlhost --volumes-from Volume_Data --name mysql hzchenkj/mysql</div></pre></td></tr></table></figure>


<p>启动tomcat容器，关联mysql容器，程序需要修改mysql数据库连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run <span class="operator">-d</span> -h tomcat7host --name tomcat7  --link mysql:db hzchenkj/tomcat7</div></pre></td></tr></table></figure>


<p>会在tomcat容器的hosts文件中增加 “172.14.<em>.</em> db” 和相应的环境变量，来关联mysql容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -rm --volumes-from Volume_Data -v $(<span class="built_in">pwd</span>):/backup busybox tar cvf /backup/backup.tar /data</div></pre></td></tr></table></figure>


<p>备份mysql的数据容器</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/10/31/Docker-In-Action-docker-oracle/">
  <time datetime="2014-10-31T01:30:08.000Z">
    10月 31 2014
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/10/31/Docker-In-Action-docker-oracle/">Docker In Action&lt;三&gt; 制作可以Oracle的docker容器服务指北</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>本篇记录一步一步从docker 镜像centos65-ssh 开始构建Oracle服务的过程。由于一般的Oracle安装需要图形界面，安装比较复杂，所以本初采用Oracle提供的另外一种安装方式静默安装来构建。</p>
<p><img src="http://hzchenkj-github-io.qiniudn.com/oracle-java.jpg" alt="Oracle"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mkdir ~/docker/oracle</div><div class="line">touch ~/docker/oracle/Dockerfile</div><div class="line"><span class="built_in">cd</span> /usr/local/src</div><div class="line"><span class="comment">#下载Oracle database安装介质</span></div><div class="line">wget <span class="number">10201</span>_database_linux_x86_64.cpio.gz</div><div class="line"><span class="comment">#解压缩，生成database目录</span></div><div class="line">zcat <span class="number">10201</span>_database_linux_x86_64.cpio.gz |cpio -idmv</div><div class="line"><span class="comment">#删除</span></div><div class="line">rm -rf <span class="number">10201</span>_database_linux_x86_64.cpio.gz</div></pre></td></tr></table></figure>

<p>Dockerfile</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#prepare install oracle env</span></div><div class="line">FROM centos65-ssh</div><div class="line"><span class="comment">##create Oracle group and user</span></div><div class="line">RUN groupadd -g <span class="number">505</span> oinstall && groupadd -g <span class="number">506</span> dba  && useradd -u <span class="number">505</span> -m -g oinstall -G dba oracle && id oracle</div><div class="line"><span class="comment">##config profile</span></div><div class="line">ENV ORACLE_APP /u01/app/oracle</div><div class="line">ENV ORACLE_DATA /u02/oradata</div><div class="line">ENV ORACLE_HOME <span class="variable">$ORACLE_APP</span>/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1</div><div class="line">ENV INSTALL_HOME /usr/local/src</div><div class="line">ADD install.sh  <span class="variable">$INSTALL_HOME</span>/install.sh</div><div class="line">ADD createdb.sh <span class="variable">$INSTALL_HOME</span>/createdb.sh</div><div class="line">ADD initcenter.ora <span class="variable">$INSTALL_HOME</span>/initcenter.ora</div><div class="line">ADD oracle /etc/init.d/oracle</div><div class="line">ADD supervisord.conf /etc/supervisord.conf</div><div class="line">EXPOSE <span class="number">1521</span></div></pre></td></tr></table></figure>

<p>install.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/bash</span></div><div class="line"><span class="comment">#compat-gcc-*  compat-gcc-*-c++  compat-libstdc++-* libXt.i686 libXtst.i686  libXtst libgcc pdksh</span></div><div class="line"><span class="keyword">for</span> PACKAGE <span class="keyword">in</span> glibc glibc-common glibc-devel libstdc++ libstdc++-devel \</div><div class="line">    binutils compat-db compat-libstdc++-<span class="number">296</span>  \</div><div class="line">    gcc gcc-c++ make openmotif setarch sysstat libaio libXp libXp.i686;</div><div class="line"><span class="keyword">do</span></div><div class="line">    yum -y install <span class="variable">$PACKAGE</span></div><div class="line">    yum clean packages</div><div class="line"><span class="keyword">done</span></div><div class="line">yum clean all</div><div class="line">mkdir -p <span class="variable">$ORACLE_APP</span> <span class="variable">$ORACLE_DATA</span> && chown -R oracle:oinstall <span class="variable">$ORACLE_APP</span> <span class="variable">$ORACLE_DATA</span> && chmod -R <span class="number">775</span> <span class="variable">$ORACLE_APP</span> <span class="variable">$ORACLE_DATA</span></div><div class="line"><span class="comment">##config  Linux kernel</span></div><div class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF</div><div class="line"><span class="comment">#use for oracle</span></div><div class="line">kernel.shmall = <span class="number">2097152</span></div><div class="line">kernel.shmmax = <span class="number">20147483648</span></div><div class="line">kernel.shmmni = <span class="number">4096</span></div><div class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></div><div class="line"><span class="comment">#fs.file-max = 65536</span></div><div class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></div><div class="line">net.core.rmem_default=<span class="number">1048576</span></div><div class="line">net.core.rmem_max=<span class="number">1048576</span></div><div class="line">net.core.wmem_default=<span class="number">262144</span></div><div class="line">net.core.wmem_max=<span class="number">262144</span></div><div class="line">EOF</div><div class="line">/sbin/sysctl -p</div><div class="line"><span class="comment">#config oracle user limit</span></div><div class="line">cat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF</div><div class="line"><span class="comment">#use for oracle</span></div><div class="line">oracle soft nproc <span class="number">2047</span></div><div class="line">oracle hard nproc <span class="number">16384</span></div><div class="line">oracle soft nofile <span class="number">4096</span></div><div class="line">oracle hard nofile <span class="number">65536</span></div><div class="line">EOF</div><div class="line"><span class="comment">#oralce limits login</span></div><div class="line">cat &gt;&gt; /etc/pam.d/login &lt;&lt;EOF</div><div class="line"><span class="comment">#session required /lib64/security/pam_limits.so</span></div><div class="line">EOF</div><div class="line"><span class="comment">#oracle profile</span></div><div class="line">cat &gt;&gt; /etc/profile &lt;&lt;EOF</div><div class="line"><span class="keyword">if</span> [ \<span class="variable">$USER</span> = <span class="string">"oracle"</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="keyword">if</span> [ \<span class="variable">$SHELL</span> = <span class="string">"/bin/ksh"</span> ]; <span class="keyword">then</span></div><div class="line">        ulimit -p <span class="number">16384</span></div><div class="line">        ulimit -n <span class="number">65536</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        ulimit -u <span class="number">16384</span> -n <span class="number">65536</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">    umask <span class="number">022</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">EOF</div><div class="line"><span class="comment">#oracle login</span></div><div class="line">cat &gt;&gt; /etc/csh.login &lt;&lt;EOF</div><div class="line"><span class="keyword">if</span> ( \<span class="variable">$USER</span> == <span class="string">"oracle"</span> ) <span class="keyword">then</span></div><div class="line">    limit maxproc <span class="number">16384</span></div><div class="line">    limit descriptors <span class="number">65536</span></div><div class="line">    umask <span class="number">022</span></div><div class="line">endif</div><div class="line">EOF</div><div class="line"><span class="comment">##oracle profile</span></div><div class="line">cat &gt;&gt; /home/oracle/.bash_profile &lt;&lt;EOF</div><div class="line"><span class="keyword">export</span> ORACLE_BASE=<span class="variable">$ORACLE_APP</span></div><div class="line"><span class="keyword">export</span> ORACLE_HOME=\<span class="variable">$ORACLE_BASE</span>/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1</div><div class="line"><span class="keyword">export</span> ORACLE_SID=center</div><div class="line"><span class="keyword">export</span> PATH=\<span class="variable">$PATH</span>:\<span class="variable">$ORACLE_HOME</span>/bin:\<span class="variable">$HOME</span>/bin</div><div class="line"><span class="keyword">export</span> LD_LIBRARY_PATH=\<span class="variable">$LD_LIBRARY_PATH</span>:\<span class="variable">$ORACLE_HOME</span>/lib:/usr/lib:/usr/local/lib</div><div class="line"><span class="keyword">export</span> NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</div><div class="line">EOF</div><div class="line">cp /etc/redhat-release /etc/redhat-release.orig && <span class="built_in">echo</span> <span class="string">"redhat-4"</span> &gt; /etc/redhat-release</div><div class="line"><span class="comment">## oracle silent install</span></div><div class="line">su - oracle -c <span class="string">"<span class="variable">$INSTALL_HOME</span>/database/runInstaller -silent -responseFile <span class="variable">$INSTALL_HOME</span>/database/response/enterprise.rsp \</span></div><div class="line">UNIX_GROUP_NAME="oinstall<span class="string">" ORACLE_HOME="</span>/u01/app/oracle/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1<span class="string">" \</span></div><div class="line">ORACLE_HOME_NAME="OraDb10g_home1<span class="string">" s_nameForDBAGrp="</span>dba<span class="string">" s_nameForOPERGrp="</span>dba<span class="string">" n_configurationOption=3 "</span></div><div class="line"><span class="comment">#restore release </span></div><div class="line">rm /etc/redhat-release</div><div class="line">cp /etc/redhat-release.orig /etc/redhat-release</div><div class="line"><span class="built_in">echo</span> <span class="string">"##########################################"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'success install oracle software'</span></div></pre></td></tr></table></figure>



<p>initcenter.ora</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">*.compatible=<span class="string">'10.2.0.1.0'</span></div><div class="line">*G._kgl_large_heap_warning_threshold=<span class="number">83886080</span></div><div class="line">*.audit_file_dest=<span class="string">'/u02/oradata/admin/center/adump'</span></div><div class="line">*.background_dump_dest=<span class="string">'/u02/oradata/admin/center/bdump'</span></div><div class="line">*.control_files=<span class="string">'/u02/oradata/center/control01.ctl'</span>,<span class="string">'/u02/oradata/center/control02.ctl'</span></div><div class="line">*.core_dump_dest=<span class="string">'/u02/oradata/admin/center/cdump'</span></div><div class="line">*.user_dump_dest=<span class="string">'/u02/oradata/admin/center/udump'</span></div><div class="line">*.db_2k_cache_size=<span class="number">33554432</span></div><div class="line">*.db_block_size=<span class="number">8192</span></div><div class="line">*.db_domain=<span class="string">''</span></div><div class="line">*.db_file_multiblock_<span class="built_in">read</span>_count=<span class="number">128</span></div><div class="line">*.db_files=<span class="number">4000</span></div><div class="line">*.db_name=<span class="string">'center'</span></div><div class="line">*.db_recovery_file_dest_size=<span class="number">4294967296</span></div><div class="line">*.db_recovery_file_dest=<span class="string">''</span></div><div class="line">*.log_archive_dest=<span class="string">'/u02/oradata/center/archive'</span></div><div class="line">*.log_checkpoints_to_alert=FALSE</div><div class="line">*.open_cursors=<span class="number">1000</span></div><div class="line">*.parallel_execution_message_size=<span class="number">65535</span></div><div class="line">*.parallel_max_servers=<span class="number">128</span></div><div class="line">*.pga_aggregate_target=<span class="number">209715200</span></div><div class="line">*.processes=<span class="number">1000</span></div><div class="line">*.recyclebin=<span class="string">'ON'</span></div><div class="line">*.remote_login_passwordfile=<span class="string">'EXCLUSIVE'</span></div><div class="line">*.replication_dependency_tracking=FALSE</div><div class="line">*.session_cached_cursors=<span class="number">100</span></div><div class="line">*.sga_target=<span class="number">2048</span>m</div><div class="line">*.undo_management=<span class="string">'AUTO'</span></div><div class="line">*.undo_retention=<span class="number">0</span></div><div class="line">*.undo_tablespace=<span class="string">'UNDOTS'</span></div><div class="line">*.workarea_size_policy=<span class="string">'AUTO'</span></div><div class="line">_allow_resetlogs_corruption=<span class="literal">true</span></div><div class="line">*.job_queue_processes=<span class="number">10</span></div></pre></td></tr></table></figure>



<p>createdb.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># create oracle db </span></div><div class="line">chown -R oracle:oinstall /u02</div><div class="line">su - oracle -c <span class="string">'mkdir -p /u01/app/oracle/product/10.2.0/db_1/dbs'</span></div><div class="line">su - oracle -c <span class="string">'mkdir -p /u02/oradata/admin/center/adump'</span></div><div class="line">su - oracle -c <span class="string">'mkdir -p /u02/oradata/admin/center/bdump'</span></div><div class="line">su - oracle -c <span class="string">'mkdir -p /u02/oradata/admin/center/cdump'</span></div><div class="line">su - oracle -c <span class="string">'mkdir -p /u02/oradata/admin/center/pfile'</span></div><div class="line">su - oracle -c <span class="string">'mkdir -p /u02/oradata/admin/center/udump'</span></div><div class="line">su - oracle -c <span class="string">'mkdir -p /u02/oradata/center'</span></div><div class="line">su - oracle -c <span class="string">'mkdir -p /u02/oradata/center/archive'</span></div><div class="line"><span class="comment">#cp initcenter.ora </span></div><div class="line">cp <span class="variable">$INSTALL_HOME</span>/initcenter.ora /u02/oradata/admin/center/pfile</div><div class="line">cp <span class="variable">$INSTALL_HOME</span>/initcenter.ora /u01/app/oracle/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1/dbs</div><div class="line">chown oracle:oinstall /u02/oradata/admin/center/pfile/initcenter.ora</div><div class="line">chmod a+x /u02/oradata/admin/center/pfile/initcenter.ora</div><div class="line">chown oracle:oinstall /u01/app/oracle/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1/dbs/initcenter.ora</div><div class="line">chmod a+x /u01/app/oracle/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1/dbs/initcenter.ora</div><div class="line"><span class="built_in">echo</span> <span class="string">'success cp file ,begin to sqlplus ...'</span></div><div class="line"><span class="comment">#config sys</span></div><div class="line"><span class="built_in">echo</span> <span class="number">506</span> &gt; /proc/sys/vm/hugetlb_shm_group</div><div class="line"><span class="comment">#sqlplus start centerinstatnce</span></div><div class="line">su - oracle -c <span class="string">'sqlplus / as sysdba'</span> &lt;&lt; EOF</div><div class="line">startup nomount pfile=/u02/oradata/admin/center/pfile/initcenter.ora</div><div class="line">EOF</div><div class="line"><span class="built_in">echo</span> <span class="string">'sucecess startup database in nomount state'</span></div><div class="line"><span class="comment">#sqlplus database</span></div><div class="line">su - oracle -c <span class="string">'sqlplus / as sysdba'</span> &lt;&lt; EOF</div><div class="line">CREATE DATABASE center</div><div class="line">LOGFILE</div><div class="line">GROUP <span class="number">1</span> (<span class="string">'/u02/oradata/center/redo01.log'</span>,<span class="string">'/u02/oradata/center/redo01_1.log'</span>) size <span class="number">50</span>m reuse,</div><div class="line">GROUP <span class="number">2</span> (<span class="string">'/u02/oradata/center/redo02.log'</span>,<span class="string">'/u02/oradata/center/redo02_1.log'</span>) size <span class="number">50</span>m reuse,</div><div class="line">GROUP <span class="number">3</span> (<span class="string">'/u02/oradata/center/redo03.log'</span>,<span class="string">'/u02/oradata/center/redo03_1.log'</span>) size <span class="number">50</span>m reuse</div><div class="line">MAXLOGFILES <span class="number">50</span></div><div class="line">MAXLOGMEMBERS <span class="number">5</span></div><div class="line">MAXLOGHISTORY <span class="number">200</span></div><div class="line">MAXDATAFILES <span class="number">50</span></div><div class="line">MAXINSTANCES <span class="number">5</span></div><div class="line">CHARACTER SET ZHS16GBK</div><div class="line">NATIONAL CHARACTER SET AL16UTF16</div><div class="line">DATAFILE <span class="string">'/u02/oradata/center/system01.dbf'</span> SIZE <span class="number">200</span>M autoextend on next <span class="number">10</span>M maxsize <span class="number">1024</span>M</div><div class="line">SYSAUX DATAFILE <span class="string">'/u02/oradata/center/sysaux01.dbf'</span> SIZE <span class="number">200</span>M autoextend on next <span class="number">10</span>M maxsize <span class="number">1024</span>M</div><div class="line">UNDO TABLESPACE UNDOTS DATAFILE <span class="string">'/u02/oradata/center/undo.dbf'</span> SIZE <span class="number">200</span>M autoextend on next <span class="number">10</span>M maxsize <span class="number">1024</span>M </div><div class="line">DEFAULT TEMPORARY TABLESPACE TEMP TEMPFILE <span class="string">'/u02/oradata/center/temp.dbf'</span> SIZE <span class="number">200</span>M autoextend on next <span class="number">10</span>M maxsize <span class="number">1024</span>M;</div><div class="line">@/u01/app/oracle/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1/rdbms/admin/catalog.sql</div><div class="line">@/u01/app/oracle/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1/rdbms/admin/catproc.sql</div><div class="line">conn system/manager</div><div class="line">@/u01/app/oracle/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1/sqlplus/admin/pupbld.sql</div><div class="line">EOF</div><div class="line"><span class="built_in">echo</span> <span class="string">"center:/u01/app/oracle/product/10.2.0/db_1/:Y"</span> &gt;&gt; /etc/oratab</div><div class="line">chmod +x /etc/init.d/oracle</div><div class="line"><span class="comment">#open database archive</span></div><div class="line">su - oracle -c <span class="string">'sqlplus / as sysdba'</span> &lt;&lt; EOF</div><div class="line">shutdown immediate;</div><div class="line">startup mount;    </div><div class="line">alter database archivelog; </div><div class="line">alter database open;   </div><div class="line">archive log list;   </div><div class="line">EOF</div></pre></td></tr></table></figure>


<p>Oracle 服务自启动文件/etc/init.d/oracle</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/bash  </span></div><div class="line"><span class="comment">#  </span></div><div class="line"><span class="comment"># /etc/init.d/oracle  </span></div><div class="line"><span class="comment">#  </span></div><div class="line"><span class="comment"># chkconfig: 2345 02 98  </span></div><div class="line"><span class="comment"># description: oracle is meant to run under Linux Oracle Server  </span></div><div class="line"><span class="comment"># Source function library.  </span></div><div class="line">. /etc/rc.d/init.d/functions  </div><div class="line">ORACLE_HOME=/u01/app/oracle/product/<span class="number">10.2</span>.<span class="number">0</span>/db_1</div><div class="line">ORACLE_SID=center</div><div class="line">ORACLE_NAME=oracle </div><div class="line">LOCKFILE=<span class="string">"<span class="variable">$ORACLE_HOME</span>/.oracle.lock"</span> </div><div class="line">RESTART_RETRIES=<span class="number">3</span> </div><div class="line">DB_PROCNAMES=<span class="string">"pmon"</span> </div><div class="line">LSNR_PROCNAME=<span class="string">"tnslsnr"</span> </div><div class="line"><span class="comment">#RETVAL=0 </span></div><div class="line"><span class="comment">#Start the oracle Server  </span></div><div class="line"><span class="comment">#The following command assumes that the oracle login will not prompt the password  </span></div><div class="line"><span class="function"><span class="title">start</span></span>() {  </div><div class="line">        <span class="built_in">echo</span>  <span class="string">"Starting Oracle10g Server... "</span>  </div><div class="line">        tmpfile=/home/oracle/`basename <span class="variable">$0</span>`-start.$$  </div><div class="line">        logfile=/home/oracle/`basename <span class="variable">$0</span>`-start.log  </div><div class="line">        <span class="comment">#  </span></div><div class="line">        <span class="comment"># Set up our sqlplus script.  Basically, we're trying to   </span></div><div class="line">        <span class="comment"># capture output in the hopes that it's useful in the case  </span></div><div class="line">        <span class="comment"># that something doesn't work properly.  </span></div><div class="line">        <span class="comment">#  </span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"startup"</span> &gt; <span class="variable">$tmpfile</span>  </div><div class="line">        <span class="built_in">echo</span> <span class="string">"quit"</span> &gt;&gt; <span class="variable">$tmpfile</span>  </div><div class="line">        su - <span class="variable">$ORACLE_NAME</span> -c <span class="string">"sqlplus \"/ as sysdba\" &lt; <span class="variable">$tmpfile</span> &&gt; <span class="variable">$logfile</span>"</span>  </div><div class="line">        <span class="keyword">if</span> [ $? <span class="operator">-ne</span> <span class="number">0</span> ]; <span class="keyword">then</span>  </div><div class="line">                <span class="built_in">echo</span> <span class="string">"ORACLE_HOME Incorrectly set?"</span>  </div><div class="line">                <span class="built_in">echo</span> <span class="string">"See <span class="variable">$logfile</span> for more information."</span>  </div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="comment">#   </span></div><div class="line">        <span class="comment"># If we see:  </span></div><div class="line">        <span class="comment"># ORA-.....: failure, we failed  </span></div><div class="line">        <span class="comment">#  </span></div><div class="line">        rm <span class="operator">-f</span> <span class="variable">$tmpfile</span>  </div><div class="line">        grep -q <span class="string">"failure"</span> <span class="variable">$logfile</span>  </div><div class="line">        <span class="keyword">if</span> [ $? <span class="operator">-eq</span> <span class="number">0</span> ]; <span class="keyword">then</span>  </div><div class="line">                rm <span class="operator">-f</span> <span class="variable">$tmpfile</span>  </div><div class="line">                <span class="built_in">echo</span> <span class="string">"ORACLE_SID Incorrectly set?"</span>  </div><div class="line">                <span class="built_in">echo</span> <span class="string">"See <span class="variable">$logfile</span> for more information."</span>  </div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">         <span class="built_in">echo</span> <span class="string">"Starting listern..."</span>  </div><div class="line">         ((su - <span class="variable">$ORACLE_NAME</span> -c <span class="string">"<span class="variable">$ORACLE_HOME</span>/bin/lsnrctl start"</span>) &gt;&gt; <span class="variable">$logfile</span> <span class="number">2</span>&gt;&<span class="number">1</span>) || <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">         <span class="comment">#return $?  </span></div><div class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$LOCKFILE</span>"</span> ]; <span class="keyword">then</span>  </div><div class="line">                touch <span class="variable">$LOCKFILE</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>  </div><div class="line">}  </div><div class="line"><span class="function"><span class="title">stop</span></span>() {  </div><div class="line">        <span class="built_in">echo</span> <span class="string">"Shutting down Oracle10g Server..."</span>  </div><div class="line">        <span class="keyword">declare</span> tmpfile  </div><div class="line">        <span class="keyword">declare</span> logfile  </div><div class="line">        tmpfile=/home/oracle/`basename <span class="variable">$0</span>`-stop.$$  </div><div class="line">        logfile=/home/oracle/`basename <span class="variable">$0</span>`-stop.log  </div><div class="line">        <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$LOCKFILE</span>"</span> ] || [ <span class="operator">-f</span> <span class="variable">$LOCKFILE</span> ]; <span class="keyword">then</span>  </div><div class="line">          <span class="built_in">echo</span>  </div><div class="line">         <span class="keyword">else</span>  </div><div class="line">          <span class="built_in">echo</span> <span class="string">"oracle is not run"</span>  </div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="comment"># Setup for Stop ...  </span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"shutdown abort"</span> &gt; <span class="variable">$tmpfile</span>  </div><div class="line">        <span class="built_in">echo</span> <span class="string">"quit"</span> &gt;&gt; <span class="variable">$tmpfile</span>  </div><div class="line">        su - <span class="variable">$ORACLE_NAME</span> -c <span class="string">"sqlplus \"/ as sysdba\" &lt; <span class="variable">$tmpfile</span> &&gt; <span class="variable">$logfile</span>"</span>  </div><div class="line">        <span class="keyword">if</span> [ $? <span class="operator">-ne</span> <span class="number">0</span> ]; <span class="keyword">then</span>  </div><div class="line">                <span class="built_in">echo</span> <span class="string">"ORACLE_HOME Incorrectly set?"</span>  </div><div class="line">                <span class="built_in">echo</span> <span class="string">"See <span class="variable">$logfile</span> for more information."</span>  </div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="comment">#   </span></div><div class="line">        <span class="comment"># If we see 'failure' in the log, we're done.  </span></div><div class="line">        <span class="comment">#  </span></div><div class="line">        rm <span class="operator">-f</span> <span class="variable">$tmpfile</span>  </div><div class="line">        grep -q failure <span class="variable">$logfile</span>  </div><div class="line">        <span class="keyword">if</span> [ $? <span class="operator">-eq</span> <span class="number">0</span> ]; <span class="keyword">then</span>  </div><div class="line">                <span class="built_in">echo</span>  </div><div class="line">                <span class="built_in">echo</span> <span class="string">"Possible reason: ORACLE_SID Incorrectly set."</span>  </div><div class="line">                <span class="built_in">echo</span> <span class="string">"See <span class="variable">$logfile</span> for more information."</span>  </div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        status <span class="variable">$LSNR_PROCNAME</span>  </div><div class="line">        <span class="keyword">if</span> [ $? <span class="operator">-ne</span> <span class="number">0</span> ] ; <span class="keyword">then</span>  </div><div class="line">          <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$LOCKFILE</span>"</span> ]; <span class="keyword">then</span>  </div><div class="line">             rm <span class="operator">-f</span> <span class="variable">$LOCKFILE</span>   </div><div class="line">          <span class="keyword">fi</span>  </div><div class="line">             <span class="keyword">return</span> <span class="number">0</span> <span class="comment"># Listener is not running  </span></div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        ((su - <span class="variable">$ORACLE_NAME</span> -c <span class="string">"<span class="variable">$ORACLE_HOME</span>/bin/lsnrctl stop"</span>) &gt;&gt; <span class="variable">$logfile</span> <span class="number">2</span>&gt;&<span class="number">1</span>) || <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">        <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$LOCKFILE</span>"</span> ]; <span class="keyword">then</span>  </div><div class="line">             rm <span class="operator">-f</span> <span class="variable">$LOCKFILE</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>  </div><div class="line">}  </div><div class="line"><span class="function"><span class="title">get_lsnr_status</span></span>()  {  </div><div class="line">        <span class="keyword">declare</span> -i subsys_lock=<span class="variable">$1</span>  </div><div class="line">        status <span class="variable">$LSNR_PROCNAME</span>  </div><div class="line">        <span class="keyword">if</span> [ $? == <span class="number">0</span> ] ; <span class="keyword">then</span>  </div><div class="line">                <span class="keyword">return</span> <span class="number">0</span> <span class="comment"># Listener is running fine  </span></div><div class="line">        <span class="keyword">elif</span> [ <span class="variable">$subsys_lock</span> <span class="operator">-ne</span> <span class="number">0</span> ]; <span class="keyword">then</span>  </div><div class="line">                <span class="keyword">return</span> <span class="number">3</span>  </div><div class="line">        <span class="keyword">elif</span> [ $? <span class="operator">-ne</span> <span class="number">0</span> ] ; <span class="keyword">then</span>  </div><div class="line">               <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">}  </div><div class="line"><span class="function"><span class="title">get_db_status</span></span>()  {  </div><div class="line">        <span class="keyword">declare</span> -i subsys_lock=<span class="variable">$1</span>  </div><div class="line">        <span class="keyword">declare</span> -i i=<span class="number">0</span> </div><div class="line">        <span class="keyword">declare</span> -i rv=<span class="number">0</span> </div><div class="line">        <span class="keyword">declare</span> ora_procname  </div><div class="line">        <span class="keyword">for</span> procname <span class="keyword">in</span> <span class="variable">$DB_PROCNAMES</span> ; <span class="keyword">do</span>  </div><div class="line">                ora_procname=<span class="string">"ora_<span class="variable">${procname}</span>_<span class="variable">${ORACLE_SID}</span>"</span> </div><div class="line">                status <span class="variable">$ora_procname</span>  </div><div class="line">                <span class="keyword">if</span> [ $? <span class="operator">-eq</span> <span class="number">0</span> ] ; <span class="keyword">then</span>  </div><div class="line">                        <span class="comment"># This one's okay; go to the next one.  </span></div><div class="line">                        <span class="keyword">continue</span>  </div><div class="line">                <span class="keyword">elif</span> [ <span class="variable">$subsys_lock</span> <span class="operator">-ne</span> <span class="number">0</span> ]; <span class="keyword">then</span>  </div><div class="line">                        <span class="keyword">return</span> <span class="number">3</span>  </div><div class="line">                <span class="keyword">elif</span>  [ $? <span class="operator">-ne</span> <span class="number">0</span> ] ; <span class="keyword">then</span>   </div><div class="line">                        <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">                <span class="keyword">fi</span>  </div><div class="line">        <span class="keyword">done</span>  </div><div class="line">}  </div><div class="line"><span class="function"><span class="title">update_status</span></span>()  {  </div><div class="line">        <span class="keyword">declare</span> -i old_status=<span class="variable">$1</span>  </div><div class="line">        <span class="keyword">declare</span> -i new_status=<span class="variable">$2</span>  </div><div class="line">        <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$2</span>"</span> ]; <span class="keyword">then</span>  </div><div class="line">                <span class="keyword">return</span> <span class="variable">$old_status</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="keyword">if</span> [ <span class="variable">$old_status</span> <span class="operator">-ne</span> <span class="variable">$new_status</span> ]; <span class="keyword">then</span>  </div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="keyword">return</span> <span class="variable">$old_status</span>  </div><div class="line">}  </div><div class="line"><span class="function"><span class="title">status_ias</span></span>()  {  </div><div class="line">        <span class="keyword">declare</span> -i subsys_lock=<span class="number">1</span> </div><div class="line">        <span class="keyword">declare</span> -i last  </div><div class="line">        <span class="comment">#  </span></div><div class="line">        <span class="comment"># Check for lock file.  Crude and rudimentary, but it works  </span></div><div class="line">        <span class="comment">#  </span></div><div class="line">        <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$LOCKFILE</span>"</span> ] || [ <span class="operator">-f</span> <span class="variable">$LOCKFILE</span> ]; <span class="keyword">then</span>  </div><div class="line">                subsys_lock=<span class="number">0</span> </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="comment"># Check database status  </span></div><div class="line">        get_db_status <span class="variable">$subsys_lock</span>  </div><div class="line">        update_status $? <span class="comment"># Start  </span></div><div class="line">        last=$?  </div><div class="line">        <span class="comment"># Check & report listener status  </span></div><div class="line">        get_lsnr_status <span class="variable">$subsys_lock</span>  </div><div class="line">        update_status $? <span class="variable">$last</span>  </div><div class="line">        last=$?  </div><div class="line">        <span class="comment"># Check & report opmn / opmn-managed process status  </span></div><div class="line">        <span class="comment">#get_opmn_status $subsys_lock  </span></div><div class="line">        <span class="comment">#update_status $? $last  </span></div><div class="line">        <span class="comment">#last=$?  </span></div><div class="line">        <span class="comment">#  </span></div><div class="line">        <span class="comment"># No lock file, but everything's running.  Put the lock  </span></div><div class="line">        <span class="comment"># file back. XXX - this kosher?  </span></div><div class="line">        <span class="comment">#  </span></div><div class="line">        <span class="keyword">if</span> [ <span class="variable">$last</span> <span class="operator">-eq</span> <span class="number">0</span> ] && [ <span class="variable">$subsys_lock</span> <span class="operator">-ne</span> <span class="number">0</span> ]; <span class="keyword">then</span>  </div><div class="line">                touch <span class="variable">$LOCKFILE</span>  </div><div class="line">        <span class="keyword">fi</span>  </div><div class="line">        <span class="keyword">return</span> <span class="variable">$last</span>  </div><div class="line">}  </div><div class="line"><span class="function"><span class="title">restart</span></span>() {  </div><div class="line">         <span class="built_in">echo</span> -n <span class="string">"Restart Oracle10g Server"</span>  </div><div class="line">           stop  </div><div class="line">             start  </div><div class="line"><span class="built_in">echo</span>  </div><div class="line">}  </div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span>  </div><div class="line">start)  </div><div class="line">    start  </div><div class="line">    <span class="keyword">exit</span> $?  </div><div class="line">    ;;  </div><div class="line">stop)  </div><div class="line">     stop  </div><div class="line">    <span class="keyword">exit</span> $?  </div><div class="line">;;  </div><div class="line">status)  </div><div class="line">    status_ias  </div><div class="line">    <span class="keyword">exit</span> $?  </div><div class="line">;;  </div><div class="line">restart|reload)  </div><div class="line">    stop  </div><div class="line">    start  </div><div class="line">;;  </div><div class="line">*)  </div><div class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> {start|stop|reload|restart|status}"</span>  </div><div class="line"><span class="keyword">exit</span> <span class="number">1</span>  </div><div class="line">;;  </div><div class="line"><span class="keyword">esac</span>  </div><div class="line"><span class="keyword">exit</span> <span class="number">0</span></div></pre></td></tr></table></figure>



<p>supervisord.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[supervisord]</div><div class="line">nodaemon=<span class="literal">true</span></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line">[program:oracle]</div><div class="line">command=service oracle start</div></pre></td></tr></table></figure>


<h1 id="构建oracle_安装环境">构建oracle 安装环境</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@master oracle]<span class="comment"># docker  build -t centos65-oracle-env .</span></div><div class="line">[root@master oracle]<span class="comment"># docker  images</span></div><div class="line">REPOSITORY           TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</div><div class="line">centos65-oracle      env                 <span class="number">0749092</span>dab0f        <span class="number">8</span> minutes ago       <span class="number">1.04</span> GB</div></pre></td></tr></table></figure>


<h1 id="安装oracle软件">安装oracle软件</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#启动前面构建的Oracle安装环境 --privileged=true 参数表示一些sys kernel配置可以写 ，映射database 目录</span></div><div class="line">[centos65-oracle]<span class="comment"># docker run -it --privileged=true -v /usr/local/src/database:/usr/local/src/database centos65-oracle-env /bin/bash</span></div><div class="line">bash-<span class="number">4.1</span><span class="comment"># cd /usr/local/src/</span></div><div class="line">bash-<span class="number">4.1</span><span class="comment"># ls</span></div><div class="line">createdb.sh  database  initcenter.ora  install.sh</div><div class="line">bash-<span class="number">4.1</span><span class="comment"># sh /usr/local/src/install.sh </span></div><div class="line">bash-<span class="number">4.1</span><span class="comment"># exit</span></div></pre></td></tr></table></figure>


<p>Oracle 数据库软件安装完毕，commit到docker镜像中，另起一个名字：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[centos65-oracle]<span class="comment"># docker commit  &lt;cid&gt; centos65-oracle-soft</span></div></pre></td></tr></table></figure>


<p>创建oracle数据库 center实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[centos65-oracle]<span class="comment"># docker  run -it --privileged=true -v /opt/data/oracle/data1:/u02/oradata/  centos65-oracle-soft /bin/bash</span></div><div class="line">bash-<span class="number">4.1</span><span class="comment">#chmod +x /usr/local/src/createdb.sh</span></div><div class="line">bash-<span class="number">4.1</span><span class="comment">#chown -R oracle:oinstall /u02/oradata</span></div><div class="line">bash-<span class="number">4.1</span><span class="comment">#sh /usr/local/src/createdb.sh</span></div><div class="line">bash-<span class="number">4.1</span><span class="comment">#exit</span></div></pre></td></tr></table></figure>


<p>Oracle 数据库 center 实例创建完毕，commit到docker镜像为centos65-oracle-center</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[centos65-oracle]<span class="comment">#docker commit  &lt;cid&gt; centos65-oracle-center</span></div></pre></td></tr></table></figure>


<p>运行oracle容器,映射数据库文件目录和备份目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker  run <span class="operator">-d</span> -P  --privileged=<span class="literal">true</span> -v /opt/data/oracle/data1:/u02/oradata/ -v  /opt/data/oracle/bak:/bak  centos65-oracle-center supervisord</div></pre></td></tr></table></figure>



<p>实际使用的过程中，可以将刚创建的/opt/data/oracle/data1 的数据目录复制一份如 /opt/data/oracle/data_init ，打包做备份，以便后面做基础的数据库模板。同时可以启动多个容器，加载各自的数据库文件运行实例。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/10/30/Docker-In-Action-docker-tomcat-httpd/">
  <time datetime="2014-10-30T12:54:44.000Z">
    10月 30 2014
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/10/30/Docker-In-Action-docker-tomcat-httpd/">Docker In Action&lt;二&gt; 制作可以SSH登录的web容器服务指北</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p><img src="http://hzchenkj-github-io.qiniudn.com/tomcat.png" alt="Apache Tomcat"></p>
<p>本篇基于前面文章<a href="http://hzchenkj.github.io/2014/10/27/Docker-In-Action-docker-ssh/" target="_blank" rel="external">Docker In Action&lt;一&gt; 制作可以SSH登录的docker容器服务指北</a>生成的centos65-ssh开始制作web服务器，使用httpd或者Tomcat来提供web服务（使用supervisor和volumn 方式来制作服务)。</p>
<h2 id="构建httpd_web服务器">构建httpd web服务器</h2>
<p>一、构建http web服务容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p ~/docker/webserver</div><div class="line"><span class="built_in">cd</span> ~/docker/webserver</div></pre></td></tr></table></figure>


<p>Dockerfile</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cat &gt;&gt; ~/docker/webserver/Dockerfile &lt;&lt; EOF</div><div class="line">FROM centos65-ssh</div><div class="line">MAINTAINER hzchenkj</div><div class="line">RUN yum install -y httpd</div><div class="line">RUN yum clean all</div><div class="line">RUN <span class="built_in">echo</span> <span class="string">"A simple Docker webserver"</span> &gt; /var/www/html/index.html</div><div class="line">ADD supervisord.conf /etc/supervisord.conf</div><div class="line">EXPOSE <span class="number">80</span></div><div class="line">EOF</div></pre></td></tr></table></figure>



<p>supervisord.conf  使用supervisord服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cat &gt;&gt; ~/docker/webserver/supervisord.conf &lt;&lt; EOF</div><div class="line">[supervisord]</div><div class="line">nodaemon=<span class="literal">true</span></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line">[program:httpd]</div><div class="line">command=/usr/sbin/httpd -D FOREGROUND</div><div class="line">EOF</div></pre></td></tr></table></figure>



<p>构建容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@master webserver]<span class="comment"># docker build -t centos65-webserver ~/docker/webserver/</span></div><div class="line">Sending build context to Docker daemon <span class="number">3.584</span> kB</div><div class="line">Sending build context to Docker daemon </div><div class="line">Step <span class="number">0</span> : FROM centos65-ssh</div><div class="line"> ---&gt; <span class="number">394</span>fac76f4b2</div><div class="line">Step <span class="number">1</span> : MAINTAINER hzchenkj</div><div class="line"> ---&gt; Running <span class="keyword">in</span> <span class="number">1</span>ccb987bae63</div><div class="line"> ---&gt; ec16a945cba3</div><div class="line">Removing intermediate container <span class="number">1</span>ccb987bae63</div><div class="line">Step <span class="number">2</span> : RUN yum install -y httpd</div><div class="line"> ---&gt; Running <span class="keyword">in</span> ee586632d936</div><div class="line">Loaded plugins: fastestmirror</div></pre></td></tr></table></figure>



<p>查看镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@master webserver]<span class="comment"># docker  images</span></div><div class="line">REPOSITORY           TAG                 IMAGE ID            CREATED              VIRTUAL SIZE</div><div class="line">centos65-webserver   latest              <span class="number">66</span>b7f5ed174f        About a minute ago   <span class="number">449.1</span> MB</div><div class="line">centos65-ssh         latest              <span class="number">394</span>fac76f4b2        <span class="number">3</span> hours ago          <span class="number">366.4</span> MB</div><div class="line">centos65-base        latest              <span class="number">0</span>b1acae7bfea        <span class="number">11</span> hours ago         <span class="number">292.3</span> MB</div></pre></td></tr></table></figure>



<p>启动webserver容器，端口80映射到本机5001端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@master webserver]<span class="comment"># docker run -d -p 5001:80 centos65-webserver</span></div><div class="line"><span class="number">0636</span>d5bf9e9b85ffc804012a2d6bd7af78080e85e674bd5975d64a1f126376ac</div></pre></td></tr></table></figure>


<p>查看启动的webserver容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@master webserver]<span class="comment"># docker  ps </span></div><div class="line">CONTAINER ID        IMAGE                       COMMAND                CREATED              STATUS              PORTS                                    NAMES</div><div class="line"><span class="number">0636</span>d5bf9e9b        centos65-webserver:latest   /bin/sh -c <span class="string">'supervis   About a minute ago   Up About a minute   22/tcp, 8080/tcp, 0.0.0.0:5001-&gt;80/tcp   berserk_kirch  </span></div><div class="line">[root@master webserver]# docker logs 0636d5bf9e9b</div><div class="line">2014-10-29 00:08:10,977 CRIT Supervisor running as root (no user in config file)</div><div class="line">2014-10-29 00:08:10,986 INFO supervisord started with pid 1</div><div class="line">2014-10-29 00:08:10,988 INFO spawned: 'httpd<span class="string">' with pid 8</span></div><div class="line">2014-10-29 00:08:10,989 INFO spawned: 'sshd<span class="string">' with pid 9</span></div><div class="line">2014-10-29 00:08:11,987 INFO success: httpd entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)</div><div class="line">2014-10-29 00:08:11,988 INFO success: sshd entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)</div><div class="line">[root@master webserver]#</div></pre></td></tr></table></figure>


<p>访问wenb服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@master webserver]<span class="comment"># curl localhost:5001</span></div><div class="line">A simple Docker webserver</div><div class="line">[root@master webserver]<span class="comment">#</span></div></pre></td></tr></table></figure>




<h2 id="构建Tomcat_web服务器">构建Tomcat web服务器</h2>
<p>可以用yum来安装Tomcat服务也可以自己从<a href="http://tomcat.apache.org" target="_blank" rel="external">Tomcat</a>官方网站下载tomcat包和jdk文件进行发布。<br>本处使用存手工方式来安装JDK，设置环境变量并安装tomcat服务。<br>使用volumn方式来发布web服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir -p ~/docker/tomcat</div><div class="line"><span class="built_in">cd</span> ~/docker/tomcat</div><div class="line">touch ~/docker/tomcat/Dockerfile</div><div class="line"><span class="built_in">cd</span> /usr/local/src</div><div class="line">wget http://**/jdk1.<span class="number">6.0</span>_38.tar.gz</div><div class="line">wget http://mirrors.cnnic.cn/apache/tomcat/tomcat-<span class="number">6</span>/v6.<span class="number">0.41</span>/bin/apache-tomcat-<span class="number">6.0</span>.<span class="number">41</span>.tar.gz</div><div class="line">mkdir -p /Docker_Volume/webapps</div></pre></td></tr></table></figure>


<p>Dockerfile</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">FROM centos65-ssh</div><div class="line">MAINTAINER chenkj &lt;hzchenkj@<span class="number">163</span>.com&gt;</div><div class="line"><span class="comment">#RUN yum -y install tomcat6</span></div><div class="line"><span class="comment">#RUN yum -y install tomcat6-webapps</span></div><div class="line"><span class="comment">#安装jdk</span></div><div class="line">ADD /usr/local/src/jdk1.<span class="number">6.0</span>_38.tar.gz /tmp/jdk1.<span class="number">6.0</span>_38.tar.gz</div><div class="line">RUN mv /tmp/jdk1.<span class="number">6.0</span>_38.tar.gz/jdk1.<span class="number">6.0</span>_38 /opt</div><div class="line">RUN rm -rf /tmp/jdk1.<span class="number">6.0</span>_38.tar.gz</div><div class="line"><span class="comment">#安装tomcat</span></div><div class="line">ADD /usr/local/src/apache-tomcat-<span class="number">6.0</span>.<span class="number">41</span>.tar.gz /tmp/apache-tomcat-<span class="number">6.0</span>.<span class="number">41</span>.tar.gz</div><div class="line">RUN mv /tmp/apache-tomcat-<span class="number">6.0</span>.<span class="number">41</span>.tar.gz/apache-tomcat-<span class="number">6.0</span>.<span class="number">41</span> /opt</div><div class="line">RUN rm -rf /tmp/apache-tomcat-<span class="number">6.0</span>.<span class="number">41</span>.tar.gz</div><div class="line"><span class="comment">#设置环境变量</span></div><div class="line">ENV JAVA_HOME /opt/jdk1.<span class="number">6.0</span>_38</div><div class="line">ENV PATH <span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="comment">#增加volume 目录</span></div><div class="line">VOLUME [<span class="string">"/Docker_Volume"</span>]</div><div class="line"><span class="comment">#增加supervisor服务</span></div><div class="line">ADD supervisord.conf /etc/supervisord.conf</div><div class="line">EXPOSE <span class="number">8080</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#RUN sed -i 's/appBase="webapps"/appBase="/Docker_Volume/webapps"/g' /opt/apache-tomcat-6.0.41/conf/server.xml</span></div><div class="line"><span class="comment">#ENTRYPOINT /opt/apache-tomcat-6.0.41/bin/startup.sh && tail -f /opt/apache-tomcat-6.0.41/logs/catalina.out</span></div></pre></td></tr></table></figure>




<p>supervisord.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[supervisord]</div><div class="line">nodaemon=<span class="literal">true</span></div><div class="line"><span class="comment">#sshd 服务</span></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"><span class="comment">#tomcat服务</span></div><div class="line">[program:tomcat]</div><div class="line">command= /opt/apache-tomcat-<span class="number">6.0</span>.<span class="number">41</span>/bin/startup.sh && tail <span class="operator">-f</span> /opt/apache-tomcat-<span class="number">6.0</span>.<span class="number">41</span>/logs/catalina.out</div></pre></td></tr></table></figure>


<p>构建tomcat服务容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#docker build -t centos65-tomcat .</span></div></pre></td></tr></table></figure>


<p>运行tomcat容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#docker run -d  -P centos65-tomcat</span></div></pre></td></tr></table></figure>



    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  

  <nav id="pagination">
  
  
    <a href="/page/2/" class="next">下一页</a>
  
  <div class="clearfix"></div>
</nav>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2015 <a href="/">hzchenkj</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="http://ajax.useso.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'hzchenkj' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>


</body>
</html>