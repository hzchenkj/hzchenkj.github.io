<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>归档 | LinuxCoffee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="hzchenkj">
  
  
  <meta name="description" content="GNU/Linux | Java | Python | Docker | Shell">
<meta property="og:type" content="website">
<meta property="og:title" content="LinuxCoffee">
<meta property="og:url" content="http://hzchenkj.github.com/archives/">
<meta property="og:site_name" content="LinuxCoffee">
<meta property="og:description" content="GNU/Linux | Java | Python | Docker | Shell">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LinuxCoffee">
<meta name="twitter:description" content="GNU/Linux | Java | Python | Docker | Shell">

  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">LinuxCoffee</a></h1>
    <p><a href="/">东写西读</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/reading">Reading</a></li>
      
        <li><a href="/about">About</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content">




  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/05/28/logstsh-if-conf-d/">
  <time datetime="2016-05-28T07:10:53.000Z">
    5月 28 2016
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/05/28/logstsh-if-conf-d/"></a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>title: logstsh-if-conf.d<br>date: 2016-05-28 14:57:55</p>
<h2 id="tags:logstash">tags:logstash</h2>
<p>一般情况下，logstash 测试和运行环境存在区别的。<br>为了方便，logstash 测试的时候会使用如下命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/<span class="keyword">opt</span>/logstash/bin/logstash -<span class="keyword">f</span> /<span class="keyword">opt</span>/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/test.<span class="keyword">conf</span></div></pre></td></tr></table></figure>

<p>测试没有问题。然后就会使用如下方式:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">service</span> <span class="title">logstash</span> restart</span></div></pre></td></tr></table></figure>

<p>让logstash  程序读取conf.d 目录下所有conf文件，然后启动程序。<br>这样就会带来一个问题，conf.d的文件 会被加载一个logstash 进程运行，多个conf 文件没有相互隔离。会出现测试时候不存在的问题。<br>解决方法：</p>
<p>1 使用 测试方法，将多个conf文件分开运行，写到脚本中</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/<span class="keyword">opt</span>/logstash/bin/logstash -<span class="keyword">f</span> /<span class="keyword">opt</span>/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/test1.<span class="keyword">conf</span></div><div class="line">/<span class="keyword">opt</span>/logstash/bin/logstash -<span class="keyword">f</span> /<span class="keyword">opt</span>/logstash/<span class="keyword">conf</span>.<span class="keyword">d</span>/test2.<span class="keyword">conf</span></div></pre></td></tr></table></figure>

<p>2 在配置文件中增加tag并做好if判断</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">input </div><div class="line">  file {</div><div class="line">     <span class="variable">type =</span>&gt; <span class="string">"app-log"</span></div><div class="line">     <span class="variable">path =</span>&gt; [ <span class="string">"/data/*.log"</span> ]</div><div class="line">     <span class="variable">start_position =</span>&gt; <span class="string">"beginning"</span></div><div class="line">     <span class="variable">codec =</span>&gt; multiline {</div><div class="line">       <span class="variable">pattern =</span>&gt; <span class="string">"^%{TIMESTAMP_ISO8601} "</span></div><div class="line">       <span class="variable">negate =</span>&gt; <span class="constant">true</span></div><div class="line">       <span class="variable">what =</span>&gt; previous</div><div class="line">     }</div><div class="line">   }</div><div class="line"></div><div class="line">   file {</div><div class="line">     <span class="variable">type =</span>&gt; <span class="string">"app-access-log"</span></div><div class="line">     <span class="variable">path =</span>&gt; [ <span class="string">"/data/*.log"</span> ]</div><div class="line">   } </div><div class="line">}</div><div class="line">   </div><div class="line">output {</div><div class="line">	<span class="keyword">if</span> ([type] <span class="keyword">in</span> [<span class="string">"app-log"</span>, <span class="string">"app-access-log"</span>]) {</div><div class="line">    </div><div class="line">   }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>logstash 在生产环境，一般是用service方式运行，或者使用supervisord来运行。 </p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/05/28/es-immense-term/">
  <time datetime="2016-05-28T06:41:08.000Z">
    5月 28 2016
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/05/28/es-immense-term/">es-immense-term</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>es集群在运行过程中，收到告警说两个几点CPU load告警，上去看了日志发现如下错误：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">java.lang.IllegalArgumentException: Document <span class="operator">contains</span> <span class="keyword">at</span> least <span class="constant">one</span> immense term <span class="operator">in</span> field=<span class="string">"msg"</span> (whose UTF8 encoding is longer than <span class="operator">the</span> <span class="built_in">max</span> <span class="built_in">length</span> <span class="number">32766</span>), all <span class="operator">of</span> which were skipped.  Please correct <span class="operator">the</span> analyzer <span class="built_in">to</span> <span class="operator">not</span> produce such terms.  The prefix <span class="operator">of</span> <span class="operator">the</span> <span class="keyword">first</span> immense term is: <span class="string">'[123, 34, 98, 114, 111, 97, 100, 99, 97, 115, 116, 73, 100, 34, 58, 49, 52, 48, 56, 49, 57, 57, 57, 56, 56, 44, 34, 116, 121, 112]...'</span>, original message: <span class="keyword">bytes</span> can be <span class="keyword">at</span> most <span class="number">32766</span> <span class="operator">in</span> <span class="built_in">length</span>; got <span class="number">40283</span></div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.DefaultIndexingChain$PerField.invert(DefaultIndexingChain.java:<span class="number">685</span>)</div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:<span class="number">359</span>)</div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.DefaultIndexingChain.processDocument(DefaultIndexingChain.java:<span class="number">318</span>)</div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.DocumentsWriterPerThread.updateDocument(DocumentsWriterPerThread.java:<span class="number">239</span>)</div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:<span class="number">454</span>)</div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:<span class="number">1511</span>)</div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:<span class="number">1246</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.index.engine.internal.InternalEngine.innerCreateNoLock(InternalEngine.java:<span class="number">482</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.index.engine.internal.InternalEngine.innerCreate(InternalEngine.java:<span class="number">435</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.index.engine.internal.InternalEngine.<span class="built_in">create</span>(InternalEngine.java:<span class="number">404</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.index.shard.service.InternalIndexShard.<span class="built_in">create</span>(InternalIndexShard.java:<span class="number">403</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.action.bulk.TransportShardBulkAction.shardIndexOperation(TransportShardBulkAction.java:<span class="number">449</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.action.bulk.TransportShardBulkAction.shardUpdateOperation(TransportShardBulkAction.java:<span class="number">541</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:<span class="number">240</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction.performOnPrimary(TransportShardReplicationOperationAction.java:<span class="number">511</span>)</div><div class="line">    <span class="keyword">at</span> org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction$<span class="number">1.</span>run(TransportShardReplicationOperationAction.java:<span class="number">419</span>)</div><div class="line">    <span class="keyword">at</span> java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1145</span>)</div><div class="line">    <span class="keyword">at</span> java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">615</span>)</div><div class="line">    <span class="keyword">at</span> java.lang.Thread.run(Thread.java:<span class="number">745</span>)</div><div class="line">Caused <span class="keyword">by</span>: org.apache.lucene.util.BytesRefHash$MaxBytesLengthExceededException: <span class="keyword">bytes</span> can be <span class="keyword">at</span> most <span class="number">32766</span> <span class="operator">in</span> <span class="built_in">length</span>; got <span class="number">40283</span></div><div class="line">    <span class="keyword">at</span> org.apache.lucene.util.BytesRefHash.<span class="built_in">add</span>(BytesRefHash.java:<span class="number">284</span>)</div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.TermsHashPerField.<span class="built_in">add</span>(TermsHashPerField.java:<span class="number">151</span>)</div><div class="line">    <span class="keyword">at</span> org.apache.lucene.index.DefaultIndexingChain$PerField.invert(DefaultIndexingChain.java:<span class="number">659</span>)</div><div class="line">    ... <span class="number">18</span> more</div></pre></td></tr></table></figure>

<p>意思就是消息的中的某个字段msg 的字段长度 超过了最大设置的值 32766字节。es系统不处理这个消息并抛出异常。  一般是这个字段设置成了not_anayzed,然后长度超出限制了。term 是一个搜索的最小单位，一般不会太大。</p>
<p>网上找了下解决方案，就是超出的部分就ignore。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl -XPUT 'http:<span class="comment">//localhost:9200/twitter' -d '</span></div><div class="line">{</div><div class="line">    <span class="string">"mappings"</span>:{</div><div class="line">        <span class="string">"tweet"</span> : {</div><div class="line">            <span class="string">"properties"</span> : {</div><div class="line">                <span class="string">"message"</span> : {<span class="string">"type"</span> : <span class="string">"string"</span>, <span class="string">"index"</span>:<span class="string">"not_analyzed"</span>,<span class="string">"ignore_above"</span>:<span class="number">256</span> }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line">'</div></pre></td></tr></table></figure>

<p>如果这个字段是 index:analyzed的情况就不会出现这个问题。具体要查看你es中设置的mapping。我默认是设置了动态 mapping。将没有指定的filed 设置成了not anaylzed。然后就出来这个长度的限制，修改mapping 搞定。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/12/07/linux_bonding_xen_kvm/">
  <time datetime="2015-12-07T13:06:16.000Z">
    12月 7 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/12/07/linux_bonding_xen_kvm/"></a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="Linux_双网卡绑定bonding">Linux 双网卡绑定bonding</h1>
<p>环境：</p>
<h2 id="CentOS_5系列_+_Xen">CentOS 5系列 + Xen</h2>
<h3 id="1_双网卡绑定_，产生bond0_接口">1 双网卡绑定 ，产生bond0 接口</h3>
<p>脚本如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="xml">cp /etc/sysconfig/network-scripts/ifcfg-eth1 /etc/sysconfig/network-scripts/ifcfg-eth1.bak </span></div><div class="line">cat &gt; /etc/sysconfig/network-scripts/ifcfg-eth1 <span class="tag">&lt;&lt;<span class="attribute">EOF</span> </span></div><div class="line"><span class="attribute">DEVICE</span>=<span class="value">eth1</span> </div><div class="line"><span class="attribute">USERCTL</span>=<span class="value">no</span> </div><div class="line"><span class="attribute">BOOTPROTO</span>=<span class="value">none</span> </div><div class="line"><span class="attribute">ONBOOT</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">MASTER</span>=<span class="value">bond0</span> </div><div class="line"><span class="attribute">SLAVE</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">TYPE</span>=<span class="value">Ethernet</span></div><div class="line"></div><div class="line"><span class="attribute">EOF</span></div><div class="line"></div><div class="line"><span class="attribute">cp</span> /<span class="attribute">etc</span>/<span class="attribute">sysconfig</span>/<span class="attribute">network-scripts</span>/<span class="attribute">ifcfg-eth2</span> /<span class="attribute">etc</span>/<span class="attribute">sysconfig</span>/<span class="attribute">network-scripts</span>/<span class="attribute">ifcfg-eth2.bak</span> </div><div class="line"><span class="attribute">cat</span> &gt; /etc/sysconfig/network-scripts/ifcfg-eth2 <span class="tag">&lt;&lt;<span class="attribute">EOF</span> </span></div><div class="line"><span class="attribute">DEVICE</span>=<span class="value">eth2</span> </div><div class="line"><span class="attribute">USERCTL</span>=<span class="value">no</span> </div><div class="line"><span class="attribute">BOOTPROTO</span>=<span class="value">none</span> </div><div class="line"><span class="attribute">ONBOOT</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">MASTER</span>=<span class="value">bond0</span> </div><div class="line"><span class="attribute">SLAVE</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">TYPE</span>=<span class="value">Ethernet</span></div><div class="line"></div><div class="line"><span class="attribute">EOF</span></div><div class="line"></div><div class="line"><span class="attribute">cat</span> &gt;/etc/sysconfig/network-scripts/ifcfg-bond0 <span class="tag">&lt;&lt; <span class="attribute">EOF</span> </span></div><div class="line"><span class="attribute">DEVICE</span>=<span class="value">bond0</span> </div><div class="line"><span class="attribute">BOOTPROTO</span>=<span class="value">none</span> </div><div class="line"><span class="attribute">IPADDR</span>=<span class="value">192.168.10.xx</span> </div><div class="line"><span class="attribute">NETMASK</span>=<span class="value">255.255.255.0</span> </div><div class="line"><span class="attribute">NETWORK</span>=<span class="value">192.168.10.254</span> </div><div class="line"><span class="attribute">USERCTL</span>=<span class="value">no</span> </div><div class="line"><span class="attribute">ONBOOT</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">TYPE</span>=<span class="value">Ethernet</span></div><div class="line"></div><div class="line"><span class="attribute">EOF</span></div></pre></td></tr></table></figure>

<h3 id="2_修改xen配置文件">2 修改xen配置文件</h3>
<p>/etc/xen/xend-config.sxp</p>
<p>(network-script ‘network-bridge netdev=bond0’)</p>
<p>使xen使用bond0 接口,默认生成xenbr0 的接口<br>或者</p>
<p>(network-script ‘network-bridge bridge=xenbr1 netdev=bond0’)</p>
<p>指定桥接的接口</p>
<p>原来的虚拟机是使用了多网卡 桥接的脚本<br>/etc/xen/xend-config.sxp</p>
<p>(network-script multi_bridge)</p>
<p>/etc/xen/scripts/multi_bridge</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/bash</span></div><div class="line">dir=$(dirname <span class="string">"<span class="variable">$0</span>"</span>)</div><div class="line"><span class="string">"<span class="variable">$dir</span>/network-bridge"</span> <span class="string">"<span class="variable">$@</span>"</span> vifnum=<span class="number">0</span> netdev=eth0 bridge=xenbr0</div><div class="line"><span class="string">"<span class="variable">$dir</span>/network-bridge"</span> <span class="string">"<span class="variable">$@</span>"</span> vifnum=<span class="number">1</span> netdev=eth1 bridge=xenbr1</div><div class="line"><span class="string">"<span class="variable">$dir</span>/network-bridge"</span> <span class="string">"<span class="variable">$@</span>"</span> vifnum=<span class="number">2</span> netdev=eth2 bridge=xenbr2</div><div class="line"><span class="string">"<span class="variable">$dir</span>/network-bridge"</span> <span class="string">"<span class="variable">$@</span>"</span> vifnum=<span class="number">3</span> netdev=eth3 bridge=xenbr3</div></pre></td></tr></table></figure>

<p>修改使用bond0</p>
<p>sed -i ‘s/eth1/bond0/g’ /etc/xen/scripts/multi_bridge sed -i ‘5,6s/^/#/‘ /etc/xen/scripts/multi_bridge</p>
<h3 id="3_domainU_配置文件">3 domainU 配置文件</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="variable">name =</span> <span class="string">"domain-1"</span></div><div class="line"><span class="variable">uuid =</span> <span class="string">"a5b43314-cd35-74e3-a357-4290768b7599"</span></div><div class="line"><span class="variable">maxmem =</span> <span class="number">8192</span></div><div class="line"><span class="variable">memory =</span> <span class="number">8192</span></div><div class="line"><span class="variable">vcpus =</span> <span class="number">6</span></div><div class="line"><span class="variable">bootloader =</span> <span class="string">"/usr/bin/pygrub"</span></div><div class="line"><span class="variable">on_poweroff =</span> <span class="string">"destroy"</span></div><div class="line"><span class="variable">on_reboot =</span> <span class="string">"restart"</span></div><div class="line"><span class="variable">on_crash =</span> <span class="string">"restart"</span></div><div class="line"><span class="variable">vfb =</span> [ <span class="string">"type=vnc,vncunused=1,keymap=en-us"</span>  ]</div><div class="line"><span class="variable">disk =</span> [ <span class="string">"tap:aio:/data/xenserver/domain-1/domain-1.img,xvda,w"</span>  ]</div><div class="line"><span class="variable">vif =</span> [ <span class="string">"mac=00:16:3e:37:02:c7,bridge=xenbr0,script=vif-bridge"</span>, <span class="string">"mac=00:16:36:18:22:f1,bridge=xenbr1,script=vif-bridge"</span>  ]</div></pre></td></tr></table></figure>

<h3 id="4_修改内核加载参数，使之生效">4 修改内核加载参数，使之生效</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cp</span> /etc/modprobe.<span class="keyword">conf</span> /etc/modprobe.<span class="keyword">conf</span>.bak </div><div class="line"><span class="keyword">cat</span> &gt;&gt; /etc/modprobe.<span class="keyword">conf</span> &lt;&lt; EOF</div><div class="line">alias bond0 bonding </div><div class="line"><span class="keyword">options</span> bond0 miimon=<span class="number">100</span> <span class="built_in">mode</span>=<span class="number">0</span></div><div class="line"></div><div class="line">EOF</div></pre></td></tr></table></figure>

<p>xen方式需要重启机器，才能保证双网卡绑定正常<br>加载绑定模块<br>modprobe bonding</p>
<p>xen 在重启完后，会生成一个pbond0 的接口</p>
<p>cat /proc/net/bonding/pbond0</p>
<h2 id="CentOS_6系列_+_KVM">CentOS 6系列 + KVM</h2>
<h3 id="ifcfg-bond0">ifcfg-bond0</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="setting">DEVICE=<span class="value">bond0</span></span></div><div class="line"><span class="setting">BOOTPROTO=<span class="value">static</span></span></div><div class="line"><span class="setting">BRIDGE=<span class="value">br0</span></span></div><div class="line"><span class="setting">NM_CONTROLLED=<span class="value"><span class="keyword">no</span></span></span></div><div class="line"><span class="setting">ONBOOT=<span class="value"><span class="keyword">yes</span></span></span></div></pre></td></tr></table></figure>

<h3 id="ifcfg-br0">ifcfg-br0</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="setting">DEVICE=<span class="value">br0</span></span></div><div class="line"><span class="setting">TYPE=<span class="value">Bridge</span></span></div><div class="line"><span class="setting">BOOTPROTO=<span class="value">static</span></span></div><div class="line"><span class="setting">ONBOOT=<span class="value"><span class="keyword">yes</span></span></span></div><div class="line"><span class="setting">IPADDR=<span class="value"><span class="number">192.168</span>.<span class="number">11.110</span></span></span></div><div class="line"><span class="setting">NETMASK=<span class="value"><span class="number">255.255</span>.<span class="number">255.0</span></span></span></div><div class="line"><span class="setting">GATEWAY=<span class="value"><span class="number">192.168</span>.<span class="number">11.254</span></span></span></div><div class="line"><span class="setting">MTU=<span class="value"><span class="number">1500</span></span></span></div><div class="line"><span class="setting">SLAVE=<span class="value">bond0</span></span></div><div class="line"><span class="setting">NM_CONTROLLED=<span class="value"><span class="keyword">no</span></span></span></div><div class="line"><span class="setting">PEERDNS=<span class="value"><span class="keyword">no</span></span></span></div></pre></td></tr></table></figure>

<p>vi /etc/libvirt/qemu/domain-1.xml</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;interface <span class="class"><span class="keyword">type</span></span>=<span class="string">'bridge'</span>&gt;</div><div class="line">      &lt;mac address=<span class="string">'52:54:31:b3:73:31'</span>/&gt;</div><div class="line">      &lt;source bridge=<span class="string">'br0'</span>/&gt;</div><div class="line">      &lt;model <span class="class"><span class="keyword">type</span></span>=<span class="string">'virtio'</span>/&gt;</div><div class="line">      &lt;address <span class="class"><span class="keyword">type</span></span>=<span class="string">'pci'</span> domain=<span class="string">'0x0000'</span> bus=<span class="string">'0x00'</span> slot=<span class="string">'0x03'</span> <span class="keyword">function</span>=<span class="string">'0x0'</span>/&gt;</div><div class="line">&lt;/interface&gt;</div></pre></td></tr></table></figure>

<h2 id="多个bonding">多个bonding</h2>
<h3 id="修改内核模块">修改内核模块</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cat</span> &gt;&gt; /etc/modprobe.<span class="keyword">conf</span> &lt;&lt; EOF</div><div class="line">alias bond0 bonding </div><div class="line"><span class="keyword">options</span> bond0 miimon=<span class="number">100</span> <span class="built_in">mode</span>=<span class="number">0</span></div><div class="line"></div><div class="line">alias bond1 bonding </div><div class="line"><span class="keyword">options</span> bond1 miimon=<span class="number">100</span> <span class="built_in">mode</span>=<span class="number">0</span></div><div class="line">EOF</div></pre></td></tr></table></figure>

<p>modprobe bonding</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/12/07/saltstack/">
  <time datetime="2015-12-07T13:05:40.000Z">
    12月 7 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/12/07/saltstack/"></a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="SaltStack">SaltStack</h1>
<p>saltstack</p>
<h2 id="安装配置测试">安装配置测试</h2>
<h3 id="salt-master">salt-master</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="operator"><span class="keyword">install</span> -y salt-<span class="keyword">master</span></span></div></pre></td></tr></table></figure>

<p>修改配置文件 /etc/salt/master </p>
<p>默认不用修改（KISS）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#interface: 0.0.0.0</span></div></pre></td></tr></table></figure>

<p>启动 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">service</span> <span class="title">salt</span>-master restart</span></div></pre></td></tr></table></figure>

<p>查看端口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -lntp|<span class="keyword">grep</span> <span class="number">4505</span></div></pre></td></tr></table></figure>

<h3 id="salt-minion">salt-minion</h3>
<p>安装</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="operator"><span class="keyword">install</span> -y salt-minion</span></div></pre></td></tr></table></figure>

<p>配置</p>
<p>/etc/salt/minion</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">master</span>: <span class="string">192.168.4.201</span></div></pre></td></tr></table></figure>

<p>启动minion</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">service</span> <span class="title">salt</span>-minion start</span></div></pre></td></tr></table></figure>

<p>查看端口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstnt -lntp|<span class="keyword">grep</span> <span class="number">4506</span></div></pre></td></tr></table></figure>

<h3 id="salt_master_为salt_minion_授权">salt master 为salt minion 授权</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#salt-key -L </span></div><div class="line">salt-key <span class="operator">-a</span> test.*.com</div></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt <span class="keyword">test</span>.*<span class="string">.com</span> <span class="keyword">test</span>.ping</div></pre></td></tr></table></figure>

<p>防火墙 master</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="literal">-</span><span class="comment">A</span> <span class="comment">INPUT</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">state</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">state</span> <span class="comment">new</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">dport</span> <span class="comment">4505</span> <span class="literal">-</span><span class="comment">j</span> <span class="comment">ACCEPT</span></div><div class="line"><span class="literal">-</span><span class="comment">A</span> <span class="comment">INPUT</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">state</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">state</span> <span class="comment">new</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">dport</span> <span class="comment">4506</span> <span class="literal">-</span><span class="comment">j</span> <span class="comment">ACCEPT</span></div></pre></td></tr></table></figure>




<h2 id="规范">规范</h2>
<p>主机名</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">&lt;app&gt;</span>-<span class="variable">&lt;001&gt;</span>-<span class="variable">&lt;sjc|fd|inner&gt;</span>-<span class="variable">&lt;11|12|201|204&gt;</span>-<span class="variable">&lt;ip&gt;</span>.<span class="keyword">*</span>.com</div><div class="line"></div><div class="line">kvmguest-002-inner-2-32.<span class="keyword">*</span>.com</div><div class="line">kvmguest-inner-192-168-2-32.<span class="keyword">*</span>.com</div></pre></td></tr></table></figure>

<p>/etc/hosts</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">127.0.0.1 localhost </span></span></div><div class="line">&lt;ip&gt; hostname</div></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span>.<span class="number">0.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</div><div class="line"><span class="number">192.168</span>.<span class="number">2.32</span>  kvmguest-<span class="number">002</span>-inner-<span class="number">2</span>-<span class="number">32</span>.*.<span class="keyword">com</span> kvmguest-<span class="number">002</span>-inner-<span class="number">2</span>-<span class="number">32</span></div></pre></td></tr></table></figure>

<h2 id="远程命令_remote_command">远程命令 remote command</h2>
<p>minon</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="title">salt</span> <span class="string">'*'</span> test.ping</div><div class="line">salt <span class="string">'myminion'</span> sys.list_functions test</div><div class="line">salt <span class="string">'*'</span> sys.doc test.fib</div><div class="line">salt <span class="string">'*'</span> test.fib <span class="number">30</span></div><div class="line">salt <span class="string">'*'</span> sys.doc test</div><div class="line">salt <span class="string">'*'</span> sys.list_functions sys</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo salt <span class="string">'*'</span> cmd.run_all <span class="string">'echo HELLO'</span></div><div class="line">sudo salt --<span class="keyword">out</span>=<span class="keyword">nested</span> <span class="string">'*'</span> cmd.run_all <span class="string">'echo HELLO'</span></div><div class="line">salt --<span class="keyword">out</span>=raw <span class="string">'*'</span> cmd.run_all <span class="string">'echo HELLO'</span></div><div class="line">salt --<span class="keyword">out</span>=json <span class="string">'*'</span> cmd.run_all <span class="string">'echo HELLO'</span></div><div class="line">--<span class="keyword">out</span>=yaml</div><div class="line">--<span class="keyword">out</span>=quiet</div></pre></td></tr></table></figure>

<h3 id="Targeting_strings">Targeting strings</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'myminion'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'my*'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'my*mini*'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'??minion'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'[a-m]yminion'</span> test.ping</div></pre></td></tr></table></figure>

<h3 id="Perl-compatible_regular_expression_matching_PCRE">Perl-compatible regular expression matching PCRE</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">salt -<span class="keyword">E</span> <span class="string">'myminion'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'my'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'my.*n'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'^myminion$'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'((my)|(your))minion'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'myminion(s)?'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'(my)?minion'</span> test.ping</div></pre></td></tr></table></figure>

<h3 id="List_matching">List matching</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="title">salt</span> -L <span class="string">'myminion'</span> test.ping</div><div class="line">salt -L <span class="string">'myminion,yourminion,theirminion'</span> test.ping</div></pre></td></tr></table></figure>

<p>Grains<br>Grains represent static data describing a minion.<br>Pillars<br>Pillar data is similar to grains except that it can be defined more dynamically and is<br>a secure store for data. </p>
<h3 id="Grain_and_pillar_matching">Grain and pillar matching</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> grains.<span class="keyword">item</span> os_family</div><div class="line">salt <span class="string">'*'</span> grains.<span class="keyword">item</span> os</div><div class="line">salt <span class="string">'*'</span> grains.<span class="keyword">item</span> osfinger</div><div class="line">salt <span class="comment">--grain 'os_family:RedHat' test.ping</span></div><div class="line">salt -G <span class="string">'os:Ubuntu'</span> test.ping</div><div class="line">salt -G <span class="string">'os:u*'</span> test.ping</div><div class="line">salt <span class="string">'*'</span> grains.<span class="keyword">items</span></div></pre></td></tr></table></figure>

<p>设置变量</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> <span class="transposed_variable">grains.</span>setval foo bar</div><div class="line">salt <span class="string">'*'</span> <span class="transposed_variable">grains.</span>item foo</div><div class="line">salt <span class="string">'*'</span> <span class="transposed_variable">grains.</span>setval baz <span class="string">'["</span>larry<span class="string">", "</span>moe<span class="string">", "</span>curly<span class="string">"]'</span></div><div class="line">salt <span class="string">'*'</span> <span class="transposed_variable">grains.</span>delval baz</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># cat /etc/salt/grains</div><div class="line">baz:</div><div class="line">-<span class="ruby"> larry</span></div><div class="line">-<span class="ruby"> moe</span></div><div class="line">-<span class="ruby"> curly</span></div><div class="line">foo: bar</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*.baz.com'</span> test.ping</div><div class="line">  </div><div class="line">salt -E <span class="string">'web-(prod|dev)'</span> test.ping</div><div class="line">  </div><div class="line">salt -L <span class="string">'web-jonh, dborac-ether'</span> test.ping</div><div class="line">  </div><div class="line"><span class="preprocessor"># By grains, target the RedHat and Debian systems</span></div><div class="line">salt -G <span class="string">'os:(RedHat|Debian)'</span> test.ping</div><div class="line">  </div><div class="line"><span class="preprocessor"># By Pillar data, target human resources</span></div><div class="line">salt -I <span class="string">'deparment:HR'</span> test.ping</div><div class="line">  </div><div class="line"><span class="preprocessor"># By IP/subnet, target the local network </span></div><div class="line">salt -S <span class="string">'192.16.0.0/24'</span> test.ping</div></pre></td></tr></table></figure>

<h3 id="Compound_matching">Compound matching</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># By minion ID and grains</span></div><div class="line"><span class="title">salt</span> -C <span class="string">'web-* and G<span class="variable">@os</span>:Ubuntu'</span> test.ping</div><div class="line">  </div><div class="line"><span class="comment"># By grains and Pillar data</span></div><div class="line">salt -C <span class="string">'G<span class="variable">@cpuarch</span>:x86_64 and I<span class="variable">@office</span>:32D'</span> test.ping</div><div class="line"></div><div class="line">salt -C <span class="string">'*minion and G<span class="variable">@os</span>:Ubuntu and not L<span class="variable">@yourminion</span>,theirminion'</span></div><div class="line">test.ping</div><div class="line"></div><div class="line">salt -C <span class="string">'* and not G<span class="variable">@os_family</span>:RedHat'</span> test.ping</div><div class="line"></div><div class="line">salt -C <span class="string">'G<span class="variable">@os</span>:Ubuntu or G<span class="variable">@os</span>:Fedora'</span> test.ping</div></pre></td></tr></table></figure>



<p>组合</p>
<table>
<thead>
<tr>
<th>Letter</th>
<th>Match Type</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>G</td>
<td>Grains glob</td>
<td>G@os:Ubuntu</td>
<td></td>
</tr>
<tr>
<td>E</td>
<td>PCRE minion ID</td>
<td>E@web\d+.(dev\</td>
<td>qa\</td>
<td>prod).loc</td>
<td></td>
</tr>
<tr>
<td>P</td>
<td>Grains PCRE</td>
<td>P@os:(RedHat\</td>
<td>Fedora\</td>
<td>CentOS)</td>
<td></td>
</tr>
<tr>
<td>L</td>
<td>List of minions</td>
<td>L@minion1.example.com, minion3.domain.com</td>
<td></td>
</tr>
<tr>
<td>I</td>
<td>Pillar glob</td>
<td>I@pdata:foobar</td>
<td></td>
</tr>
<tr>
<td>S</td>
<td>Subnet/IP address</td>
<td>S@192.168.1.0/24 or S@192.168.1.100</td>
<td></td>
</tr>
<tr>
<td>R</td>
<td>Range cluster</td>
<td>R@%foo.bar</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="Remote_execution_modules_and_functions">Remote execution modules and functions</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="class"><span class="keyword">module</span>&gt;.<span class="inheritance">&lt;<span class="parent">function</span></span>&gt;</span></div><div class="line">test.ping</div></pre></td></tr></table></figure>




<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">salt</span> <span class="string">'*'</span> sys.list_modules</div></pre></td></tr></table></figure>



<p> 常用模块</p>
<h3 id="用户管理">用户管理</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">salt '<span class="keyword">*</span>' sys.doc user.add</div><div class="line">salt '<span class="keyword">*</span>' user.add name <span class="variable">&lt;uid&gt;</span> <span class="variable">&lt;gid&gt;</span> <span class="variable">&lt;groups&gt;</span> <span class="variable">&lt;home&gt;</span> <span class="variable">&lt;shell&gt;</span></div><div class="line">salt '<span class="keyword">*</span>' user.add larry</div><div class="line">salt '<span class="keyword">*</span>' user.info larry</div></pre></td></tr></table></figure>


<h3 id="安装包">安装包</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> sys.doc pkg.install</div><div class="line">salt <span class="string">'*'</span> pkg.install httpd</div><div class="line">salt <span class="string">'*'</span> pkg.<span class="keyword">version</span> nano</div><div class="line">salt <span class="string">'*'</span> pkg.list_pkgs --out=json</div><div class="line">salt <span class="string">'*'</span> pkg.<span class="built_in">remove</span> htop</div></pre></td></tr></table></figure>

<h3 id="管理服务">管理服务</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> service.status httpd</div><div class="line">salt <span class="string">'*'</span> service.<span class="keyword">stop</span> apache2</div></pre></td></tr></table></figure>

<h3 id="监控minion状态">监控minion状态</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">salt</span> <span class="string">'*'</span> status.diskusage</div><div class="line">salt <span class="string">'*'</span> status.loadavg</div><div class="line">salt <span class="string">'*'</span> status.meminfo</div><div class="line">salt <span class="string">'*'</span> status.uptime</div></pre></td></tr></table></figure>

<h3 id="运行命令">运行命令</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> cmd.run <span class="string">'echo Hello!'</span></div><div class="line">salt <span class="string">'*'</span> cmd.run_stderr <span class="string">'echo Hello!'</span></div><div class="line">salt <span class="string">'*'</span> cmd.retcode <span class="string">'echo Hello!'</span></div><div class="line">salt <span class="string">'*'</span> cmd.run_all <span class="string">'echo Hello!'</span></div><div class="line">cmd.script <span class="keyword">sh</span>脚本</div></pre></td></tr></table></figure>


<h2 id="state">state</h2>
<p>对基础服务的管理包括配置管理系统、用户账号管理、yum配置管理、hosts文件管理、时间同步管理、DNS配置管理。</p>
<h3 id="配置管理系统">配置管理系统</h3>
<p>配置管理系统使用模块化设计，</p>
<p>每个服务一个模块，<br>将多个模块组织到一起形成角色（/srv/salt/roles/）。</p>
<p>所有模块放置到：/srv/salt下，<br>入口配置文件为：/srv/salt/top.sls。</p>
<p>模块使用的变量放置到：/srv/pillar，<br>入口配置文件：/srv/pillar/top.sls。</p>
<p>针对变量的作用域不同，将变量分为三级：</p>
<p>一级应用于模块（/srv/pillar/模块名），</p>
<p>一级应用于角色（/srv/pillar/roles/），</p>
<p>一级应用于主机节点（/srv/pillar/nodes）。</p>
<p>入口配置/srv/salt/top.sls，直接引用各种角色：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">base:  </div><div class="line">  '*':  </div><div class="line">    -<span class="ruby"> roles.common  </span></div><div class="line">  'admin.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.admin  </span></div><div class="line">  'ha.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.ha  </span></div><div class="line">  'web*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.web  </span></div><div class="line">  'cache*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.cache  </span></div><div class="line">  'mc*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.mc  </span></div><div class="line">  'db*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.db  </span></div><div class="line">  'search*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.search  </span></div><div class="line">  'storage*'.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.storage</span></div></pre></td></tr></table></figure>

<p>变量入口配置文件/srv/pillar/top.sls：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">base:  </div><div class="line">  '*':  </div><div class="line">    -<span class="ruby"> roles.common  </span></div><div class="line">  # 引用角色级变量  </div><div class="line">  # 模块级变量在角色级变量中引用  </div><div class="line">  'admin.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.admin  </span></div><div class="line">  'ha.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.ha  </span></div><div class="line">  'web*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.web  </span></div><div class="line">  'cache*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.cache  </span></div><div class="line">  'mc*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.mc  </span></div><div class="line">  'db*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.db  </span></div><div class="line">  'search*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.search  </span></div><div class="line">  'storage*'.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.storage  </span></div><div class="line">  # 引用节点级变量</div><div class="line">  'ha1.grid.mall.com':  </div><div class="line">    -<span class="ruby"> nodes.ha1  </span></div><div class="line">  'ha2.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.ha2  </span></div><div class="line">  'mc1.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.mc1  </span></div><div class="line">  'mc2.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.mc2  </span></div><div class="line">  'db1.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.db1  </span></div><div class="line">  'db2.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.db2</span></div></pre></td></tr></table></figure>

<p>用户账号管理<br>用户管理模块：/srv/salt/users</p>
<p>pillar和grains都可以用来获取变量</p>
<p>grains偏向于获取客户端相关信息，比如客户端硬件架构、cpu核数、操作系统版本等信息，相当于puppet的facter；</p>
<p>pillar用于定义用户变量，通过pillar变量的传递，使salt state模块易于重用，相当于puppet的hiera。</p>
<p>使用pillar变量之前需要执行salt ‘*’ saltutil.refresh_pillar命令使变量生效。</p>
<p>使用命令salt ‘admin.grid.mall.com’ pillar.item users获取users变量：</p>
<p>/srv/salt/users/user.sls用于管理用户</p>
<h3 id="Saltstack：服务部署">Saltstack：服务部署</h3>
<h2 id="API_(http_restful)">API (http restful)</h2>
<h3 id="salt_—versions-report">salt —versions-report</h3>
<h3 id="Specify_an_sls_file">Specify an sls file</h3>
<p>We can also specify an sls file. Sls files don’t normally use execution modules, and instead use state modules that are called automagically by Salt when it processes the state, although there is a special state module to call execution modules from within sls files. More on writing states in a minute:</p>
<h1 id="Apply_the_states_from_the_ssh-sls_file_on_all_minions-">Apply the states from the ssh.sls file on all minions.</h1>
<h1 id="Notice_how_we_omit_the_-sls_extension_in_the_command_line-">Notice how we omit the .sls extension in the command line.</h1>
<p>  salt ‘*’ state.sls ssh</p>
<p>salt -N ‘logs_wpk’   state.highstate<br>salt kvmguest-001-sjc-13-33.<em>.com  state.highstate<br>salt kvmguest-001-sjc-13-33.</em>.com  state.sls base.zabbix</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/12/07/zabbix-api/">
  <time datetime="2015-12-07T13:04:30.000Z">
    12月 7 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/12/07/zabbix-api/"></a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="zabbix_api">zabbix api</h1>
<h2 id="简介">简介</h2>
<p>zabbix api 为批量操作，第三方软件集成及其他作用提供可编程接口。</p>
<p>zabbix api 在1.8版本以后开始提供，zabbix移动客户端和原生的web前端部分都是建立在zabbix api上。zabbix api中间件使得架构更加模块化并避免对数据库进行操作。允许你使用JSON RPC协议来创建、更新和获取zabbix 对象并操作（认证你的账户）。</p>
<p>zabbix api 提供两项功能：</p>
<ol>
<li>远程管理zabbix 配置</li>
<li>远程检索配置和历史数据</li>
</ol>
<h2 id="zabbix_API开发库">zabbix API开发库</h2>
<p>zabbix API请求和响应都是json，并且还提供了各种语法的lib库，<a href="http://zabbix.org/wiki/Docs/api/libraries" target="_blank" rel="external">http://zabbix.org/wiki/Docs/api/libraries</a>，包含php、c#、Python、Perl、go等等语言</p>
<h2 id="使用JSON">使用JSON</h2>
<p>采用JSON RPC协议实现。调用任何函数，都要发送POST请求，输入输出都是JSON格式。<br>工作方式如下：</p>
<ol>
<li>准备JSON对象，描述你想要做什么(创建主机，获取图像，更新监控项)</li>
<li>采用POST方式 <a href="http://zabbix.*.info/zabbix/api_jsonrpc.php发送此JSON对象" target="_blank" rel="external">http://zabbix.*.info/zabbix/api_jsonrpc.php发送此JSON对象</a>. <a href="http://example.com/zabbix/是Zabbix前端地址。api_jsonrpc.php是调用API的PHP脚本。可在安装可视化前端的目录下找到。" target="_blank" rel="external">http://example.com/zabbix/是Zabbix前端地址。api_jsonrpc.php是调用API的PHP脚本。可在安装可视化前端的目录下找到。</a></li>
<li>获取json响应格式</li>
</ol>
<blockquote>
<p>请求方法必须是POST方法，HTTP Header  Content-Type  必须为【application/jsonrequest，application/json-rpc，application/json】其中之一</p>
</blockquote>
<h2 id="基本请求格式">基本请求格式</h2>
<p>JSON 请求如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">    "<span class="attribute">jsonrpc</span>": <span class="value"><span class="string">"2.0"</span></span>,</div><div class="line">    "<span class="attribute">method</span>": <span class="value"><span class="string">"method.name"</span></span>, </div><div class="line">    "<span class="attribute">params</span>": <span class="value">{</span></div><div class="line">        "<span class="attribute">param_1_name</span>": <span class="value"><span class="string">"param_1_value"</span></span>,</div><div class="line">        "<span class="attribute">param_2_name</span>": <span class="value"><span class="string">"param_2_value"</span> </span></div><div class="line">    },</div><div class="line">    "<span class="attribute">id</span>": <span class="value"><span class="number">1</span></span>,</div><div class="line">    "<span class="attribute">auth</span>": <span class="value"><span class="string">"159121b60d19a9b4b55d49e30cf12b81"</span></span>,</div><div class="line">}</div></pre></td></tr></table></figure>

<ol>
<li>json rpc协议版本</li>
<li>具体执行的操作 如:host.create item.update</li>
<li>传递json对象来作为参数,如创建监控项 ，name 和key是必须的。</li>
<li>id  1  绑定json请求和响应</li>
<li>auth  认证令牌  </li>
</ol>
<h2 id="API_使用">API 使用</h2>
<p>1 登录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">curl -i -X POST -H 'Content-Type: application/json' -d '{<span class="string">"jsonrpc"</span>:<span class="string">"2.0"</span>,<span class="string">"method"</span>:<span class="string">"user.login"</span>,<span class="string">"params"</span>:{<span class="string">"user"</span>:<span class="string">"***"</span>,<span class="string">"password"</span>:<span class="string">"***"</span>},<span class="string">"auth"</span>:null,<span class="string">"id"</span>:0}' http://zabbix.<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.info/api_jsonrpc.php</div></pre></td></tr></table></figure>

<p>2 获取主机</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST -H 'Content-Type: application/json' -d '{<span class="string">"jsonrpc"</span>:<span class="string">"2.0"</span>,<span class="string">"method"</span>:<span class="string">"host.get"</span>,<span class="string">"params"</span>:{<span class="string">"output"</span>:[<span class="string">"hostid"</span>,<span class="string">"name"</span>],<span class="string">"filter"</span>:{<span class="string">"host"</span>:<span class="string">""</span>}},<span class="string">"auth"</span>:<span class="string">"22ad296ae1ac36a07d16ea91d7af7227"</span>,<span class="string">"id"</span>:1}' http://zabbix.<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.info/api_jsonrpc.php</div></pre></td></tr></table></figure>

<p>3 获取监控主机的hostids</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST -H 'Content-Type: application/json' -d '{<span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,<span class="string">"method"</span>:<span class="string">"host.get"</span>,<span class="string">"params"</span>:{<span class="string">"output"</span>:[<span class="string">"hostid"</span>],<span class="string">"filter"</span>: {<span class="string">"host"</span>:<span class="string">"192.168.11.1"</span>}},<span class="string">"auth"</span>: <span class="string">"22ad296ae1ac36a07d16ea91d7af7227"</span>,<span class="string">"id"</span>: <span class="number">0</span>}' http:<span class="comment">//x.x.x.x/api_jsonrpc.php</span></div><div class="line">#<span class="string">"hostid"</span>:<span class="string">"10243"</span></div></pre></td></tr></table></figure>

<p>（3）获得监控项itemids</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST -H 'Content-Type: application/json' -d '{<span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,<span class="string">"method"</span>:<span class="string">"item.get"</span>,<span class="string">"params"</span>:{<span class="string">"output"</span>:<span class="string">"itemids"</span>,<span class="string">"hostids"</span>:<span class="string">"10243"</span>,<span class="string">"search"</span>:{<span class="string">"key_"</span>:<span class="string">"system.cpu.util</span></div><div class="line">[,idle,avg1]"}},<span class="string">"auth"</span>: <span class="string">"a826fca79a0795ccc1224dc76329972f"</span>,<span class="string">"id"</span>: <span class="number">0</span>}' http:<span class="comment">//x.x.x.x/api_jsonrpc.php</span></div><div class="line">#“item”:<span class="string">"24526"</span></div></pre></td></tr></table></figure>

<p>(4)获取监控项”system.cpu.util[,idle,avg1] “在2014.2.19 14:00~14:20的值</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'{"</span>jsonrpc<span class="string">": "</span><span class="number">2.0</span><span class="string">","</span>method<span class="string">":"</span><span class="transposed_variable">history.</span>get<span class="string">","</span>params<span class="string">":{"</span>history<span class="string">":0,"</span>itemids<span class="string">":["</span><span class="number">24526</span><span class="string">"],"</span>time_from<span class="string">":"</span><span class="number">1392789600</span><span class="string">","</span>time_till<span class="string">":"</span><span class="number">1392790200</span><span class="string">","</span>output<span class="string">":"</span>extend<span class="string">"},"</span>auth<span class="string">": "</span>a826fca79a0795ccc1224dc76329972f<span class="string">","</span>id<span class="string">": 0}'</span> http:<span class="comment">//x.x.x.x/api_jsonrpc.php</span></div></pre></td></tr></table></figure>

<h2 id="参考地址">参考地址</h2>
<p><a href="https://www.zabbix.com/documentation/2.4/manual/api" target="_blank" rel="external">https://www.zabbix.com/documentation/2.4/manual/api</a> </p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/11/04/MegaCli_smart/">
  <time datetime="2015-11-04T07:55:02.000Z">
    11月 4 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/11/04/MegaCli_smart/"></a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="使用MegaCli工具查看Raid磁盘阵列状态">使用MegaCli工具查看Raid磁盘阵列状态</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#MegaCli  -LDInfo -Lall -aALL 查raid级别</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpAllInfo -aALL 查raid卡信息</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpBbuCmd -aAll 查看电池信息</span></div><div class="line"><span class="preprocessor">#MegaCli -FwTermLog -Dsply -aALL 查看raid卡日志</span></div><div class="line"><span class="preprocessor">#MegaCli -adpCount 【显示适配器个数】</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpGetTime –aALL 【显示适配器时间】</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpAllInfo -aAll    【显示所有适配器信息】</span></div><div class="line"><span class="preprocessor">#MegaCli -LDInfo -LALL -aAll    【显示所有逻辑磁盘组信息】</span></div><div class="line"><span class="preprocessor">#MegaCli -PDList -aAll    【显示所有的物理信息】</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpBbuCmd -GetBbuStatus -aALL |grep 'Charger Status' 【查看充电状态】</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpBbuCmd -GetBbuStatus -aALL【显示BBU状态信息】</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpBbuCmd -GetBbuCapacityInfo -aALL【显示BBU容量信息】</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpBbuCmd -GetBbuDesignInfo -aALL    【显示BBU设计参数】</span></div><div class="line"><span class="preprocessor">#MegaCli -AdpBbuCmd -GetBbuProperties -aALL    【显示当前BBU属性】</span></div><div class="line"><span class="preprocessor">#MegaCli -cfgdsply -aALL    【显示Raid卡型号，Raid设置，Disk相关信息】</span></div></pre></td></tr></table></figure>

<p>3.磁带状态的变化，从拔盘，到插盘的过程中。</p>
<p>Device        |Normal|Damage|Rebuild|Normal</p>
<p>Virtual Drive    |Optimal|Degraded|Degraded|Optimal</p>
<p>Physical Drive    |Online|Failed –&gt; Unconfigured|Rebuild|Online</p>
<p>4.查看磁盘缓存策略</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#MegaCli -LDGetProp -Cache -L0 -a0</span></div><div class="line"><span class="preprocessor">#MegaCli -LDGetProp -Cache -L1 -a0</span></div><div class="line"><span class="preprocessor">#MegaCli -LDGetProp -Cache -LALL -a0</span></div><div class="line"><span class="preprocessor">#MegaCli -LDGetProp -Cache -LALL -aALL</span></div><div class="line"><span class="preprocessor">#MegaCli -LDGetProp -DskCache -LALL -aALL</span></div></pre></td></tr></table></figure>

<p>5.设置磁盘缓存策略<br>缓存策略解释：<br>WT    (Write through）</p>
<p>WB    (Write back)</p>
<p>NORA  (No read ahead)</p>
<p>RA    (Read ahead)</p>
<p>ADRA  (Adaptive read ahead)</p>
<p>Cached</p>
<p>Direct</p>
<p>例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#MegaCli -LDSetProp WT|WB|NORA|RA|ADRA -L0 -a0</span></div><div class="line">or</div><div class="line"><span class="preprocessor">#MegaCli -LDSetProp -Cached|-Direct -L0 -a0</span></div><div class="line">or</div><div class="line">enable / disable disk cache</div><div class="line"><span class="preprocessor">#MegaCli -LDSetProp -EnDskCache|-DisDskCache -L0 -a0</span></div></pre></td></tr></table></figure>

<p>6.创建一个 raid5 阵列，由物理盘 2,3,4 构成，该阵列的热备盘是物理盘 5</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -CfgLdAdd -r5 [1:2,1:3,1:4] WB Direct -Hsp[1:5] -a0</span></div></pre></td></tr></table></figure>

<p>7.创建阵列，不指定热备</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -CfgLdAdd -r5 [1:2,1:3,1:4] WB Direct -a0</span></div></pre></td></tr></table></figure>

<p>8.删除阵列</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -CfgLdDel -L1 -a0</span></div></pre></td></tr></table></figure>

<p>9.在线添加磁盘</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#/opt/MegaCli -LDRecon -Start -<span class="literal">r5</span> -<span class="keyword">Add</span> -PhysDrv[<span class="number">1</span>:<span class="number">4</span>] -L1 -a0</div></pre></td></tr></table></figure>

<p>10.阵列创建完后，会有一个初始化同步块的过程，可以看看其进度。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -LDInit -ShowProg -LALL -aALL</span></div></pre></td></tr></table></figure>

<p>或者以动态可视化文字界面显示</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -LDInit -ProgDsply -LALL -aALL</span></div></pre></td></tr></table></figure>

<p>11.查看阵列后台初始化进度</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -LDBI -ShowProg -LALL -aALL</span></div></pre></td></tr></table></figure>

<p>或者以动态可视化文字界面显示</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -LDBI -ProgDsply -LALL -aALL</span></div></pre></td></tr></table></figure>

<p>12.指定第 5 块盘作为全局热备</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] -a0</span></div></pre></td></tr></table></figure>

<p>13.指定为某个阵列的专用热备</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -PDHSP -Set [-Dedicated [-Array1]] [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] -a0</span></div></pre></td></tr></table></figure>

<p>14.删除全局热备</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -PDHSP -Rmv -PhysDrv[1:5] -a0</span></div></pre></td></tr></table></figure>

<p>15.将某块物理盘下线/上线</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -PDOffline -PhysDrv [1:4] -a0</span></div><div class="line"><span class="preprocessor">#/opt/MegaCli -PDOnline -PhysDrv [1:4] -a0</span></div></pre></td></tr></table></figure>

<p>16.查看物理磁盘重建进度</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -PDRbld -ShowProg -PhysDrv [1:5] -a0</span></div></pre></td></tr></table></figure>

<p>或者以动态可视化文字界面显示</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#/opt/MegaCli -PDRbld -ProgDsply -PhysDrv [1:5] -a0</span></div></pre></td></tr></table></figure>


    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/01/20/Nginx-PHP/">
  <time datetime="2015-01-20T01:02:54.000Z">
    1月 20 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/01/20/Nginx-PHP/">Nginx PHP 整合</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>yum install tar unzip </p>
<p>现在流行用LNMP的组合框架了。整理了一小篇。<br>常规的做法是将数据库和Web 应用分两台进行部署。网上的文章，基本上都是在一台Linux服务器上部署Nginx + PHP + MySQL。<br>在编译PHP的时候都需要安装MySQL 的软件，然后带上—with-mysql的参数。但我们在这台服务器上根本就用不上MySQL的服务。<br>后来在PHP官网找到一个文档说明，说PHP 默认已经在某个版本后，可以实现不用MySQL 既可以编译具有MySQL连接的PHP。</p>
<p>本次使用的PHP版本是5.5.20 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">yum install -y php-mysql</div><div class="line">wget http://cn2.php.net/get/php-<span class="number">5.5</span>.<span class="number">20</span>.tar.gz/from/this/mirror</div><div class="line">tar zxvf php-<span class="number">5.5</span>.<span class="number">20</span>.tar.gz</div><div class="line"><span class="built_in">cd</span> php-<span class="number">5.5</span>.<span class="number">20</span></div><div class="line">./configure --prefix=/usr/local/php5  --enable-fpm --with-mysql</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>

<p>还额外提供了很多的编译参数，当然还需要安装一些软件依赖包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/data/program/php_5.<span class="number">5</span>  --enable-fpm --with-mysql \</div><div class="line">--with-config-file-path=/usr/local/php5/etc \</div><div class="line">--enable-mbstring \</div><div class="line">--enable-ftp \</div><div class="line">--with-gd \</div><div class="line">--with-jpeg-dir=/usr \</div><div class="line">--with-png-dir=/usr \</div><div class="line">--enable-sockets \</div><div class="line">--with-freetype-dir=/usr \</div><div class="line">--enable-gd-native-ttf \</div><div class="line">--with-zlib \</div><div class="line">--enable-sysvsem \</div><div class="line">--enable-exif \</div><div class="line">--enable-sysvshm \</div><div class="line">--with-libxml-dir=/usr \</div><div class="line">--with-xmlrpc \</div><div class="line">--enable-xml \</div><div class="line">--enable-shmop \</div><div class="line">--enable-zip \</div><div class="line">--with-mhash \</div><div class="line">--enable-bcmath \</div><div class="line">--enable-inline-optimization \</div><div class="line">--with-curl \</div><div class="line">--enable-mbregex \</div><div class="line">--with-openssl \</div><div class="line">--enable-opcache=no</div></pre></td></tr></table></figure>

<p>软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">yum install -y  gcc gcc-c++ autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel </div><div class="line"> glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses ncurses-devel </div><div class="line">curl curl-devel e2fsprogs e2fsprogs-devel krb5 krb5-devel libidn libidn-devel openssl openssl-devel </div><div class="line">yum install -y zlib zlib-devel libxml2 libxml2-devel</div></pre></td></tr></table></figure>

<p>拷贝php配置文件和php-fpm的配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cp /usr/local/src/php-<span class="number">5.5</span>.<span class="number">20</span>/php.ini-development /usr/local/php5/php.ini</div><div class="line">cp /usr/local/php5/etc/php-fpm.conf.default /usr/local/php5/etc/php-fpm.conf</div><div class="line">cp sapi/fpm/php-fpm /usr/local/bin</div></pre></td></tr></table></figure>

<p>vim /usr/local/php5/php.ini</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cgi.fix_pathinfo=<span class="number">0</span></div></pre></td></tr></table></figure>

<p>vim /usr/local/php5/etc/php-fpm.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">user = www-data</div><div class="line">group = www-data</div><div class="line">pid = run/php-fpm.pid</div><div class="line">security.limit_extensions = .php .php3 .php4 .php5 .css .js .jpg .jpeg .gif .png .html .htm</div></pre></td></tr></table></figure>

<p>然后启动 php-fpm 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/local/bin/php-fpm</div><div class="line">netstat -ant|grep <span class="number">9000</span></div></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#关闭php-fpm</span></div><div class="line">kill -INT `cat /usr/local/php5/var/run/php-fpm.pid`</div><div class="line"><span class="comment">#重启php-fpm</span></div><div class="line">kill -USR2 `cat /usr/local/php5/var/run/php-fpm.pid`</div></pre></td></tr></table></figure>

<p>安装Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">groupadd -r -g <span class="number">5000</span> nginx</div><div class="line">useradd -r -g nginx -u <span class="number">5000</span> nginx</div><div class="line">yum -y install pcre pcre-devel</div><div class="line">wget http://nginx.org/download/nginx-<span class="number">1.2</span>.<span class="number">9</span>.tar.gz</div><div class="line">tar zxvf nginx-<span class="number">1.2</span>.<span class="number">9</span>.tar.gz</div><div class="line"><span class="built_in">cd</span> nginx-<span class="number">1.2</span>.<span class="number">9</span></div><div class="line">./configure --prefix=/usr/local/nginx</div></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location ~* \.php$ {</div><div class="line">    fastcgi_index   index.php;</div><div class="line">    fastcgi_pass    <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>;</div><div class="line">    include         fastcgi_params;</div><div class="line">    fastcgi_param   SCRIPT_FILENAME    <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</div><div class="line">    fastcgi_param   SCRIPT_NAME        <span class="variable">$fastcgi_script_name</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>其他的一个版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">location ~* \.(php[<span class="number">3</span>-<span class="number">9</span>]?|phtm[l]?)(\/.*)*$ {  </div><div class="line">        fastcgi_index index.php;  </div><div class="line">        fastcgi_pass <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>;  </div><div class="line">        include fastcgi_params;  </div><div class="line">        <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="string">""</span>;  </div><div class="line">        <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$fastcgi_script_name</span>;  </div><div class="line">        <span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> ~ <span class="string">"^(.+?\.php)(/.+)$"</span>) {  </div><div class="line">                <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$1</span>;  </div><div class="line">                <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="variable">$2</span>;  </div><div class="line">        }  </div><div class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$real_script_name</span>;  </div><div class="line">        fastcgi_param SCRIPT_NAME <span class="variable">$real_script_name</span>;  </div><div class="line">        fastcgi_param PATH_INFO <span class="variable">$path_info</span>;  </div><div class="line">}  </div><div class="line">location ~* \.(php[<span class="number">3</span>-<span class="number">9</span>]?|phtm[l]?)(\/.*)*$ {  </div><div class="line">    fastcgi_index index.php;</div><div class="line">    fastcgi_pass <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>;<span class="comment">#这里指定了fastcgi进程侦听的端口,nginx就是通过这里与php交互的</span></div><div class="line">    include fastcgi_params;</div><div class="line">    <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="string">""</span>;</div><div class="line">    <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$fastcgi_script_name</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> ~ <span class="string">"^(.+?\.php)(/.+)$"</span>) {</div><div class="line">            <span class="keyword">set</span> <span class="variable">$real_script_name</span> <span class="variable">$1</span>;</div><div class="line">            <span class="keyword">set</span> <span class="variable">$path_info</span> <span class="variable">$2</span>;</div><div class="line">    }</div><div class="line">    fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$real_script_name</span>;</div><div class="line">    fastcgi_param SCRIPT_NAME <span class="variable">$real_script_name</span>;</div><div class="line">    fastcgi_param PATH_INFO <span class="variable">$path_info</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>fastcgi_param 参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=TEST:<span class="number">10</span>m inactive=<span class="number">5</span>m;      </div><div class="line">fastcgi_connect_timeout <span class="number">300</span>;      </div><div class="line">fastcgi_send_timeout <span class="number">300</span>;      </div><div class="line">fastcgi_<span class="built_in">read</span>_timeout <span class="number">300</span>;      </div><div class="line">fastcgi_buffer_size <span class="number">64</span>k;      </div><div class="line">fastcgi_buffers <span class="number">4</span> <span class="number">64</span>k;      </div><div class="line">fastcgi_busy_buffers_size <span class="number">128</span>k;      </div><div class="line">fastcgi_temp_file_write_size <span class="number">128</span>k;      </div><div class="line">fastcgi_cache TEST;      </div><div class="line">fastcgi_cache_valid <span class="number">200</span> <span class="number">302</span> <span class="number">1</span>h;      </div><div class="line">fastcgi_cache_valid <span class="number">301</span> <span class="number">1</span>d;      </div><div class="line">fastcgi_cache_valid any <span class="number">1</span>m;</div></pre></td></tr></table></figure>

<p> 下面是对上述代码的含义进行介绍。<br>第一行代码是为FastCGI缓存指定一个文件路径、目录结构等级、关键字区域存储时间和非活动删除时间。<br>fastcgi_connect_timeout：指定连接到后端FastCGI的超时时间。<br>fastcgi_send_timeout：指定向FastCGI传送请求的超时时间，这个值是已经完成两次握手后向FastCGI传送请求的超时时间。<br>fastcgi_read_timeout：指定接收FastCGI应答的超时时间，这个值是已经完成两次握手后接收FastCGI应答的超时时间。<br>fastcgi_buffer_size：用于指定读取FastCGI应答第一部分需要用多大的缓冲区，这个值表示将使用1个64KB的缓冲区读取应答的第一部分（应答头），可以设置为fastcgi_buffers选项指定的缓冲区大小。<br>fastcgi_buffers：指定本地需要用多少和多大的缓冲区来缓冲FastCGI的应答请求。如果一个PHP脚本所产生的页面大小为256KB，那么会为其分配4个64KB的缓冲区来缓存；如果页面大小大于256KB，那么大于256KB的部分会缓存到fastcgi_temp指定的路径中，但是这并不是好方法，因为内存中的数据处理速度要快于硬盘。一般这个值应该为站点中PHP脚本所产生的页面大小的中间值，如果站点大部分脚本所产生的页面大小为256KB，那么可以把这个值设置为“16 16k”、“4 64k”等。<br>fastcgi_busy_buffers_size：的默认值是fastcgi_buffers的两倍。<br>fastcgi_temp_file_write_size：表示在写入缓存文件时使用多大的数据块，默认值是fastcgi_buffers的两倍。<br>fastcgi_cache：表示开启FastCGI缓存并为其指定一个名称。开启缓存非常有用，可以有效降低CPU的负载，并且防止502错误的发生，但是开启缓存也会引起很多问题，要视具体情况而定。<br>fastcgi_cache_valid：fastcgi用来指定应答代码的缓存时间，实例中的值表示将200和302应答缓存一个小时，将301应答缓存1天，其他应答均缓存1分钟。</p>
<p>rm /usr/local/nginx/html/index.html<br>echo “&lt;?php phpinfo(); ?&gt;” &gt;&gt; /usr/local/nginx/html/index.php</p>
<p>下载最新版本的Discuz论坛</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">yum install unzip </div><div class="line">mkdir temp</div><div class="line"><span class="built_in">cd</span> temp </div><div class="line">wget  http://download.comsenz.com/DiscuzX/<span class="number">3.2</span>/Discuz_X3.<span class="number">2</span>_SC_UTF8.zip</div><div class="line">unzip Discuz_X3.<span class="number">2</span>_SC_UTF8.zip</div><div class="line">cp -r upload /data/bbs</div><div class="line">chmod -R <span class="number">777</span>  /data/bbs/config</div><div class="line">chmod -R <span class="number">777</span>  /data/bbs/data</div><div class="line">chmod -R <span class="number">777</span>  /data/bbs/uc_client</div><div class="line">chmod -R <span class="number">777</span>  /data/bbs/uc_server</div></pre></td></tr></table></figure>


    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/01/09/Flask-extensions/">
  <time datetime="2015-01-09T07:21:23.000Z">
    1月 9 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/01/09/Flask-extensions/">Flask extensions 汇总</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>Flask 的扩张结构是在诞生的时候就确定了的。存在各种各样好用的扩张。<br>这里整理了一些常用的扩张：<br>1  Flask-script<br>给flask提供命令行选项，可以在shell里进行调试，测试工作。<br>pip install flask-scripts<br>from flask.ext.script import Manager<br>manager = Manager(app)<br>manager.run()</p>
<p>python test.py —help<br>python test.py shell<br>python test.py runserver -h 0.0.0.0 -p 5000</p>
<p>2 Flask-Bootstrap<br>pip install flask-bootstrap</p>
<p>from flask.ext.bootstrap import Bootstrap</p>
<p>bootstrap = Bootstrap(app)</p>
<p>user.html</p>
<p>3 Flask-Moment 时间日期本地格式化<br>pip install flask-moment</p>
<p>from flask.ext.moment import Moment<br>moment = Moment(app)</p>
<p>index.html</p>
<p>4 Flask-WTF Form表单<br>pip  install falsk-wtf</p>
<p>Form Classes 继承自Form<br>from flask.ext.wtf import Form<br>from wtforms import StringField,SubmitField<br>from wtform.validators import Rrquired</p>
<p>class NameForm(Form):<br>    name = StringField(‘What is your name?’,validators=[Required()])<br>    submit = SubmitField(‘Submit’)</p>
<p> StringField<br> TextAreaField<br> PasswordField<br> HiddenField<br> DateField<br> DateTimeField<br> IntegerField<br> DecimalField<br> FloatField<br> BooleanField<br> RadioField<br> SelectField<br> SelectMultipleField<br> FielField<br> SubmitField<br> FormField<br> FieldList</p>
<p>5 数据库<br>pip install flask-sqlalchemy<br>MySQL mysql://username:password@hostname/database</p>
<p>2 Login<br>3 Form</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/01/06/Flask-dev-setup/">
  <time datetime="2015-01-06T03:03:17.000Z">
    1月 6 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/01/06/Flask-dev-setup/">Flask 开发环境设置</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>Python web框架 Flask开发环境设置，引入venv虚拟环境，能很好的避免各程序版本冲突。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> ~</div><div class="line">mdkir weatherapp</div><div class="line"><span class="built_in">cd</span> weatherapp</div><div class="line">mkdir templates</div><div class="line">touch index.py</div><div class="line">touch templates/index.html</div></pre></td></tr></table></figure>

<p>安装虚拟环境virtualenv,Mac OS X 下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$sudo</span> easy_install virtualenv</div><div class="line"><span class="variable">$cd</span> weatherapp</div><div class="line"><span class="variable">$virtualenv</span> venv</div><div class="line">New python executable <span class="keyword">in</span> venv/bin/python2.<span class="number">7</span></div><div class="line">lso creating executable <span class="keyword">in</span> venv/bin/python</div><div class="line">Installing setuptools............done.</div><div class="line">Installing pip...............done.</div></pre></td></tr></table></figure>

<p>应用根目录会生成一个venv目录<br>激活venv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$source</span> venv/bin/activate</div><div class="line">(venv)$</div></pre></td></tr></table></figure>

<p>在venv下安装相关的软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(venv)<span class="variable">$pip</span> install flask</div><div class="line">(venv)<span class="variable">$python</span></div><div class="line">&gt;&gt;&gt;import falsk</div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>

<p>没有错误，就说明你的flask装好了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$vim</span> index.py</div><div class="line">from flask import Flask</div><div class="line">import os</div><div class="line">app = Flask(__name__)</div><div class="line">@app.route(<span class="string">"/"</span>)</div><div class="line">def index():</div><div class="line">    <span class="keyword">return</span> <span class="string">"Hello,World!"</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    port = int(os.environ.get(<span class="string">'PORT'</span>,<span class="number">5000</span>))</div><div class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=port,debug=True)</div></pre></td></tr></table></figure>

<p>运行flaskweb服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(venv)<span class="variable">$python</span> index.py</div><div class="line"> * Running on http://<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">5000</span>/</div><div class="line"> * Restarting with reloader</div></pre></td></tr></table></figure>

<p> 浏览器输入<a href="http://localhost:5000" target="_blank" rel="external">http://localhost:5000</a> 就可以看到你的helloworld页面了。</p>
<p>所有的Flask应用程序都需要创建一个app实例。服务响应客户端请求使用WSGI（Web Server Gateway Interace）。<br>路由和视图函数:<br>路由就是用来保持URL地址和函数的关系。可以使用装饰器@app.route 来暴露路由。URL 可以有静态和动态的方式声明。<br>/user/<name> ,/user/<int:id></int:id></name></p>
<p>模板<br>from flask import render_template</p>
<p>变量：<br> 变量<br>undefined 字典<br>undefined 列表<br>undefined 带变量的列表<br> 对象的方法<br> 管道： safe ,lower,upper,title,trim,striptags</p>
<p>控制:<br>判断：</p>
<pre><code><span class="variable">Hello</span>,<span class="variable">Stranger</span><span class="exclamation_mark">!</span>
</code></pre><p> 循环</p>
<p>‘’’bash<br> macro</p>
<p>‘’’</p>
<ul><br><br></ul>

<p>支持在外部文件定义：<br>‘’’bash<br>{ macros.render_ct(comment) }<br>‘’’<br>支持将重复的内容抽象，然后include</p>
<p>支持继承：</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/09/elk/">
  <time datetime="2014-12-09T08:20:40.000Z">
    12月 9 2014
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/09/elk/">（elk）ElasticSearch-Logstash-Kibana</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>ElasticSearch 是构建在Apache Lucene之上的的搜索引擎服务，开源（Apache2协议），分布式，RESTful，实时 可扩展。安装方便，使用简单。<br>Logstash 收集工作日志数据，处理并分析，有告警功能，有很多插件inputs filters outputs<br>Kibana  支持可视化数据，过滤，查询等功能</p>
<p>三者可以独立使用，也可以一起组合提供强大的功能。<br><img src="http://hzchenkj-github-io.qiniudn.com/elk.png" alt="elk"></p>
<p>可以方便的扩展：<br><img src="http://hzchenkj-github-io.qiniudn.com/elk-cluster.png" alt="elk-cluster"></p>
<h1 id="一、ElasticSearch">一、ElasticSearch</h1>
<p>需要Java环境，现在设置好Java 环境变量。测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$java</span> -version</div><div class="line">java version <span class="string">"1.6.0_25"</span></div><div class="line">Java(TM) SE Runtime Environment (build <span class="number">1.6</span>.<span class="number">0</span>_25-b06)</div><div class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">20.0</span>-b11, mixed mode)</div></pre></td></tr></table></figure>

<p>下载elasticsearch 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$wget</span>  https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-<span class="number">1.4</span>.<span class="number">1</span>.tar.gz</div><div class="line"><span class="variable">$tar</span> zxvf elasticsearch-<span class="number">1.4</span>.<span class="number">1</span>.tar.gz</div><div class="line"><span class="variable">$cd</span> elasticsearch-<span class="number">1.4</span>.<span class="number">1</span></div><div class="line">$ ls</div><div class="line">bin  config  data  lib  LICENSE.txt  logs  NOTICE.txt  plugins  README.textile</div></pre></td></tr></table></figure>

<p>bin 启动脚本<br>config 配置文件<br>data 默认数据目录<br>plugins  插件目录</p>
<p>可以零配置上使用<br>vi config/elasticsearch.yml </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#cluster.name: elasticsearch</span></div><div class="line"><span class="comment">#node.name: "Franz Kafka"</span></div><div class="line"><span class="comment">#path.data: /path/to/data</span></div></pre></td></tr></table></figure>

<p>启动elasticsearch </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> elasticsearch-<span class="number">1.3</span>.<span class="number">2</span> && bin/elasticsearch <span class="operator">-d</span></div><div class="line">curl -X GET http://localhost:<span class="number">9200</span>/</div><div class="line">{</div><div class="line">  <span class="string">"status"</span> : <span class="number">200</span>,</div><div class="line">  <span class="string">"name"</span> : <span class="string">"Mister Fear"</span>,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</div><div class="line">  <span class="string">"version"</span> : {</div><div class="line">    <span class="string">"number"</span> : <span class="string">"1.4.1"</span>,</div><div class="line">    <span class="string">"build_hash"</span> : <span class="string">"89d3241d670db65f994242c8e8383b169779e2d4"</span>,</div><div class="line">    <span class="string">"build_timestamp"</span> : <span class="string">"2014-11-26T15:49:29Z"</span>,</div><div class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">    <span class="string">"lucene_version"</span> : <span class="string">"4.10.2"</span></div><div class="line">  },</div><div class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p>安装web管理界面插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bin/plugin -i elasticsearch/marvel/latest</div></pre></td></tr></table></figure>

<p>浏览器访问<br><a href="http://localhost:9200/_plugin/marvel/" target="_blank" rel="external">http://localhost:9200/_plugin/marvel/</a></p>
<h1 id="二、Logstash">二、Logstash</h1>
<h1 id="三、Kibana">三、Kibana</h1>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  

  <nav id="pagination">
  
  
    <a href="/archives/page/2/" class="next">下一页</a>
  
  <div class="clearfix"></div>
</nav>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2016 <a href="/">hzchenkj</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="http://ajax.useso.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'hzchenkj' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>


</body>
</html>