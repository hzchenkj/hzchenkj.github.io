<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>归档: 2015/12 | LinuxCoffee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="hzchenkj">
  
  
  <meta name="description" content="GNU/Linux | Java | Python | Docker | Shell">
<meta property="og:type" content="website">
<meta property="og:title" content="LinuxCoffee">
<meta property="og:url" content="http://hzchenkj.github.com/archives/2015/12/">
<meta property="og:site_name" content="LinuxCoffee">
<meta property="og:description" content="GNU/Linux | Java | Python | Docker | Shell">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LinuxCoffee">
<meta name="twitter:description" content="GNU/Linux | Java | Python | Docker | Shell">

  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">LinuxCoffee</a></h1>
    <p><a href="/">东写西读</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/reading">Reading</a></li>
      
        <li><a href="/about">About</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content">


<h2 class="archives-title"><span>2015</span></h2>



  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/12/07/linux_bonding_xen_kvm/">
  <time datetime="2015-12-07T13:06:16.000Z">
    12月 7 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/12/07/linux_bonding_xen_kvm/"></a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="Linux_双网卡绑定bonding">Linux 双网卡绑定bonding</h1>
<p>环境：</p>
<h2 id="CentOS_5系列_+_Xen">CentOS 5系列 + Xen</h2>
<h3 id="1_双网卡绑定_，产生bond0_接口">1 双网卡绑定 ，产生bond0 接口</h3>
<p>脚本如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="xml">cp /etc/sysconfig/network-scripts/ifcfg-eth1 /etc/sysconfig/network-scripts/ifcfg-eth1.bak </span></div><div class="line">cat &gt; /etc/sysconfig/network-scripts/ifcfg-eth1 <span class="tag">&lt;&lt;<span class="attribute">EOF</span> </span></div><div class="line"><span class="attribute">DEVICE</span>=<span class="value">eth1</span> </div><div class="line"><span class="attribute">USERCTL</span>=<span class="value">no</span> </div><div class="line"><span class="attribute">BOOTPROTO</span>=<span class="value">none</span> </div><div class="line"><span class="attribute">ONBOOT</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">MASTER</span>=<span class="value">bond0</span> </div><div class="line"><span class="attribute">SLAVE</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">TYPE</span>=<span class="value">Ethernet</span></div><div class="line"></div><div class="line"><span class="attribute">EOF</span></div><div class="line"></div><div class="line"><span class="attribute">cp</span> /<span class="attribute">etc</span>/<span class="attribute">sysconfig</span>/<span class="attribute">network-scripts</span>/<span class="attribute">ifcfg-eth2</span> /<span class="attribute">etc</span>/<span class="attribute">sysconfig</span>/<span class="attribute">network-scripts</span>/<span class="attribute">ifcfg-eth2.bak</span> </div><div class="line"><span class="attribute">cat</span> &gt; /etc/sysconfig/network-scripts/ifcfg-eth2 <span class="tag">&lt;&lt;<span class="attribute">EOF</span> </span></div><div class="line"><span class="attribute">DEVICE</span>=<span class="value">eth2</span> </div><div class="line"><span class="attribute">USERCTL</span>=<span class="value">no</span> </div><div class="line"><span class="attribute">BOOTPROTO</span>=<span class="value">none</span> </div><div class="line"><span class="attribute">ONBOOT</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">MASTER</span>=<span class="value">bond0</span> </div><div class="line"><span class="attribute">SLAVE</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">TYPE</span>=<span class="value">Ethernet</span></div><div class="line"></div><div class="line"><span class="attribute">EOF</span></div><div class="line"></div><div class="line"><span class="attribute">cat</span> &gt;/etc/sysconfig/network-scripts/ifcfg-bond0 <span class="tag">&lt;&lt; <span class="attribute">EOF</span> </span></div><div class="line"><span class="attribute">DEVICE</span>=<span class="value">bond0</span> </div><div class="line"><span class="attribute">BOOTPROTO</span>=<span class="value">none</span> </div><div class="line"><span class="attribute">IPADDR</span>=<span class="value">192.168.10.xx</span> </div><div class="line"><span class="attribute">NETMASK</span>=<span class="value">255.255.255.0</span> </div><div class="line"><span class="attribute">NETWORK</span>=<span class="value">192.168.10.254</span> </div><div class="line"><span class="attribute">USERCTL</span>=<span class="value">no</span> </div><div class="line"><span class="attribute">ONBOOT</span>=<span class="value">yes</span> </div><div class="line"><span class="attribute">TYPE</span>=<span class="value">Ethernet</span></div><div class="line"></div><div class="line"><span class="attribute">EOF</span></div></pre></td></tr></table></figure>

<h3 id="2_修改xen配置文件">2 修改xen配置文件</h3>
<p>/etc/xen/xend-config.sxp</p>
<p>(network-script ‘network-bridge netdev=bond0’)</p>
<p>使xen使用bond0 接口,默认生成xenbr0 的接口<br>或者</p>
<p>(network-script ‘network-bridge bridge=xenbr1 netdev=bond0’)</p>
<p>指定桥接的接口</p>
<p>原来的虚拟机是使用了多网卡 桥接的脚本<br>/etc/xen/xend-config.sxp</p>
<p>(network-script multi_bridge)</p>
<p>/etc/xen/scripts/multi_bridge</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/bash</span></div><div class="line">dir=$(dirname <span class="string">"<span class="variable">$0</span>"</span>)</div><div class="line"><span class="string">"<span class="variable">$dir</span>/network-bridge"</span> <span class="string">"<span class="variable">$@</span>"</span> vifnum=<span class="number">0</span> netdev=eth0 bridge=xenbr0</div><div class="line"><span class="string">"<span class="variable">$dir</span>/network-bridge"</span> <span class="string">"<span class="variable">$@</span>"</span> vifnum=<span class="number">1</span> netdev=eth1 bridge=xenbr1</div><div class="line"><span class="string">"<span class="variable">$dir</span>/network-bridge"</span> <span class="string">"<span class="variable">$@</span>"</span> vifnum=<span class="number">2</span> netdev=eth2 bridge=xenbr2</div><div class="line"><span class="string">"<span class="variable">$dir</span>/network-bridge"</span> <span class="string">"<span class="variable">$@</span>"</span> vifnum=<span class="number">3</span> netdev=eth3 bridge=xenbr3</div></pre></td></tr></table></figure>

<p>修改使用bond0</p>
<p>sed -i ‘s/eth1/bond0/g’ /etc/xen/scripts/multi_bridge sed -i ‘5,6s/^/#/‘ /etc/xen/scripts/multi_bridge</p>
<h3 id="3_domainU_配置文件">3 domainU 配置文件</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="variable">name =</span> <span class="string">"domain-1"</span></div><div class="line"><span class="variable">uuid =</span> <span class="string">"a5b43314-cd35-74e3-a357-4290768b7599"</span></div><div class="line"><span class="variable">maxmem =</span> <span class="number">8192</span></div><div class="line"><span class="variable">memory =</span> <span class="number">8192</span></div><div class="line"><span class="variable">vcpus =</span> <span class="number">6</span></div><div class="line"><span class="variable">bootloader =</span> <span class="string">"/usr/bin/pygrub"</span></div><div class="line"><span class="variable">on_poweroff =</span> <span class="string">"destroy"</span></div><div class="line"><span class="variable">on_reboot =</span> <span class="string">"restart"</span></div><div class="line"><span class="variable">on_crash =</span> <span class="string">"restart"</span></div><div class="line"><span class="variable">vfb =</span> [ <span class="string">"type=vnc,vncunused=1,keymap=en-us"</span>  ]</div><div class="line"><span class="variable">disk =</span> [ <span class="string">"tap:aio:/data/xenserver/domain-1/domain-1.img,xvda,w"</span>  ]</div><div class="line"><span class="variable">vif =</span> [ <span class="string">"mac=00:16:3e:37:02:c7,bridge=xenbr0,script=vif-bridge"</span>, <span class="string">"mac=00:16:36:18:22:f1,bridge=xenbr1,script=vif-bridge"</span>  ]</div></pre></td></tr></table></figure>

<h3 id="4_修改内核加载参数，使之生效">4 修改内核加载参数，使之生效</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cp</span> /etc/modprobe.<span class="keyword">conf</span> /etc/modprobe.<span class="keyword">conf</span>.bak </div><div class="line"><span class="keyword">cat</span> &gt;&gt; /etc/modprobe.<span class="keyword">conf</span> &lt;&lt; EOF</div><div class="line">alias bond0 bonding </div><div class="line"><span class="keyword">options</span> bond0 miimon=<span class="number">100</span> <span class="built_in">mode</span>=<span class="number">0</span></div><div class="line"></div><div class="line">EOF</div></pre></td></tr></table></figure>

<p>xen方式需要重启机器，才能保证双网卡绑定正常<br>加载绑定模块<br>modprobe bonding</p>
<p>xen 在重启完后，会生成一个pbond0 的接口</p>
<p>cat /proc/net/bonding/pbond0</p>
<h2 id="CentOS_6系列_+_KVM">CentOS 6系列 + KVM</h2>
<h3 id="ifcfg-bond0">ifcfg-bond0</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="setting">DEVICE=<span class="value">bond0</span></span></div><div class="line"><span class="setting">BOOTPROTO=<span class="value">static</span></span></div><div class="line"><span class="setting">BRIDGE=<span class="value">br0</span></span></div><div class="line"><span class="setting">NM_CONTROLLED=<span class="value"><span class="keyword">no</span></span></span></div><div class="line"><span class="setting">ONBOOT=<span class="value"><span class="keyword">yes</span></span></span></div></pre></td></tr></table></figure>

<h3 id="ifcfg-br0">ifcfg-br0</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="setting">DEVICE=<span class="value">br0</span></span></div><div class="line"><span class="setting">TYPE=<span class="value">Bridge</span></span></div><div class="line"><span class="setting">BOOTPROTO=<span class="value">static</span></span></div><div class="line"><span class="setting">ONBOOT=<span class="value"><span class="keyword">yes</span></span></span></div><div class="line"><span class="setting">IPADDR=<span class="value"><span class="number">192.168</span>.<span class="number">11.110</span></span></span></div><div class="line"><span class="setting">NETMASK=<span class="value"><span class="number">255.255</span>.<span class="number">255.0</span></span></span></div><div class="line"><span class="setting">GATEWAY=<span class="value"><span class="number">192.168</span>.<span class="number">11.254</span></span></span></div><div class="line"><span class="setting">MTU=<span class="value"><span class="number">1500</span></span></span></div><div class="line"><span class="setting">SLAVE=<span class="value">bond0</span></span></div><div class="line"><span class="setting">NM_CONTROLLED=<span class="value"><span class="keyword">no</span></span></span></div><div class="line"><span class="setting">PEERDNS=<span class="value"><span class="keyword">no</span></span></span></div></pre></td></tr></table></figure>

<p>vi /etc/libvirt/qemu/domain-1.xml</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;interface <span class="class"><span class="keyword">type</span></span>=<span class="string">'bridge'</span>&gt;</div><div class="line">      &lt;mac address=<span class="string">'52:54:31:b3:73:31'</span>/&gt;</div><div class="line">      &lt;source bridge=<span class="string">'br0'</span>/&gt;</div><div class="line">      &lt;model <span class="class"><span class="keyword">type</span></span>=<span class="string">'virtio'</span>/&gt;</div><div class="line">      &lt;address <span class="class"><span class="keyword">type</span></span>=<span class="string">'pci'</span> domain=<span class="string">'0x0000'</span> bus=<span class="string">'0x00'</span> slot=<span class="string">'0x03'</span> <span class="keyword">function</span>=<span class="string">'0x0'</span>/&gt;</div><div class="line">&lt;/interface&gt;</div></pre></td></tr></table></figure>

<h2 id="多个bonding">多个bonding</h2>
<h3 id="修改内核模块">修改内核模块</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cat</span> &gt;&gt; /etc/modprobe.<span class="keyword">conf</span> &lt;&lt; EOF</div><div class="line">alias bond0 bonding </div><div class="line"><span class="keyword">options</span> bond0 miimon=<span class="number">100</span> <span class="built_in">mode</span>=<span class="number">0</span></div><div class="line"></div><div class="line">alias bond1 bonding </div><div class="line"><span class="keyword">options</span> bond1 miimon=<span class="number">100</span> <span class="built_in">mode</span>=<span class="number">0</span></div><div class="line">EOF</div></pre></td></tr></table></figure>

<p>modprobe bonding</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/12/07/saltstack/">
  <time datetime="2015-12-07T13:05:40.000Z">
    12月 7 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/12/07/saltstack/"></a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="SaltStack">SaltStack</h1>
<p>saltstack</p>
<h2 id="安装配置测试">安装配置测试</h2>
<h3 id="salt-master">salt-master</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="operator"><span class="keyword">install</span> -y salt-<span class="keyword">master</span></span></div></pre></td></tr></table></figure>

<p>修改配置文件 /etc/salt/master </p>
<p>默认不用修改（KISS）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#interface: 0.0.0.0</span></div></pre></td></tr></table></figure>

<p>启动 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">service</span> <span class="title">salt</span>-master restart</span></div></pre></td></tr></table></figure>

<p>查看端口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -lntp|<span class="keyword">grep</span> <span class="number">4505</span></div></pre></td></tr></table></figure>

<h3 id="salt-minion">salt-minion</h3>
<p>安装</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum <span class="operator"><span class="keyword">install</span> -y salt-minion</span></div></pre></td></tr></table></figure>

<p>配置</p>
<p>/etc/salt/minion</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">master</span>: <span class="string">192.168.4.201</span></div></pre></td></tr></table></figure>

<p>启动minion</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">service</span> <span class="title">salt</span>-minion start</span></div></pre></td></tr></table></figure>

<p>查看端口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstnt -lntp|<span class="keyword">grep</span> <span class="number">4506</span></div></pre></td></tr></table></figure>

<h3 id="salt_master_为salt_minion_授权">salt master 为salt minion 授权</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#salt-key -L </span></div><div class="line">salt-key <span class="operator">-a</span> test.*.com</div></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt <span class="keyword">test</span>.*<span class="string">.com</span> <span class="keyword">test</span>.ping</div></pre></td></tr></table></figure>

<p>防火墙 master</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="literal">-</span><span class="comment">A</span> <span class="comment">INPUT</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">state</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">state</span> <span class="comment">new</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">dport</span> <span class="comment">4505</span> <span class="literal">-</span><span class="comment">j</span> <span class="comment">ACCEPT</span></div><div class="line"><span class="literal">-</span><span class="comment">A</span> <span class="comment">INPUT</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">state</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">state</span> <span class="comment">new</span> <span class="literal">-</span><span class="comment">m</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">tcp</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">dport</span> <span class="comment">4506</span> <span class="literal">-</span><span class="comment">j</span> <span class="comment">ACCEPT</span></div></pre></td></tr></table></figure>




<h2 id="规范">规范</h2>
<p>主机名</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">&lt;app&gt;</span>-<span class="variable">&lt;001&gt;</span>-<span class="variable">&lt;sjc|fd|inner&gt;</span>-<span class="variable">&lt;11|12|201|204&gt;</span>-<span class="variable">&lt;ip&gt;</span>.<span class="keyword">*</span>.com</div><div class="line"></div><div class="line">kvmguest-002-inner-2-32.<span class="keyword">*</span>.com</div><div class="line">kvmguest-inner-192-168-2-32.<span class="keyword">*</span>.com</div></pre></td></tr></table></figure>

<p>/etc/hosts</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">127.0.0.1 localhost </span></span></div><div class="line">&lt;ip&gt; hostname</div></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span>.<span class="number">0.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</div><div class="line"><span class="number">192.168</span>.<span class="number">2.32</span>  kvmguest-<span class="number">002</span>-inner-<span class="number">2</span>-<span class="number">32</span>.*.<span class="keyword">com</span> kvmguest-<span class="number">002</span>-inner-<span class="number">2</span>-<span class="number">32</span></div></pre></td></tr></table></figure>

<h2 id="远程命令_remote_command">远程命令 remote command</h2>
<p>minon</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="title">salt</span> <span class="string">'*'</span> test.ping</div><div class="line">salt <span class="string">'myminion'</span> sys.list_functions test</div><div class="line">salt <span class="string">'*'</span> sys.doc test.fib</div><div class="line">salt <span class="string">'*'</span> test.fib <span class="number">30</span></div><div class="line">salt <span class="string">'*'</span> sys.doc test</div><div class="line">salt <span class="string">'*'</span> sys.list_functions sys</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo salt <span class="string">'*'</span> cmd.run_all <span class="string">'echo HELLO'</span></div><div class="line">sudo salt --<span class="keyword">out</span>=<span class="keyword">nested</span> <span class="string">'*'</span> cmd.run_all <span class="string">'echo HELLO'</span></div><div class="line">salt --<span class="keyword">out</span>=raw <span class="string">'*'</span> cmd.run_all <span class="string">'echo HELLO'</span></div><div class="line">salt --<span class="keyword">out</span>=json <span class="string">'*'</span> cmd.run_all <span class="string">'echo HELLO'</span></div><div class="line">--<span class="keyword">out</span>=yaml</div><div class="line">--<span class="keyword">out</span>=quiet</div></pre></td></tr></table></figure>

<h3 id="Targeting_strings">Targeting strings</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'myminion'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'my*'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'my*mini*'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'??minion'</span> test.ping</div><div class="line"><span class="built_in">sudo</span> salt <span class="string">'[a-m]yminion'</span> test.ping</div></pre></td></tr></table></figure>

<h3 id="Perl-compatible_regular_expression_matching_PCRE">Perl-compatible regular expression matching PCRE</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">salt -<span class="keyword">E</span> <span class="string">'myminion'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'my'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'my.*n'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'^myminion$'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'((my)|(your))minion'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'myminion(s)?'</span> test.ping</div><div class="line">salt -<span class="keyword">E</span> <span class="string">'(my)?minion'</span> test.ping</div></pre></td></tr></table></figure>

<h3 id="List_matching">List matching</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="title">salt</span> -L <span class="string">'myminion'</span> test.ping</div><div class="line">salt -L <span class="string">'myminion,yourminion,theirminion'</span> test.ping</div></pre></td></tr></table></figure>

<p>Grains<br>Grains represent static data describing a minion.<br>Pillars<br>Pillar data is similar to grains except that it can be defined more dynamically and is<br>a secure store for data. </p>
<h3 id="Grain_and_pillar_matching">Grain and pillar matching</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> grains.<span class="keyword">item</span> os_family</div><div class="line">salt <span class="string">'*'</span> grains.<span class="keyword">item</span> os</div><div class="line">salt <span class="string">'*'</span> grains.<span class="keyword">item</span> osfinger</div><div class="line">salt <span class="comment">--grain 'os_family:RedHat' test.ping</span></div><div class="line">salt -G <span class="string">'os:Ubuntu'</span> test.ping</div><div class="line">salt -G <span class="string">'os:u*'</span> test.ping</div><div class="line">salt <span class="string">'*'</span> grains.<span class="keyword">items</span></div></pre></td></tr></table></figure>

<p>设置变量</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> <span class="transposed_variable">grains.</span>setval foo bar</div><div class="line">salt <span class="string">'*'</span> <span class="transposed_variable">grains.</span>item foo</div><div class="line">salt <span class="string">'*'</span> <span class="transposed_variable">grains.</span>setval baz <span class="string">'["</span>larry<span class="string">", "</span>moe<span class="string">", "</span>curly<span class="string">"]'</span></div><div class="line">salt <span class="string">'*'</span> <span class="transposed_variable">grains.</span>delval baz</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># cat /etc/salt/grains</div><div class="line">baz:</div><div class="line">-<span class="ruby"> larry</span></div><div class="line">-<span class="ruby"> moe</span></div><div class="line">-<span class="ruby"> curly</span></div><div class="line">foo: bar</div></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*.baz.com'</span> test.ping</div><div class="line">  </div><div class="line">salt -E <span class="string">'web-(prod|dev)'</span> test.ping</div><div class="line">  </div><div class="line">salt -L <span class="string">'web-jonh, dborac-ether'</span> test.ping</div><div class="line">  </div><div class="line"><span class="preprocessor"># By grains, target the RedHat and Debian systems</span></div><div class="line">salt -G <span class="string">'os:(RedHat|Debian)'</span> test.ping</div><div class="line">  </div><div class="line"><span class="preprocessor"># By Pillar data, target human resources</span></div><div class="line">salt -I <span class="string">'deparment:HR'</span> test.ping</div><div class="line">  </div><div class="line"><span class="preprocessor"># By IP/subnet, target the local network </span></div><div class="line">salt -S <span class="string">'192.16.0.0/24'</span> test.ping</div></pre></td></tr></table></figure>

<h3 id="Compound_matching">Compound matching</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># By minion ID and grains</span></div><div class="line"><span class="title">salt</span> -C <span class="string">'web-* and G<span class="variable">@os</span>:Ubuntu'</span> test.ping</div><div class="line">  </div><div class="line"><span class="comment"># By grains and Pillar data</span></div><div class="line">salt -C <span class="string">'G<span class="variable">@cpuarch</span>:x86_64 and I<span class="variable">@office</span>:32D'</span> test.ping</div><div class="line"></div><div class="line">salt -C <span class="string">'*minion and G<span class="variable">@os</span>:Ubuntu and not L<span class="variable">@yourminion</span>,theirminion'</span></div><div class="line">test.ping</div><div class="line"></div><div class="line">salt -C <span class="string">'* and not G<span class="variable">@os_family</span>:RedHat'</span> test.ping</div><div class="line"></div><div class="line">salt -C <span class="string">'G<span class="variable">@os</span>:Ubuntu or G<span class="variable">@os</span>:Fedora'</span> test.ping</div></pre></td></tr></table></figure>



<p>组合</p>
<table>
<thead>
<tr>
<th>Letter</th>
<th>Match Type</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>G</td>
<td>Grains glob</td>
<td>G@os:Ubuntu</td>
<td></td>
</tr>
<tr>
<td>E</td>
<td>PCRE minion ID</td>
<td>E@web\d+.(dev\</td>
<td>qa\</td>
<td>prod).loc</td>
<td></td>
</tr>
<tr>
<td>P</td>
<td>Grains PCRE</td>
<td>P@os:(RedHat\</td>
<td>Fedora\</td>
<td>CentOS)</td>
<td></td>
</tr>
<tr>
<td>L</td>
<td>List of minions</td>
<td>L@minion1.example.com, minion3.domain.com</td>
<td></td>
</tr>
<tr>
<td>I</td>
<td>Pillar glob</td>
<td>I@pdata:foobar</td>
<td></td>
</tr>
<tr>
<td>S</td>
<td>Subnet/IP address</td>
<td>S@192.168.1.0/24 or S@192.168.1.100</td>
<td></td>
</tr>
<tr>
<td>R</td>
<td>Range cluster</td>
<td>R@%foo.bar</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="Remote_execution_modules_and_functions">Remote execution modules and functions</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="class"><span class="keyword">module</span>&gt;.<span class="inheritance">&lt;<span class="parent">function</span></span>&gt;</span></div><div class="line">test.ping</div></pre></td></tr></table></figure>




<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">salt</span> <span class="string">'*'</span> sys.list_modules</div></pre></td></tr></table></figure>



<p> 常用模块</p>
<h3 id="用户管理">用户管理</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">salt '<span class="keyword">*</span>' sys.doc user.add</div><div class="line">salt '<span class="keyword">*</span>' user.add name <span class="variable">&lt;uid&gt;</span> <span class="variable">&lt;gid&gt;</span> <span class="variable">&lt;groups&gt;</span> <span class="variable">&lt;home&gt;</span> <span class="variable">&lt;shell&gt;</span></div><div class="line">salt '<span class="keyword">*</span>' user.add larry</div><div class="line">salt '<span class="keyword">*</span>' user.info larry</div></pre></td></tr></table></figure>


<h3 id="安装包">安装包</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> sys.doc pkg.install</div><div class="line">salt <span class="string">'*'</span> pkg.install httpd</div><div class="line">salt <span class="string">'*'</span> pkg.<span class="keyword">version</span> nano</div><div class="line">salt <span class="string">'*'</span> pkg.list_pkgs --out=json</div><div class="line">salt <span class="string">'*'</span> pkg.<span class="built_in">remove</span> htop</div></pre></td></tr></table></figure>

<h3 id="管理服务">管理服务</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> service.status httpd</div><div class="line">salt <span class="string">'*'</span> service.<span class="keyword">stop</span> apache2</div></pre></td></tr></table></figure>

<h3 id="监控minion状态">监控minion状态</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="title">salt</span> <span class="string">'*'</span> status.diskusage</div><div class="line">salt <span class="string">'*'</span> status.loadavg</div><div class="line">salt <span class="string">'*'</span> status.meminfo</div><div class="line">salt <span class="string">'*'</span> status.uptime</div></pre></td></tr></table></figure>

<h3 id="运行命令">运行命令</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">salt <span class="string">'*'</span> cmd.run <span class="string">'echo Hello!'</span></div><div class="line">salt <span class="string">'*'</span> cmd.run_stderr <span class="string">'echo Hello!'</span></div><div class="line">salt <span class="string">'*'</span> cmd.retcode <span class="string">'echo Hello!'</span></div><div class="line">salt <span class="string">'*'</span> cmd.run_all <span class="string">'echo Hello!'</span></div><div class="line">cmd.script <span class="keyword">sh</span>脚本</div></pre></td></tr></table></figure>


<h2 id="state">state</h2>
<p>对基础服务的管理包括配置管理系统、用户账号管理、yum配置管理、hosts文件管理、时间同步管理、DNS配置管理。</p>
<h3 id="配置管理系统">配置管理系统</h3>
<p>配置管理系统使用模块化设计，</p>
<p>每个服务一个模块，<br>将多个模块组织到一起形成角色（/srv/salt/roles/）。</p>
<p>所有模块放置到：/srv/salt下，<br>入口配置文件为：/srv/salt/top.sls。</p>
<p>模块使用的变量放置到：/srv/pillar，<br>入口配置文件：/srv/pillar/top.sls。</p>
<p>针对变量的作用域不同，将变量分为三级：</p>
<p>一级应用于模块（/srv/pillar/模块名），</p>
<p>一级应用于角色（/srv/pillar/roles/），</p>
<p>一级应用于主机节点（/srv/pillar/nodes）。</p>
<p>入口配置/srv/salt/top.sls，直接引用各种角色：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">base:  </div><div class="line">  '*':  </div><div class="line">    -<span class="ruby"> roles.common  </span></div><div class="line">  'admin.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.admin  </span></div><div class="line">  'ha.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.ha  </span></div><div class="line">  'web*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.web  </span></div><div class="line">  'cache*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.cache  </span></div><div class="line">  'mc*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.mc  </span></div><div class="line">  'db*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.db  </span></div><div class="line">  'search*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.search  </span></div><div class="line">  'storage*'.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.storage</span></div></pre></td></tr></table></figure>

<p>变量入口配置文件/srv/pillar/top.sls：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">base:  </div><div class="line">  '*':  </div><div class="line">    -<span class="ruby"> roles.common  </span></div><div class="line">  # 引用角色级变量  </div><div class="line">  # 模块级变量在角色级变量中引用  </div><div class="line">  'admin.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.admin  </span></div><div class="line">  'ha.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.ha  </span></div><div class="line">  'web*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.web  </span></div><div class="line">  'cache*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.cache  </span></div><div class="line">  'mc*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.mc  </span></div><div class="line">  'db*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.db  </span></div><div class="line">  'search*.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.search  </span></div><div class="line">  'storage*'.grid.mall.com':  </div><div class="line">    -<span class="ruby"> roles.storage  </span></div><div class="line">  # 引用节点级变量</div><div class="line">  'ha1.grid.mall.com':  </div><div class="line">    -<span class="ruby"> nodes.ha1  </span></div><div class="line">  'ha2.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.ha2  </span></div><div class="line">  'mc1.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.mc1  </span></div><div class="line">  'mc2.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.mc2  </span></div><div class="line">  'db1.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.db1  </span></div><div class="line">  'db2.grid.mall.com':</div><div class="line">    -<span class="ruby"> nodes.db2</span></div></pre></td></tr></table></figure>

<p>用户账号管理<br>用户管理模块：/srv/salt/users</p>
<p>pillar和grains都可以用来获取变量</p>
<p>grains偏向于获取客户端相关信息，比如客户端硬件架构、cpu核数、操作系统版本等信息，相当于puppet的facter；</p>
<p>pillar用于定义用户变量，通过pillar变量的传递，使salt state模块易于重用，相当于puppet的hiera。</p>
<p>使用pillar变量之前需要执行salt ‘*’ saltutil.refresh_pillar命令使变量生效。</p>
<p>使用命令salt ‘admin.grid.mall.com’ pillar.item users获取users变量：</p>
<p>/srv/salt/users/user.sls用于管理用户</p>
<h3 id="Saltstack：服务部署">Saltstack：服务部署</h3>
<h2 id="API_(http_restful)">API (http restful)</h2>
<h3 id="salt_—versions-report">salt —versions-report</h3>
<h3 id="Specify_an_sls_file">Specify an sls file</h3>
<p>We can also specify an sls file. Sls files don’t normally use execution modules, and instead use state modules that are called automagically by Salt when it processes the state, although there is a special state module to call execution modules from within sls files. More on writing states in a minute:</p>
<h1 id="Apply_the_states_from_the_ssh-sls_file_on_all_minions-">Apply the states from the ssh.sls file on all minions.</h1>
<h1 id="Notice_how_we_omit_the_-sls_extension_in_the_command_line-">Notice how we omit the .sls extension in the command line.</h1>
<p>  salt ‘*’ state.sls ssh</p>
<p>salt -N ‘logs_wpk’   state.highstate<br>salt kvmguest-001-sjc-13-33.<em>.com  state.highstate<br>salt kvmguest-001-sjc-13-33.</em>.com  state.sls base.zabbix</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/12/07/zabbix-api/">
  <time datetime="2015-12-07T13:04:30.000Z">
    12月 7 2015
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/12/07/zabbix-api/"></a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="zabbix_api">zabbix api</h1>
<h2 id="简介">简介</h2>
<p>zabbix api 为批量操作，第三方软件集成及其他作用提供可编程接口。</p>
<p>zabbix api 在1.8版本以后开始提供，zabbix移动客户端和原生的web前端部分都是建立在zabbix api上。zabbix api中间件使得架构更加模块化并避免对数据库进行操作。允许你使用JSON RPC协议来创建、更新和获取zabbix 对象并操作（认证你的账户）。</p>
<p>zabbix api 提供两项功能：</p>
<ol>
<li>远程管理zabbix 配置</li>
<li>远程检索配置和历史数据</li>
</ol>
<h2 id="zabbix_API开发库">zabbix API开发库</h2>
<p>zabbix API请求和响应都是json，并且还提供了各种语法的lib库，<a href="http://zabbix.org/wiki/Docs/api/libraries" target="_blank" rel="external">http://zabbix.org/wiki/Docs/api/libraries</a>，包含php、c#、Python、Perl、go等等语言</p>
<h2 id="使用JSON">使用JSON</h2>
<p>采用JSON RPC协议实现。调用任何函数，都要发送POST请求，输入输出都是JSON格式。<br>工作方式如下：</p>
<ol>
<li>准备JSON对象，描述你想要做什么(创建主机，获取图像，更新监控项)</li>
<li>采用POST方式 <a href="http://zabbix.*.info/zabbix/api_jsonrpc.php发送此JSON对象" target="_blank" rel="external">http://zabbix.*.info/zabbix/api_jsonrpc.php发送此JSON对象</a>. <a href="http://example.com/zabbix/是Zabbix前端地址。api_jsonrpc.php是调用API的PHP脚本。可在安装可视化前端的目录下找到。" target="_blank" rel="external">http://example.com/zabbix/是Zabbix前端地址。api_jsonrpc.php是调用API的PHP脚本。可在安装可视化前端的目录下找到。</a></li>
<li>获取json响应格式</li>
</ol>
<blockquote>
<p>请求方法必须是POST方法，HTTP Header  Content-Type  必须为【application/jsonrequest，application/json-rpc，application/json】其中之一</p>
</blockquote>
<h2 id="基本请求格式">基本请求格式</h2>
<p>JSON 请求如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">    "<span class="attribute">jsonrpc</span>": <span class="value"><span class="string">"2.0"</span></span>,</div><div class="line">    "<span class="attribute">method</span>": <span class="value"><span class="string">"method.name"</span></span>, </div><div class="line">    "<span class="attribute">params</span>": <span class="value">{</span></div><div class="line">        "<span class="attribute">param_1_name</span>": <span class="value"><span class="string">"param_1_value"</span></span>,</div><div class="line">        "<span class="attribute">param_2_name</span>": <span class="value"><span class="string">"param_2_value"</span> </span></div><div class="line">    },</div><div class="line">    "<span class="attribute">id</span>": <span class="value"><span class="number">1</span></span>,</div><div class="line">    "<span class="attribute">auth</span>": <span class="value"><span class="string">"159121b60d19a9b4b55d49e30cf12b81"</span></span>,</div><div class="line">}</div></pre></td></tr></table></figure>

<ol>
<li>json rpc协议版本</li>
<li>具体执行的操作 如:host.create item.update</li>
<li>传递json对象来作为参数,如创建监控项 ，name 和key是必须的。</li>
<li>id  1  绑定json请求和响应</li>
<li>auth  认证令牌  </li>
</ol>
<h2 id="API_使用">API 使用</h2>
<p>1 登录</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">curl -i -X POST -H 'Content-Type: application/json' -d '{<span class="string">"jsonrpc"</span>:<span class="string">"2.0"</span>,<span class="string">"method"</span>:<span class="string">"user.login"</span>,<span class="string">"params"</span>:{<span class="string">"user"</span>:<span class="string">"***"</span>,<span class="string">"password"</span>:<span class="string">"***"</span>},<span class="string">"auth"</span>:null,<span class="string">"id"</span>:0}' http://zabbix.<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.info/api_jsonrpc.php</div></pre></td></tr></table></figure>

<p>2 获取主机</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST -H 'Content-Type: application/json' -d '{<span class="string">"jsonrpc"</span>:<span class="string">"2.0"</span>,<span class="string">"method"</span>:<span class="string">"host.get"</span>,<span class="string">"params"</span>:{<span class="string">"output"</span>:[<span class="string">"hostid"</span>,<span class="string">"name"</span>],<span class="string">"filter"</span>:{<span class="string">"host"</span>:<span class="string">""</span>}},<span class="string">"auth"</span>:<span class="string">"22ad296ae1ac36a07d16ea91d7af7227"</span>,<span class="string">"id"</span>:1}' http://zabbix.<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.info/api_jsonrpc.php</div></pre></td></tr></table></figure>

<p>3 获取监控主机的hostids</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST -H 'Content-Type: application/json' -d '{<span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,<span class="string">"method"</span>:<span class="string">"host.get"</span>,<span class="string">"params"</span>:{<span class="string">"output"</span>:[<span class="string">"hostid"</span>],<span class="string">"filter"</span>: {<span class="string">"host"</span>:<span class="string">"192.168.11.1"</span>}},<span class="string">"auth"</span>: <span class="string">"22ad296ae1ac36a07d16ea91d7af7227"</span>,<span class="string">"id"</span>: <span class="number">0</span>}' http:<span class="comment">//x.x.x.x/api_jsonrpc.php</span></div><div class="line">#<span class="string">"hostid"</span>:<span class="string">"10243"</span></div></pre></td></tr></table></figure>

<p>（3）获得监控项itemids</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST -H 'Content-Type: application/json' -d '{<span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,<span class="string">"method"</span>:<span class="string">"item.get"</span>,<span class="string">"params"</span>:{<span class="string">"output"</span>:<span class="string">"itemids"</span>,<span class="string">"hostids"</span>:<span class="string">"10243"</span>,<span class="string">"search"</span>:{<span class="string">"key_"</span>:<span class="string">"system.cpu.util</span></div><div class="line">[,idle,avg1]"}},<span class="string">"auth"</span>: <span class="string">"a826fca79a0795ccc1224dc76329972f"</span>,<span class="string">"id"</span>: <span class="number">0</span>}' http:<span class="comment">//x.x.x.x/api_jsonrpc.php</span></div><div class="line">#“item”:<span class="string">"24526"</span></div></pre></td></tr></table></figure>

<p>(4)获取监控项”system.cpu.util[,idle,avg1] “在2014.2.19 14:00~14:20的值</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -X POST -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'{"</span>jsonrpc<span class="string">": "</span><span class="number">2.0</span><span class="string">","</span>method<span class="string">":"</span><span class="transposed_variable">history.</span>get<span class="string">","</span>params<span class="string">":{"</span>history<span class="string">":0,"</span>itemids<span class="string">":["</span><span class="number">24526</span><span class="string">"],"</span>time_from<span class="string">":"</span><span class="number">1392789600</span><span class="string">","</span>time_till<span class="string">":"</span><span class="number">1392790200</span><span class="string">","</span>output<span class="string">":"</span>extend<span class="string">"},"</span>auth<span class="string">": "</span>a826fca79a0795ccc1224dc76329972f<span class="string">","</span>id<span class="string">": 0}'</span> http:<span class="comment">//x.x.x.x/api_jsonrpc.php</span></div></pre></td></tr></table></figure>

<h2 id="参考地址">参考地址</h2>
<p><a href="https://www.zabbix.com/documentation/2.4/manual/api" target="_blank" rel="external">https://www.zabbix.com/documentation/2.4/manual/api</a> </p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2016 <a href="/">hzchenkj</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="http://ajax.useso.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'hzchenkj' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>


</body>
</html>